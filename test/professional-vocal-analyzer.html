<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –í–æ–∫–∞–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä | Melodyne Pro</title>
    <!-- –ò–ú–ü–û–†–¢ –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–û–ô –ë–ò–ë–õ–ò–û–¢–ï–ö–ò PITCHY -->
    <script type="module">
        import { PitchDetector } from "https://esm.sh/pitchy@4";
        window.PitchDetector = PitchDetector;
        console.log('‚úÖ Pitchy –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 10px;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .file-input-label:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .play-button {
            background: #2196F3;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-button:hover {
            background: #1976D2;
            transform: scale(1.1);
        }

        /* –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö */
        .pro-settings {
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .setting-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .setting-group label {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .setting-group input, .setting-group select {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            padding: 4px 8px;
            color: white;
            text-align: center;
            width: 80px;
            font-size: 0.75rem;
        }

        /* –ê–ù–ê–õ–ò–ó–ê–¢–û–† –í–û–ö–ê–õ–¨–ù–´–• –¢–ï–•–ù–ò–ö */
        .vocal-techniques {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 10px;
            border-radius: 8px;
            min-width: 200px;
            font-size: 0.8rem;
            z-index: 1000;
        }

        .technique {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 3px 6px;
            border-radius: 4px;
        }

        .technique.detected {
            background: rgba(76, 175, 80, 0.3);
        }

        .technique.not-detected {
            background: rgba(100, 100, 100, 0.2);
        }

        /* –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø */
        .visualization-container {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        #professionalCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –û–¢–õ–ê–î–ö–ò */
        .pro-debug {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            padding: 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            min-width: 300px;
        }

        .debug-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .debug-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .debug-bar-fill {
            height: 100%;
            transition: all 0.2s ease;
        }

        .status {
            text-align: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        .status.ready {
            background: rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.3);
        }

        .status.analyzing {
            background: rgba(255, 193, 7, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1>üéµ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –í–æ–∫–∞–ª—å–Ω—ã–π –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Ö–Ω–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ -->
        <div class="audio-controls">
            <div class="file-input-wrapper">
                <input type="file" id="audioFile" accept="audio/*">
                <label for="audioFile" class="file-input-label">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–∫–∞–ª</label>
            </div>
            <button class="play-button" id="playButton">‚ñ∂Ô∏è</button>
            <div style="color: #ccc; font-family: monospace;">
                <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
            </div>
        </div>

        <!-- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="pro-settings">
            <div class="setting-group">
                <label>üìä –ê–º–ø–ª–∏—Ç—É–¥–∞</label>
                <input type="range" id="amplitudeThreshold" min="0.005" max="0.1" step="0.005" value="0.02">
                <span id="amplitudeValue">0.02</span>
            </div>
            <div class="setting-group">
                <label>üéØ –ß–µ—Ç–∫–æ—Å—Ç—å</label>
                <input type="range" id="clarityThreshold" min="0.5" max="0.95" step="0.05" value="0.8">
                <span id="clarityValue">0.80</span>
            </div>
            <div class="setting-group">
                <label>‚öñÔ∏è –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</label>
                <input type="range" id="stabilityThreshold" min="1" max="20" step="1" value="5">
                <span id="stabilityValue">5¬¢</span>
            </div>
            <div class="setting-group">
                <label>‚è±Ô∏è –ú–∏–Ω. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                <input type="number" id="minDuration" value="50" min="20" max="500" step="10">
            </div>
            <div class="setting-group">
                <label for="minFreq">üéµ –ú–∏–Ω. —á–∞—Å—Ç–æ—Ç–∞: <span id="minFreqValue">65</span> Hz</label>
                <input type="range" id="minFreq" min="40" max="200" value="65" step="5">
            </div>
            
            <div class="setting-group">
                <label for="maxFreq">üé∂ –ú–∞–∫—Å. —á–∞—Å—Ç–æ—Ç–∞: <span id="maxFreqValue">1050</span> Hz</label>
                <input type="range" id="maxFreq" min="300" max="2000" value="1050" step="50">
            </div>
            <div class="setting-group">
                <label>üßπ –ê–Ω—Ç–∏-—à—É–º</label>
                <input type="range" id="noiseFilter" min="50" max="500" step="50" value="200">
                <span id="noiseFilterValue">200–º—Å</span>
            </div>
            <div class="setting-group">
                <label>üéµ –ú–∏–Ω. —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å</label>
                <input type="range" id="minStability" min="50" max="95" step="5" value="70">
                <span id="minStabilityValue">70%</span>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è -->
        <div class="visualization-container">
            <canvas id="professionalCanvas"></canvas>
        </div>

        <!-- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="pro-debug">
            <h4 style="margin-bottom: 5px;">üî¨ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏</h4>
            <div class="debug-metric">
                <span>–ß–∞—Å—Ç–æ—Ç–∞:</span>
                <span id="freqValue">- Hz</span>
            </div>
            <div class="debug-metric">
                <span>–ù–æ—Ç–∞:</span>
                <span id="noteValue">-</span>
            </div>
            <div class="debug-metric">
                <span>–ê–º–ø–ª–∏—Ç—É–¥–∞:</span>
                <div class="debug-bar">
                    <div class="debug-bar-fill" id="amplitudeBar"></div>
                </div>
                <span id="amplitudePercent">-%</span>
            </div>
            <div class="debug-metric">
                <span>–ß–µ—Ç–∫–æ—Å—Ç—å:</span>
                <div class="debug-bar">
                    <div class="debug-bar-fill" id="clarityBar"></div>
                </div>
                <span id="clarityPercent">-%</span>
            </div>
            <div class="debug-metric">
                <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ—Ç:</span>
                <span id="activeNotesCount">0</span>
            </div>
            <div class="debug-metric">
                <span>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö:</span>
                <span id="completedNotesCount">0</span>
            </div>
            <div class="debug-metric">
                <span>–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:</span>
                <span id="filteredNotesCount">0</span>
            </div>
        </div>

        <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞</div>
    </div>

    <script>
        class ProfessionalVocalAnalyzer {
            constructor() {
                this.audio = null;
                this.audioContext = null;
                this.analyser = null;
                this.source = null;
                this.isPlaying = false;
                this.animationId = null;
                
                // –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê PITCHY
                this.pitchDetector = null;
                this.inputBuffer = null;
                this.bufferSize = 4096;
                
                // Canvas
                this.canvas = document.getElementById('professionalCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // UI —ç–ª–µ–º–µ–Ω—Ç—ã
                this.playButton = document.getElementById('playButton');
                this.statusDiv = document.getElementById('status');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                this.settings = {
                    amplitude: 0.02,
                    clarity: 0.80,
                    stability: 5,
                    minDuration: 50,
                    minFreq: 65,     // C2 - –Ω–∞—á–∏–Ω–∞–µ–º —Å –Ω–∏–∑–∫–æ–π –Ω–æ—Ç—ã
                    maxFreq: 1050,   // C6 - –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º –≤—ã—Å–æ–∫–æ–π –Ω–æ—Ç–æ–π (5 –æ–∫—Ç–∞–≤)
                    noiseFilter: 200,
                    minStability: 70,
                    transitionSensitivity: 15,
                    attackThreshold: 0.1,
                    noteGapThreshold: 100,
                    pitchStabilityWindow: 3,
                    adaptiveMode: true
                };
                
                // –°–ò–°–¢–ï–ú–ê –ù–û–¢ –° –£–õ–£–ß–®–ï–ù–ù–´–ú –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï–ú
                this.activeNotes = new Map();
                this.noteHistory = [];
                this.pitchHistory = [];
                this.filteredNotesCount = 0;
                
                // –ù–û–í–´–ï –°–ò–°–¢–ï–ú–´ –¢–û–ß–ù–û–°–¢–ò
                this.lastPitchData = null;
                this.transitionBuffer = [];
                this.adaptiveThresholds = {
                    amplitude: 0.02,
                    clarity: 0.8
                };
                
                // –ó–ê–ì–û–¢–û–í–ö–ê –î–õ–Ø –ò–ò-API
                this.aiService = {
                    enabled: false,
                    apiUrl: null,
                    analysisBuffer: [],
                    lastAnalysis: null
                };

                // üéπ –°–ò–°–¢–ï–ú–ê –í–ò–†–¢–£–ê–õ–¨–ù–û–ô –ö–õ–ê–í–ò–ê–¢–£–†–´
                this.piano = {
                    keyHeight: 100,      // –í—ã—Å–æ—Ç–∞ –∫–ª–∞–≤–∏—à
                    blackKeyHeight: 65,  // –í—ã—Å–æ—Ç–∞ —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à
                    startY: 0,           // –ë—É–¥–µ—Ç –≤—ã—á–∏—Å–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ (–≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞)
                    pressedKeys: new Map(),  // –ö–∞–∫–∏–µ –∫–ª–∞–≤–∏—à–∏ –Ω–∞–∂–∞—Ç—ã
                    keyFlashes: new Map(),   // –≠—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞–∂–∞—Ç–∏—è
                    noteParticles: []        // –ß–∞—Å—Ç–∏—Ü—ã –æ—Ç –Ω–æ—Ç
                };

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏—à–∏ –ø–∏–∞–Ω–∏–Ω–æ
                this.generatePianoKeys(this.canvas.width);
                
                this.init();
            }

            async init() {
                await this.waitForPitchy();
                this.setupEventListeners();
                this.setupCanvas();
                this.updateStatus('‚úÖ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞!', 'ready');
            }

            async waitForPitchy() {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.PitchDetector) {
                            console.log('‚úÖ Pitchy –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            }

            setupEventListeners() {
                // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
                document.getElementById('audioFile').addEventListener('change', (e) => {
                    this.loadAudioFile(e.target.files[0]);
                });

                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                this.playButton.addEventListener('click', () => {
                    this.togglePlayback();
                });

                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                document.getElementById('amplitudeThreshold').addEventListener('input', (e) => {
                    this.settings.minAmplitude = parseFloat(e.target.value);
                    document.getElementById('amplitudeValue').textContent = e.target.value;
                });

                document.getElementById('clarityThreshold').addEventListener('input', (e) => {
                    this.settings.minClarity = parseFloat(e.target.value);
                    document.getElementById('clarityValue').textContent = e.target.value;
                });

                document.getElementById('stabilityThreshold').addEventListener('input', (e) => {
                    this.settings.stabilityThreshold = parseInt(e.target.value);
                    document.getElementById('stabilityValue').textContent = e.target.value + '¬¢';
                });

                document.getElementById('minDuration').addEventListener('input', (e) => {
                    this.settings.minDuration = parseInt(e.target.value);
                });

                document.getElementById('minFreq').addEventListener('input', (e) => {
                    this.settings.minFreq = parseInt(e.target.value);
                    document.getElementById('minFreqValue').textContent = e.target.value;
                });

                document.getElementById('maxFreq').addEventListener('input', (e) => {
                    this.settings.maxFreq = parseInt(e.target.value);
                    document.getElementById('maxFreqValue').textContent = e.target.value;
                });

                // –ù–û–í–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ê–ù–¢–ò-–®–£–ú–ê
                document.getElementById('noiseFilter').addEventListener('input', (e) => {
                    this.settings.noiseFilter = parseInt(e.target.value);
                    document.getElementById('noiseFilterValue').textContent = e.target.value + '–º—Å';
                    console.log(`üßπ –ê–Ω—Ç–∏-—à—É–º: ${e.target.value}–º—Å`);
                });

                document.getElementById('minStability').addEventListener('input', (e) => {
                    this.settings.minStability = parseInt(e.target.value) / 100;
                    document.getElementById('minStabilityValue').textContent = e.target.value + '%';
                    console.log(`üéµ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å: ${e.target.value}%`);
                });
            }

            setupCanvas() {
                const resize = () => {
                    const rect = this.canvas.getBoundingClientRect();
                    this.canvas.width = rect.width * window.devicePixelRatio;
                    this.canvas.height = rect.height * window.devicePixelRatio;
                    this.ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                    
                    // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –†–ò–°–£–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° –°–†–ê–ó–£
                    this.drawProfessionalVisualization();
                };
                window.addEventListener('resize', resize);
                resize();
                
                // –ó–ê–ü–£–°–ö–ê–ï–ú –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Æ –°–†–ê–ó–£ (–¥–∞–∂–µ –±–µ–∑ –∞—É–¥–∏–æ)
                this.startVisualLoop();
            }

            async loadAudioFile(file) {
                if (!file) return;
                
                console.log(`üéµ –ó–∞–≥—Ä—É–∑–∫–∞: ${file.name}`);
                this.updateStatus('üîç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'analyzing');

                try {
                    this.audio = new Audio();
                    this.audio.src = URL.createObjectURL(file);
                    
                    await new Promise((resolve, reject) => {
                        this.audio.onloadedmetadata = resolve;
                        this.audio.onerror = reject;
                    });

                    // –°–æ–∑–¥–∞–µ–º AudioContext
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 44100,
                        latencyHint: 'interactive'
                    });
                    
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = this.bufferSize;
                    this.analyser.smoothingTimeConstant = 0.0;

                    this.source = this.audioContext.createMediaElementSource(this.audio);
                    this.source.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Pitchy
                    this.pitchDetector = window.PitchDetector.forFloat32Array(this.bufferSize);
                    this.inputBuffer = new Float32Array(this.bufferSize);

                    document.getElementById('totalTime').textContent = this.formatTime(this.audio.duration);
                    this.updateStatus(`‚úÖ –ì–æ—Ç–æ–≤: ${file.name}`, 'ready');

                    console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É –∞–Ω–∞–ª–∏–∑—É');

                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                    this.updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                }
            }

            togglePlayback() {
                if (!this.audio) return;

                if (this.isPlaying) {
                    this.audio.pause();
                    this.playButton.textContent = '‚ñ∂Ô∏è';
                    this.updateStatus('‚è∏Ô∏è –ü–∞—É–∑–∞', 'ready');
                } else {
                    this.audio.play();
                    this.playButton.textContent = '‚è∏Ô∏è';
                    this.updateStatus('üéµ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...', 'analyzing');
                    this.startAnalysis();
                }
                this.isPlaying = !this.isPlaying;
            }

            startAnalysis() {
                const analyze = () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è
                    if (this.audio) {
                        document.getElementById('currentTime').textContent = this.formatTime(this.audio.currentTime);
                    }

                    if (!this.analyser || !this.isPlaying) {
                        this.animationId = requestAnimationFrame(analyze);
                        return;
                    }

                    // –ü–æ–ª—É—á–∞–µ–º –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ
                    this.analyser.getFloatTimeDomainData(this.inputBuffer);
                    
                    // –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –î–ï–¢–ï–ö–¶–ò–Ø
                    const pitchData = this.detectPitchProfessional();
                    
                    if (pitchData) {
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ—Ç
                        this.processNotesProfessional(pitchData);
                        
                        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                        this.updateProfessionalUI(pitchData);
                    }

                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
                    this.drawProfessionalVisualization();

                    this.animationId = requestAnimationFrame(analyze);
                };

                analyze();
            }

            // –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–ê–Ø –î–ï–¢–ï–ö–¶–ò–Ø –° –£–õ–£–ß–®–ï–ù–ù–û–ô –¢–û–ß–ù–û–°–¢–¨–Æ
            detectPitchProfessional() {
                if (!this.pitchDetector) return null;

                try {
                    const [frequency, clarity] = this.pitchDetector.findPitch(this.inputBuffer, this.audioContext.sampleRate);
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º –∞–º–ø–ª–∏—Ç—É–¥—É —Å RMS
                    let rms = 0;
                    for (let i = 0; i < this.inputBuffer.length; i++) {
                        rms += this.inputBuffer[i] * this.inputBuffer[i];
                    }
                    rms = Math.sqrt(rms / this.inputBuffer.length);

                    // –ê–î–ê–ü–¢–ò–í–ù–´–ï –ü–û–†–û–ì–ò
                    if (this.settings.adaptiveMode) {
                        this.updateAdaptiveThresholds(rms, clarity);
                    }

                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —Å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏
                    const amplitudeThreshold = this.adaptiveThresholds.amplitude;
                    const clarityThreshold = this.adaptiveThresholds.clarity;

                    if (frequency > 0 && 
                        clarity >= clarityThreshold && 
                        rms >= amplitudeThreshold &&
                        frequency >= this.settings.minFreq &&
                        frequency <= this.settings.maxFreq) {
                        
                        const noteInfo = this.frequencyToNoteAccurate(frequency);
                        
                        const pitchData = {
                            frequency: frequency,
                            clarity: clarity,
                            amplitude: rms,
                            note: noteInfo.note,
                            octave: noteInfo.octave,
                            cents: noteInfo.cents,
                            timestamp: performance.now(),
                            confidence: clarity * Math.min(1, rms / 0.05)
                        };

                        // –î–ï–¢–ï–ö–¢ –ü–ï–†–ï–•–û–î–û–í –ò –ê–¢–ê–ö
                        const transitionDetected = this.detectTransition(pitchData);
                        const attackDetected = this.detectAttack(pitchData);
                        
                        if (transitionDetected || attackDetected) {
                            pitchData.isTransition = true;
                            console.log(`üîÑ –ü–µ—Ä–µ—Ö–æ–¥/–∞—Ç–∞–∫–∞: ${noteInfo.note}${noteInfo.octave} (${frequency.toFixed(1)}Hz)`);
                        }

                        this.pitchHistory.push(pitchData);
                        if (this.pitchHistory.length > 100) {
                            this.pitchHistory.shift();
                        }

                        this.lastPitchData = pitchData;
                        console.log(`üéµ ${noteInfo.note}${noteInfo.octave} (${frequency.toFixed(1)}Hz) –ß–µ—Ç–∫–æ—Å—Ç—å: ${(clarity*100).toFixed(0)}%`);
                        
                        return pitchData;
                    }
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ Pitchy:', error);
                }

                return null;
            }

            // –¢–û–ß–ù–ê–Ø –ö–ê–õ–ò–ë–†–û–í–ö–ê –ß–ê–°–¢–û–¢–ê ‚Üí –ù–û–¢–ê
            frequencyToNoteAccurate(frequency) {
                // –ë–∞–∑–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ A4 = 440 Hz (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)
                const A4 = 440.0;
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—Ç–æ–Ω–æ–≤ –æ—Ç A4
                const semitonesFromA4 = 12 * Math.log2(frequency / A4);
                
                // –ù–æ–º–µ—Ä MIDI –Ω–æ—Ç—ã (A4 = 69)
                const midiNumber = 69 + semitonesFromA4;
                const roundedMidiNumber = Math.round(midiNumber);
                
                // –û–∫—Ç–∞–≤–∞ –∏ –∏–Ω–¥–µ–∫—Å –Ω–æ—Ç—ã
                const octave = Math.floor(roundedMidiNumber / 12) - 1;
                const noteIndex = roundedMidiNumber % 12;
                
                // –ú–∞—Å—Å–∏–≤ –Ω–æ—Ç (C = 0)
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç–∞—Ö –æ—Ç –∏–¥–µ–∞–ª—å–Ω–æ–π –Ω–æ—Ç—ã
                const cents = Math.round((midiNumber - roundedMidiNumber) * 100);
                
                // –¢–æ—á–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ –∏–¥–µ–∞–ª—å–Ω–æ–π –Ω–æ—Ç—ã –¥–ª—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏
                const idealFrequency = A4 * Math.pow(2, (roundedMidiNumber - 69) / 12);
                
                return {
                    note: notes[noteIndex] || 'X',
                    octave: octave,
                    cents: cents,
                    midiNumber: roundedMidiNumber,
                    idealFrequency: idealFrequency,
                    deviation: frequency - idealFrequency
                };
            }

            // –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê –ü–û–†–û–ì–û–í
            updateAdaptiveThresholds(rms, clarity) {
                const alpha = 0.1; // –°–∫–æ—Ä–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
                
                // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º –∞–º–ø–ª–∏—Ç—É–¥—É
                if (rms > this.adaptiveThresholds.amplitude) {
                    this.adaptiveThresholds.amplitude = this.adaptiveThresholds.amplitude * (1 - alpha) + (rms * 0.7) * alpha;
                }
                
                // –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º —á–µ—Ç–∫–æ—Å—Ç—å
                if (clarity > this.adaptiveThresholds.clarity) {
                    this.adaptiveThresholds.clarity = this.adaptiveThresholds.clarity * (1 - alpha) + (clarity * 0.9) * alpha;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                this.adaptiveThresholds.amplitude = Math.max(0.005, Math.min(0.05, this.adaptiveThresholds.amplitude));
                this.adaptiveThresholds.clarity = Math.max(0.6, Math.min(0.95, this.adaptiveThresholds.clarity));
            }

            // –î–ï–¢–ï–ö–¢ –ü–ï–†–ï–•–û–î–û–í –ú–ï–ñ–î–£ –ù–û–¢–ê–ú–ò
            detectTransition(currentPitch) {
                if (!this.lastPitchData) return false;
                
                const currentNote = this.frequencyToNoteAccurate(currentPitch.frequency);
                const lastNote = this.frequencyToNoteAccurate(this.lastPitchData.frequency);
                
                // –†–∞–∑–Ω–∏—Ü–∞ –≤ —Ü–µ–Ω—Ç–∞—Ö
                const centsDiff = Math.abs(currentNote.midiNumber - lastNote.midiNumber) * 100;
                
                return centsDiff > this.settings.transitionSensitivity;
            }

            // –î–ï–¢–ï–ö–¢ –ê–¢–ê–ö (–†–ï–ó–ö–ò–• –ò–ó–ú–ï–ù–ï–ù–ò–ô –ê–ú–ü–õ–ò–¢–£–î–´)
            detectAttack(currentPitch) {
                if (!this.lastPitchData) return false;
                
                const amplitudeRatio = currentPitch.amplitude / this.lastPitchData.amplitude;
                
                // –î–µ—Ç–µ–∫—Ç–∏–º —Ä–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∞–º–ø–ª–∏—Ç—É–¥—ã (–∞—Ç–∞–∫–∞)
                return amplitudeRatio > (1 + this.settings.attackThreshold);
            }

            // –£–ú–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ù–û–¢ –° –†–ê–ó–î–ï–õ–ï–ù–ò–ï–ú
            processNotesProfessional(pitchData) {
                const noteKey = `${pitchData.note}${pitchData.octave}`;
                const currentTime = pitchData.timestamp;
                
                let activeNote = this.activeNotes.get(noteKey);
                
                if (activeNote) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–æ—Ç—É
                    const shouldSeparate = this.shouldSeparateNote(activeNote, pitchData, currentTime);
                    
                    if (shouldSeparate) {
                        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â—É—é –Ω–æ—Ç—É
                        activeNote.endTime = currentTime;
                        activeNote.duration = activeNote.endTime - activeNote.startTime;
                        activeNote.ended = true;
                        
                        const isValidNote = this.validateNoteQuality(activeNote);
                        if (isValidNote) {
                            this.noteHistory.push(activeNote);
                            console.log(`‚úÇÔ∏è –†–∞–∑–¥–µ–ª–µ–Ω–∞ –Ω–æ—Ç–∞ ${noteKey}: ${activeNote.duration.toFixed(0)}–º—Å`);
                        } else {
                            this.filteredNotesCount++;
                            console.log(`üßπ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω–∞—è –Ω–æ—Ç–∞ ${noteKey}: ${activeNote.duration.toFixed(0)}–º—Å`);
                        }
                        
                        this.activeNotes.delete(noteKey);
                        
                        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –Ω–æ—Ç—É
                        this.createNewNote(noteKey, pitchData, currentTime);
                        
                        // üéπ –û–¢–ü–£–°–ö–ê–ï–ú –°–¢–ê–†–£–Æ –ò –ù–ê–ñ–ò–ú–ê–ï–ú –ù–û–í–£–Æ –ö–õ–ê–í–ò–®–£
                        this.releaseKey(activeNote);
                        this.pressKey(pitchData);
                        
                    } else {
                        // –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –Ω–æ—Ç—É
                        activeNote.endTime = currentTime;
                        activeNote.duration = activeNote.endTime - activeNote.startTime;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —á–∞—Å—Ç–æ—Ç—É (—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ)
                        const alpha = 0.3;
                        activeNote.frequency = activeNote.frequency * (1 - alpha) + pitchData.frequency * alpha;
                    }
                    
                } else {
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –Ω–æ—Ç—É
                    this.createNewNote(noteKey, pitchData, currentTime);
                    
                    // üéπ –ù–ê–ñ–ò–ú–ê–ï–ú –ö–õ–ê–í–ò–®–£ –ù–ê –ü–ò–ê–ù–ò–ù–û!
                    this.pressKey(pitchData);
                }
                
                // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –Ω–æ—Ç
                this.cleanupInactiveNotes(currentTime);
            }

            // –ü–†–û–í–ï–†–ö–ê –ù–ï–û–ë–•–û–î–ò–ú–û–°–¢–ò –†–ê–ó–î–ï–õ–ï–ù–ò–Ø –ù–û–¢–´
            shouldSeparateNote(activeNote, pitchData, currentTime) {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø—Ä–æ–ø—É—Å–∫
                const timeSinceLastUpdate = currentTime - activeNote.endTime;
                if (timeSinceLastUpdate > this.settings.noteGapThreshold) {
                    return true;
                }
                
                // 2. –î–µ—Ç–µ–∫—Ç –∞—Ç–∞–∫–∏/–ø–µ—Ä–µ—Ö–æ–¥–∞
                if (pitchData.isTransition) {
                    return true;
                }
                
                // 3. –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã
                const frequencyDiff = Math.abs(pitchData.frequency - activeNote.frequency);
                const semitonesDiff = 12 * Math.log2(pitchData.frequency / activeNote.frequency);
                if (Math.abs(semitonesDiff) > 0.5) { // –ë–æ–ª—å—à–µ —á–µ—Ç–≤–µ—Ä—Ç–∏ —Ç–æ–Ω–∞
                    return true;
                }
                
                // 4. –†–µ–∑–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞–º–ø–ª–∏—Ç—É–¥—ã (–Ω–æ–≤–∞—è –∞—Ç–∞–∫–∞)
                if (this.lastPitchData) {
                    const amplitudeJump = pitchData.amplitude / this.lastPitchData.amplitude;
                    if (amplitudeJump > 2.0) { // –ê–º–ø–ª–∏—Ç—É–¥–∞ —É–≤–µ–ª–∏—á–∏–ª–∞—Å—å –≤ 2 —Ä–∞–∑–∞
                        return true;
                    }
                }
                
                return false;
            }

            // –°–û–ó–î–ê–ù–ò–ï –ù–û–í–û–ô –ù–û–¢–´
            createNewNote(noteKey, pitchData, currentTime) {
                const newNote = {
                    note: pitchData.note,
                    octave: pitchData.octave,
                    frequency: pitchData.frequency,
                    startTime: currentTime,
                    endTime: currentTime,
                    duration: 0,
                    confidence: pitchData.confidence,
                    color: this.getNoteColor(pitchData.note),
                    ended: false,
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ò–ò
                    midiNumber: pitchData.midiNumber || 0,
                    cents: pitchData.cents || 0,
                    isTransition: pitchData.isTransition || false
                };
                
                this.activeNotes.set(noteKey, newNote);
                console.log(`üÜï –ù–æ–≤–∞—è –Ω–æ—Ç–∞: ${noteKey}`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä –¥–ª—è –ò–ò-–∞–Ω–∞–ª–∏–∑–∞
                this.addToAIBuffer(newNote);
            }

            // –ó–ê–ì–û–¢–û–í–ö–ê –î–õ–Ø –ò–ò-–ê–ù–ê–õ–ò–ó–ê
            addToAIBuffer(noteData) {
                if (!this.aiService.enabled) return;
                
                this.aiService.analysisBuffer.push({
                    note: noteData.note,
                    octave: noteData.octave,
                    frequency: noteData.frequency,
                    timestamp: noteData.startTime,
                    confidence: noteData.confidence,
                    midiNumber: noteData.midiNumber,
                    cents: noteData.cents,
                    isTransition: noteData.isTransition
                });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞
                if (this.aiService.analysisBuffer.length > 50) {
                    this.aiService.analysisBuffer.shift();
                }
                
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –≤ API –∫–∞–∂–¥—ã–µ N –Ω–æ—Ç
                if (this.aiService.analysisBuffer.length % 10 === 0) {
                    this.sendToAIAnalysis();
                }
            }

            // –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –í –ò–ò (–ó–ê–ì–û–¢–û–í–ö–ê)
            async sendToAIAnalysis() {
                if (!this.aiService.enabled || !this.aiService.apiUrl) return;
                
                try {
                    const response = await fetch(this.aiService.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            notes: this.aiService.analysisBuffer,
                            settings: this.settings,
                            timestamp: Date.now()
                        })
                    });
                    
                    const result = await response.json();
                    this.aiService.lastAnalysis = result;
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–ò
                    if (result.recommendations) {
                        this.applyAIRecommendations(result.recommendations);
                    }
                    
                    console.log('ü§ñ –ò–ò-–∞–Ω–∞–ª–∏–∑ –ø–æ–ª—É—á–µ–Ω:', result);
                    
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ò–ò-API:', error);
                }
            }

            // –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô –ò–ò (–ó–ê–ì–û–¢–û–í–ö–ê)
            applyAIRecommendations(recommendations) {
                if (recommendations.adjustAmplitude) {
                    this.settings.minAmplitude = recommendations.adjustAmplitude;
                }
                if (recommendations.adjustClarity) {
                    this.settings.minClarity = recommendations.adjustClarity;
                }
                if (recommendations.adjustTransitionSensitivity) {
                    this.settings.transitionSensitivity = recommendations.adjustTransitionSensitivity;
                }
                
                console.log('ü§ñ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ò–ò:', recommendations);
            }

            // üéØ –û–°–ù–û–í–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê (–ö–õ–ê–í–ò–ê–¢–£–†–ê –í–ù–ò–ó–£ + PIANO ROLL –°–í–ï–†–•–£)
            drawProfessionalVisualization() {
                const canvas = document.getElementById('professionalCanvas');
                if (!canvas) return;
                
                const rect = canvas.getBoundingClientRect();
                const width = rect.width;
                const height = rect.height;
                
                // –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω
                this.ctx.clearRect(0, 0, width, height);
                
                // –§–æ–Ω
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, width, height);
                
                // –û–±–ª–∞—Å—Ç—å –¥–ª—è Piano Roll (—Å–≤–µ—Ä—Ö—É) –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–≤–Ω–∏–∑—É)
                const pianoHeight = 120; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                const rollHeight = height - pianoHeight;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
                this.piano.startY = rollHeight;
                this.piano.keyHeight = 100;
                this.piano.blackKeyHeight = 65;
                
                // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏—à–∏ –µ—Å–ª–∏ —Ä–∞–∑–º–µ—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è
                if (!this.piano.keys.length || this.piano.lastWidth !== width) {
                    this.generatePianoKeys(width);
                    this.piano.lastWidth = width;
                }
                
                // –†–∏—Å—É–µ–º Piano Roll —Å–≤–µ—Ä—Ö—É
                this.drawPianoRoll(0, 0, width, rollHeight);
                
                // –†–∏—Å—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≤–Ω–∏–∑—É
                this.drawVirtualPianoBottom(width, height);
                
                // –†–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ—Ç—ã –ª–µ—Ç—è—â–∏–µ –≤–≤–µ—Ä—Ö –æ—Ç –∫–ª–∞–≤–∏—à
                this.drawActiveNotesFromKeysBottom(width, rollHeight, height);
                
                // –†–∏—Å—É–µ–º Playhead —Ç–æ–ª—å–∫–æ –≤ –æ–±–ª–∞—Å—Ç–∏ Piano Roll
                this.drawPlayheadRoll(width, rollHeight);
            }

            drawPianoRoll(startX, startY, width, height) {
                // –§–æ–Ω Piano Roll
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(startX, startY, width, height);
                
                // –¢–û–ß–ù–ê–Ø –ö–ê–õ–ò–ë–†–û–í–ö–ê –ù–û–¢–ù–û–ì–û –°–¢–ê–ù–ê (–ú–ï–ñ–î–£–ù–ê–†–û–î–ù–´–ô –°–¢–ê–ù–î–ê–†–¢)
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                
                // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–æ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏
                const notesList = [];
                const A4_FREQ = 440.0; // –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ—Ç—ã –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ —Å —Ç–æ—á–Ω—ã–º–∏ —á–∞—Å—Ç–æ—Ç–∞–º–∏
                for (let midiNumber = 21; midiNumber <= 108; midiNumber++) { // Piano range: A0 to C8
                    const frequency = A4_FREQ * Math.pow(2, (midiNumber - 69) / 12);
                    
                    if (frequency >= this.settings.minFreq && frequency <= this.settings.maxFreq) {
                        const octave = Math.floor(midiNumber / 12) - 1;
                        const noteIndex = midiNumber % 12;
                        
                        notesList.push({
                            note: notes[noteIndex],
                            octave: octave,
                            frequency: frequency,
                            midiNumber: midiNumber,
                            isWhite: whiteKeys.includes(notes[noteIndex])
                        });
                    }
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                notesList.sort((a, b) => a.frequency - b.frequency);
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–æ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ, —Ä–∏—Å—É–µ–º –±–∞–∑–æ–≤—É—é —Ä–∞–∑–º–µ—Ç–∫—É
                if (notesList.length === 0) {
                    this.ctx.strokeStyle = 'rgba(100, 100, 100, 0.5)';
                    this.ctx.lineWidth = 1;
                    for (let i = 0; i < 10; i++) {
                        const y = startY + (height * i / 10);
                        this.ctx.beginPath();
                        this.ctx.moveTo(startX, y);
                        this.ctx.lineTo(startX + width, y);
                        this.ctx.stroke();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    this.ctx.font = '14px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(`–î–∏–∞–ø–∞–∑–æ–Ω: ${this.settings.minFreq}-${this.settings.maxFreq} Hz`, 
                                    startX + width/2, startY + height/2);
                    return;
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º –ª–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const minLogFreq = Math.log(this.settings.minFreq);
                const maxLogFreq = Math.log(this.settings.maxFreq);
                const logRange = maxLogFreq - minLogFreq;
                
                // –†–∏—Å—É–µ–º –ª–∏–Ω–∏–∏ –Ω–æ—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
                notesList.forEach((noteInfo) => {
                    // –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const logFreq = Math.log(noteInfo.frequency);
                    const normalizedPosition = (logFreq - minLogFreq) / logRange;
                    const y = startY + height - (normalizedPosition * height);
                    
                    // –§–æ–Ω –∫–ª–∞–≤–∏—à —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å—é
                    if (noteInfo.isWhite) {
                        this.ctx.fillStyle = 'rgba(70, 70, 70, 0.4)';
                    } else {
                        this.ctx.fillStyle = 'rgba(40, 40, 40, 0.6)';
                    }
                    
                    const noteHeight = Math.max(8, height / notesList.length);
                    this.ctx.fillRect(startX, y - noteHeight/2, width, noteHeight);
                    
                    // –õ–∏–Ω–∏–∏ —Å —á–µ—Ç–∫–æ–π –≥—Ä–∞–¥–∞—Ü–∏–µ–π
                    this.ctx.strokeStyle = noteInfo.isWhite ? 'rgba(100, 100, 100, 0.9)' : 'rgba(60, 60, 60, 0.7)';
                    this.ctx.lineWidth = noteInfo.isWhite ? 1.5 : 0.8;
                    this.ctx.beginPath();
                    this.ctx.moveTo(startX, y);
                    this.ctx.lineTo(startX + width, y);
                    this.ctx.stroke();
                    
                    // –ù–∞–∑–≤–∞–Ω–∏—è –Ω–æ—Ç —Å–ª–µ–≤–∞
                    if (noteInfo.isWhite) {
                        this.ctx.textAlign = 'left';
                        this.ctx.font = '10px monospace';
                        this.ctx.fillStyle = 'rgba(200, 200, 200, 0.8)';
                        this.ctx.fillText(`${noteInfo.note}${noteInfo.octave}`, startX + 5, y + 4);
                    }
                    
                    // –¢–æ—á–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã —Å–ø—Ä–∞–≤–∞
                    this.ctx.textAlign = 'right';
                    this.ctx.font = '10px monospace';
                    this.ctx.fillStyle = noteInfo.isWhite ? 'rgba(200, 200, 200, 0.8)' : 'rgba(160, 160, 160, 0.7)';
                    this.ctx.fillText(`${noteInfo.frequency.toFixed(1)}Hz`, startX + width - 5, y + 4);
                });
            }

            drawActiveNotesFromKeysBottom(width, rollHeight, totalHeight) {
                const currentTime = performance.now();
                const timeWindow = 8000; // 8 —Å–µ–∫—É–Ω–¥
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –Ω–æ—Ç—ã
                const allNotes = [...this.activeNotes.values(), ...this.noteHistory.slice(-20)];
                
                allNotes.forEach(note => {
                    const age = currentTime - note.startTime;
                    if (age > timeWindow) return;
                    
                    // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–ª–∞–≤–∏—à—É –Ω–∞ –ø–∏–∞–Ω–∏–Ω–æ
                    const pianoKey = this.findKeyByNote(note.note, note.octave);
                    if (!pianoKey) return;
                    
                    // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è - –æ—Ç –∫–ª–∞–≤–∏—à–∏ –ø–∏–∞–Ω–∏–Ω–æ (–≤–Ω–∏–∑—É)
                    const startKeyX = pianoKey.x + pianoKey.width/2;
                    const startKeyY = pianoKey.y; // –í–µ—Ä—Ö –∫–ª–∞–≤–∏—à–∏
                    
                    // –ü–æ–∑–∏—Ü–∏—è –Ω–æ—Ç—ã –Ω–∞ timeline (–¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
                    const noteX = width - (age / timeWindow) * width;
                    const blockWidth = Math.max(8, (note.duration / timeWindow) * width);
                    
                    // Y –ø–æ–∑–∏—Ü–∏—è –≤ Piano Roll (—Å–≤–µ—Ä—Ö—É) –Ω–∞ –æ—Å–Ω–æ–≤–µ —á–∞—Å—Ç–æ—Ç—ã
                    const logFreq = Math.log(note.frequency);
                    const minLogFreq = Math.log(this.settings.minFreq);
                    const maxLogFreq = Math.log(this.settings.maxFreq);
                    const logRange = maxLogFreq - minLogFreq;
                    const normalizedPosition = (logFreq - minLogFreq) / logRange;
                    const noteY = rollHeight - (normalizedPosition * rollHeight); // –í –æ–±–ª–∞—Å—Ç–∏ Piano Roll
                    
                    const blockHeight = Math.max(15, rollHeight / 50);
                    
                    // –¶–≤–µ—Ç –Ω–æ—Ç—ã
                    let color = this.getNoteColor(note.note);
                    const isActive = !note.ended;
                    const alpha = isActive ? 0.9 : 0.6;
                    
                    // üåü –†–ò–°–£–ï–ú –¢–†–ê–ï–ö–¢–û–†–ò–Æ –û–¢ –ö–õ–ê–í–ò–®–ò –°–ù–ò–ó–£ –í–í–ï–†–• (–µ—Å–ª–∏ –Ω–æ—Ç–∞ –º–æ–ª–æ–¥–∞—è)
                    if (age < 1000) { // –ü–µ—Ä–≤–∞—è —Å–µ–∫—É–Ω–¥–∞
                        const trajectoryAlpha = Math.max(0, (1000 - age) / 1000) * 0.4;
                        this.ctx.strokeStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${trajectoryAlpha})`;
                        this.ctx.lineWidth = 3;
                        this.ctx.setLineDash([8, 8]);
                        this.ctx.beginPath();
                        this.ctx.moveTo(startKeyX, startKeyY);
                        this.ctx.lineTo(noteX + blockWidth/2, noteY);
                        this.ctx.stroke();
                        this.ctx.setLineDash([]);
                    }
                    
                    // –†–∏—Å—É–µ–º –Ω–æ—Ç—É –≤ Piano Roll
                    this.ctx.fillStyle = `rgba(${color.r}, ${color.g}, ${color.b}, ${alpha})`;
                    this.ctx.fillRect(noteX, noteY - blockHeight/2, blockWidth, blockHeight);
                    
                    // –û–±–≤–æ–¥–∫–∞
                    this.ctx.strokeStyle = `rgba(${color.r + 50}, ${color.g + 50}, ${color.b + 50}, 1)`;
                    this.ctx.lineWidth = isActive ? 2 : 1;
                    this.ctx.strokeRect(noteX, noteY - blockHeight/2, blockWidth, blockHeight);
                    
                    // –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ—Ç—ã
                    if (blockWidth > 20) {
                        this.ctx.fillStyle = '#ffffff';
                        this.ctx.font = isActive ? 'bold 12px Arial' : '10px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(`${note.note}${note.octave}`, noteX + blockWidth/2, noteY + 3);
                    }
                });
            }

            drawPlayheadRoll(startX, width) {
                // –ö—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è –ø–ª–µ–π—Ö–µ–¥–∞ (–≤ –æ–±–ª–∞—Å—Ç–∏ Piano Roll)
                this.ctx.strokeStyle = '#FF4444';
                this.ctx.lineWidth = 3;
                this.ctx.beginPath();
                this.ctx.moveTo(startX, 0);
                this.ctx.lineTo(startX, width);
                this.ctx.stroke();
            }

            // –¶–í–ï–¢–ê –î–õ–Ø –¢–ï–•–ù–ò–ö
            getNoteColor(note) {
                // –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ –Ω–æ—Ç
                const colors = {
                    'C': { r: 255, g: 100, b: 100 },
                    'C#': { r: 255, g: 150, b: 100 },
                    'D': { r: 255, g: 200, b: 100 },
                    'D#': { r: 255, g: 255, b: 100 },
                    'E': { r: 200, g: 255, b: 100 },
                    'F': { r: 100, g: 255, b: 100 },
                    'F#': { r: 100, g: 255, b: 200 },
                    'G': { r: 100, g: 200, b: 255 },
                    'G#': { r: 100, g: 150, b: 255 },
                    'A': { r: 150, g: 100, b: 255 },
                    'A#': { r: 200, g: 100, b: 255 },
                    'B': { r: 255, g: 100, b: 200 }
                };
                return colors[note] || { r: 150, g: 150, b: 150 };
            }

            // –û–ë–ù–û–í–õ–ï–ù–ò–ï UI
            updateProfessionalUI(pitchData) {
                // –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
                document.getElementById('freqValue').textContent = pitchData.frequency.toFixed(1) + ' Hz';
                document.getElementById('noteValue').textContent = `${pitchData.note}${pitchData.octave} (${pitchData.cents > 0 ? '+' : ''}${pitchData.cents}¬¢)`;
                
                // –ü–æ–ª–æ—Å–∫–∏
                const amplitudePercent = Math.min(100, (pitchData.amplitude / 0.1) * 100);
                const clarityPercent = pitchData.clarity * 100;
                
                document.getElementById('amplitudeBar').style.width = amplitudePercent + '%';
                document.getElementById('amplitudeBar').style.backgroundColor = pitchData.amplitude > this.settings.minAmplitude ? '#4CAF50' : '#FF6B6B';
                document.getElementById('amplitudePercent').textContent = amplitudePercent.toFixed(0) + '%';
                
                document.getElementById('clarityBar').style.width = clarityPercent + '%';
                document.getElementById('clarityBar').style.backgroundColor = pitchData.clarity > this.settings.minClarity ? '#4CAF50' : '#FF6B6B';
                document.getElementById('clarityPercent').textContent = clarityPercent.toFixed(0) + '%';
                
                document.getElementById('activeNotesCount').textContent = this.activeNotes.size;
                document.getElementById('completedNotesCount').textContent = this.noteHistory.length;
                document.getElementById('filteredNotesCount').textContent = this.filteredNotesCount;
            }

            // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
            frequencyToNote(frequency) {
                const A4 = 440;
                const semitones = 12 * Math.log2(frequency / A4);
                const noteNumber = Math.round(semitones) + 69;
                const octave = Math.floor(noteNumber / 12) - 1;
                const noteIndex = noteNumber % 12;
                const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                const exactSemitones = 12 * Math.log2(frequency / A4) + 69;
                const targetNoteNumber = Math.round(exactSemitones);
                const cents = Math.round((exactSemitones - targetNoteNumber) * 100);
                
                return {
                    note: notes[noteIndex] || '-',
                    octave: octave,
                    cents: cents
                };
            }

            formatTime(seconds) {
                if (isNaN(seconds)) return '00:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            updateStatus(message, type = '') {
                this.statusDiv.textContent = message;
                this.statusDiv.className = `status ${type}`;
            }

            // –û–ß–ò–°–¢–ö–ê –ù–ï–ê–ö–¢–ò–í–ù–´–• –ù–û–¢
            cleanupInactiveNotes(currentTime) {
                for (let [key, note] of this.activeNotes) {
                    if (currentTime - note.endTime > 200 && !note.ended) {
                        note.ended = true;
                        
                        // –°–¢–†–û–ì–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ü–†–û–¢–ò–í –®–£–ú–ê
                        const isValidNote = this.validateNoteQuality(note);
                        
                        if (isValidNote) {
                            this.noteHistory.push(note);
                            console.log(`‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ –Ω–æ—Ç–∞ ${key}: ${note.duration.toFixed(0)}–º—Å, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${(note.confidence*100).toFixed(0)}%`);
                        } else {
                            this.filteredNotesCount++;
                            console.log(`üßπ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞ –Ω–æ—Ç–∞ ${key}: ${note.duration.toFixed(0)}–º—Å (—à—É–º)`);
                        }
                        
                        // üéπ –û–¢–ü–£–°–ö–ê–ï–ú –ö–õ–ê–í–ò–®–£ –ü–†–ò –ó–ê–í–ï–†–®–ï–ù–ò–ò –ù–û–¢–´
                        this.releaseKey(note);
                        
                        this.activeNotes.delete(key);
                    }
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                if (this.noteHistory.length > 30) {
                    this.noteHistory = this.noteHistory.slice(-30);
                }
            }

            // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –ö–ê–ß–ï–°–¢–í–ê –ù–û–¢–´
            validateNoteQuality(note) {
                // 1. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–Ω—Ç–∏-—à—É–º–∞
                if (note.duration < this.settings.noiseFilter) {
                    return false;
                }
                
                // 2. –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
                if (note.confidence < this.settings.minStability) {
                    return false;
                }
                
                // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —á–∞—Å—Ç–æ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
                if (this.pitchHistory.length > 5) {
                    const recentPitches = this.pitchHistory.slice(-this.settings.stabilityWindow);
                    const noteFrequencies = recentPitches.filter(p => 
                        Math.abs(p.frequency - note.frequency) < 20
                    );
                    
                    // –ï—Å–ª–∏ –º–µ–Ω–µ–µ 60% –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø–∏—Ç—á–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —ç—Ç–æ–π –Ω–æ—Ç–µ - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º
                    if (noteFrequencies.length / recentPitches.length < 0.6) {
                        return false;
                    }
                }
                
                // 4. –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –∏—Å–∫–ª—é—á–∞–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
                if (note.isTransition && note.duration < 100) {
                    return false;
                }
                
                return true;
            }

            // üéπ –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–õ–ê–í–ò–® –ü–ò–ê–ù–ò–ù–û –ù–ê –í–°–Æ –®–ò–†–ò–ù–£ (5 –û–ö–¢–ê–í)
            generatePianoKeys(canvasWidth) {
                const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
                const blackNotes = ['C#', 'D#', null, 'F#', 'G#', 'A#', null]; // null –≥–¥–µ –Ω–µ—Ç —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à
                
                this.piano.keys = [];
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –Ω–æ—Ç—ã –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ —á–∞—Å—Ç–æ—Ç (5 –æ–∫—Ç–∞–≤)
                const allNotes = [];
                for (let octave = 1; octave <= 8; octave++) { // –†–∞—Å—à–∏—Ä–∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω
                    for (let i = 0; i < whiteNotes.length; i++) {
                        const note = whiteNotes[i];
                        const frequency = this.noteToFrequency(note, octave);
                        
                        if (frequency >= this.settings.minFreq && frequency <= this.settings.maxFreq) {
                            allNotes.push({
                                note: note,
                                octave: octave,
                                frequency: frequency,
                                isBlack: false,
                                midiNumber: this.noteToMidi(note, octave)
                            });
                        }
                        
                        // –ß–µ—Ä–Ω–∞—è –∫–ª–∞–≤–∏—à–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                        if (blackNotes[i] && octave <= 8) {
                            const blackNote = blackNotes[i];
                            const blackFreq = this.noteToFrequency(blackNote, octave);
                            
                            if (blackFreq >= this.settings.minFreq && blackFreq <= this.settings.maxFreq) {
                                allNotes.push({
                                    note: blackNote,
                                    octave: octave,
                                    frequency: blackFreq,
                                    isBlack: true,
                                    midiNumber: this.noteToMidi(blackNote, octave)
                                });
                            }
                        }
                    }
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
                allNotes.sort((a, b) => a.frequency - b.frequency);
                
                // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —à–∏—Ä–∏–Ω—ã
                const whiteKeysCount = allNotes.filter(n => !n.isBlack).length;
                
                if (whiteKeysCount === 0) {
                    console.warn('üéπ –ù–µ—Ç –Ω–æ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ!');
                    return;
                }
                
                // –í—ã—á–∏—Å–ª—è–µ–º —à–∏—Ä–∏–Ω—É –±–µ–ª—ã—Ö –∫–ª–∞–≤–∏—à —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                const totalWidth = canvasWidth || 1200;
                const whiteKeyWidth = totalWidth / whiteKeysCount;
                const blackKeyWidth = whiteKeyWidth * 0.6; // –ß–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ —É–∂–µ –±–µ–ª—ã—Ö
                
                this.piano.keyWidth = whiteKeyWidth;
                this.piano.blackKeyWidth = blackKeyWidth;
                
                // –†–∞–∑–º–µ—â–∞–µ–º –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏
                let whiteKeyIndex = 0;
                allNotes.forEach(noteInfo => {
                    if (!noteInfo.isBlack) {
                        this.piano.keys.push({
                            ...noteInfo,
                            x: whiteKeyIndex * whiteKeyWidth,
                            y: this.piano.startY,
                            width: whiteKeyWidth,
                            height: this.piano.keyHeight
                        });
                        whiteKeyIndex++;
                    }
                });
                
                // –†–∞–∑–º–µ—â–∞–µ–º —á–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –º–µ–∂–¥—É –±–µ–ª—ã–º–∏
                allNotes.forEach(noteInfo => {
                    if (noteInfo.isBlack) {
                        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –±–µ–ª—É—é –∫–ª–∞–≤–∏—à—É —Å–ª–µ–≤–∞
                        const leftWhiteKey = this.piano.keys.find(k => 
                            !k.isBlack && k.midiNumber === noteInfo.midiNumber - 1
                        );
                        
                        if (leftWhiteKey) {
                            this.piano.keys.push({
                                ...noteInfo,
                                x: leftWhiteKey.x + leftWhiteKey.width - blackKeyWidth/2,
                                y: this.piano.startY,
                                width: blackKeyWidth,
                                height: this.piano.blackKeyHeight
                            });
                        }
                    }
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –±–µ–ª—ã–µ, –ø–æ—Ç–æ–º —á–µ—Ä–Ω—ã–µ (–¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
                this.piano.keys.sort((a, b) => {
                    if (a.isBlack !== b.isBlack) {
                        return a.isBlack ? 1 : -1;
                    }
                    return a.x - b.x;
                });
                
                console.log(`üéπ –°–æ–∑–¥–∞–Ω–æ ${this.piano.keys.length} –∫–ª–∞–≤–∏—à (${whiteKeysCount} –±–µ–ª—ã—Ö) –Ω–∞ —à–∏—Ä–∏–Ω—É ${totalWidth}px`);
                console.log(`üéº –î–∏–∞–ø–∞–∑–æ–Ω: ${allNotes[0]?.note}${allNotes[0]?.octave} - ${allNotes[allNotes.length-1]?.note}${allNotes[allNotes.length-1]?.octave}`);
            }

            // üéµ –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ù–û–¢–ê ‚Üí –ß–ê–°–¢–û–¢–ê
            noteToFrequency(note, octave) {
                const noteToSemitone = {
                    'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
                    'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
                };
                
                const semitone = noteToSemitone[note];
                const A4 = 440;
                const midiNumber = octave * 12 + semitone + 12;
                
                return A4 * Math.pow(2, (midiNumber - 69) / 12);
            }

            // üéµ –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ù–û–¢–ê ‚Üí MIDI
            noteToMidi(note, octave) {
                const noteToSemitone = {
                    'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
                    'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
                };
                
                return octave * 12 + noteToSemitone[note] + 12;
            }

            // üéπ –ù–ê–ñ–ê–¢–ò–ï –ö–õ–ê–í–ò–®–ò (–ü–†–ò –î–ï–¢–ï–ö–¢–ï –ù–û–¢–´)
            pressKey(noteData) {
                const key = this.findKeyByNote(noteData.note, noteData.octave);
                if (!key) return;
                
                const keyId = `${noteData.note}${noteData.octave}`;
                
                // –ü–æ–º–µ—á–∞–µ–º –∫–ª–∞–≤–∏—à—É –∫–∞–∫ –Ω–∞–∂–∞—Ç—É—é
                this.piano.pressedKeys.set(keyId, {
                    key: key,
                    startTime: performance.now(),
                    intensity: noteData.confidence || 0.8
                });
                
                // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏
                this.piano.keyFlashes.set(keyId, {
                    startTime: performance.now(),
                    intensity: noteData.confidence || 0.8,
                    x: key.x + key.width/2,
                    y: key.y + key.height/2
                });
                
                // –°–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã
                this.createKeyParticles(key);
                
                console.log(`üéπ –ù–∞–∂–∞—Ç–∞ –∫–ª–∞–≤–∏—à–∞: ${keyId}`);
            }

            // üîç –ü–û–ò–°–ö –ö–õ–ê–í–ò–®–ò –ü–û –ù–û–¢–ï
            findKeyByNote(note, octave) {
                return this.piano.keys.find(key => 
                    key.note === note && key.octave === octave
                );
            }

            // ‚ú® –°–û–ó–î–ê–ù–ò–ï –ß–ê–°–¢–ò–¶ –ü–†–ò –ù–ê–ñ–ê–¢–ò–ò –ö–õ–ê–í–ò–®–ò (–õ–ï–¢–Ø–©–ò–• –í–í–ï–†–•)
            createKeyParticles(key) {
                const particleCount = 3 + Math.random() * 5;
                
                for (let i = 0; i < particleCount; i++) {
                    this.piano.noteParticles.push({
                        x: key.x + key.width / 2 + (Math.random() - 0.5) * key.width * 0.8,
                        y: this.piano.startY + 10 + Math.random() * 20,
                        speed: 1 + Math.random() * 2,
                        size: 1 + Math.random() * 3,
                        alpha: 0.8 + Math.random() * 0.2,
                        color: key.isBlack ? '#4fc3f7' : '#81c784'
                    });
                }
            }

            // üéπ –û–¢–ü–£–°–ö–ê–ù–ò–ï –ö–õ–ê–í–ò–®–ò
            releaseKey(noteData) {
                const keyId = `${noteData.note}${noteData.octave}`;
                this.piano.pressedKeys.delete(keyId);
            }

            // üé® –û–¢–†–ò–°–û–í–ö–ê –ö–õ–ê–í–ò–ê–¢–£–†–´ –í–ù–ò–ó–£ –≠–ö–†–ê–ù–ê
            drawVirtualPianoBottom(width, height) {
                console.log(`üéπ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: ${this.piano.keys.length} –∫–ª–∞–≤–∏—à, startY: ${this.piano.startY}`);
                
                if (!this.piano.keys.length) {
                    console.warn('‚ö†Ô∏è –ù–µ—Ç –∫–ª–∞–≤–∏—à –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏!');
                    return;
                }
                
                // –§–æ–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å —á–µ—Ç–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
                this.ctx.fillStyle = 'rgba(40, 40, 40, 0.95)';
                this.ctx.fillRect(0, this.piano.startY, width, height - this.piano.startY);
                
                // –†–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
                this.ctx.strokeStyle = '#666';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(0, this.piano.startY, width, height - this.piano.startY);
                
                console.log(`üéπ –†–∏—Å—É–µ–º –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏: ${this.piano.keys.filter(k => !k.isBlack).length}`);
                
                // –†–∏—Å—É–µ–º –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏
                this.piano.keys.filter(key => !key.isBlack).forEach(key => {
                    this.drawPianoKey(key);
                });
                
                console.log(`üéπ –†–∏—Å—É–µ–º —á–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏: ${this.piano.keys.filter(k => k.isBlack).length}`);
                
                // –†–∏—Å—É–µ–º —á–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –ø–æ–≤–µ—Ä—Ö –±–µ–ª—ã—Ö
                this.piano.keys.filter(key => key.isBlack).forEach(key => {
                    this.drawPianoKey(key);
                });
                
                // –†–∏—Å—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
                this.drawKeyEffects();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏ —Ä–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã (–ª–µ—Ç—è—â–∏–µ –≤–≤–µ—Ä—Ö)
                this.updateAndDrawParticlesUp();
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                this.ctx.fillStyle = 'white';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'left';
                this.ctx.fillText(`–ö–ª–∞–≤–∏—à: ${this.piano.keys.length}`, 10, this.piano.startY + 15);
            }

            // üéπ –û–¢–†–ò–°–û–í–ö–ê –û–¢–î–ï–õ–¨–ù–û–ô –ö–õ–ê–í–ò–®–ò
            drawPianoKey(key) {
                if (!key) return;
                
                const keyId = `${key.note}${key.octave}`;
                const isPressed = this.piano.pressedKeys.has(keyId);
                const pressData = this.piano.pressedKeys.get(keyId);
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–ª—é—á –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
                if (key.y < 0 || key.y > this.ctx.canvas.height) {
                    console.warn(`‚ö†Ô∏è –ö–ª–∞–≤–∏—à–∞ ${keyId} –≤–Ω–µ —ç–∫—Ä–∞–Ω–∞: y=${key.y}`);
                    return;
                }
                
                console.log(`üéπ –†–∏—Å—É–µ–º –∫–ª–∞–≤–∏—à—É ${keyId}: x=${key.x.toFixed(0)}, y=${key.y.toFixed(0)}, w=${key.width.toFixed(0)}, h=${key.height.toFixed(0)}, black=${key.isBlack}`);
                
                // –¶–≤–µ—Ç –∫–ª–∞–≤–∏—à–∏
                let fillColor, strokeColor;
                
                if (key.isBlack) {
                    fillColor = isPressed ? '#555' : '#000';
                    strokeColor = '#888';
                } else {
                    fillColor = isPressed ? '#ddd' : '#fff';
                    strokeColor = '#000';
                }
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏
                if (isPressed && pressData) {
                    const glowIntensity = pressData.intensity * 20;
                    const noteColor = this.getNoteColor(key.note);
                    
                    this.ctx.shadowColor = `rgba(${noteColor.r}, ${noteColor.g}, ${noteColor.b}, 0.8)`;
                    this.ctx.shadowBlur = glowIntensity;
                } else {
                    this.ctx.shadowBlur = 0;
                }
                
                // –†–∏—Å—É–µ–º –∫–ª–∞–≤–∏—à—É
                this.ctx.fillStyle = fillColor;
                this.ctx.strokeStyle = strokeColor;
                this.ctx.lineWidth = key.isBlack ? 1 : 2;
                
                this.ctx.fillRect(key.x, key.y, key.width, key.height);
                this.ctx.strokeRect(key.x, key.y, key.width, key.height);
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–Ω—å
                this.ctx.shadowBlur = 0;
                
                // –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ—Ç—ã –Ω–∞ –∫–ª–∞–≤–∏—à–µ
                if (key.width > 15) {
                    this.ctx.fillStyle = key.isBlack ? '#fff' : '#000';
                    this.ctx.font = key.isBlack ? '8px Arial' : '10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(
                        `${key.note}${key.octave}`, 
                        key.x + key.width/2, 
                        key.y + key.height - 8
                    );
                }
            }

            // ‚ú® –û–¢–†–ò–°–û–í–ö–ê –≠–§–§–ï–ö–¢–û–í –ö–õ–ê–í–ò–®
            drawKeyEffects() {
                const currentTime = performance.now();
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –∏ —Ä–∏—Å—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ
                for (let [keyId, effect] of this.piano.keyFlashes) {
                    const age = currentTime - effect.startTime;
                    const maxAge = 300; // 300–º—Å —ç—Ñ—Ñ–µ–∫—Ç
                    
                    if (age > maxAge) {
                        this.piano.keyFlashes.delete(keyId);
                        continue;
                    }
                    
                    const progress = age / maxAge;
                    const alpha = (1 - progress) * effect.intensity;
                    
                    // –ö—Ä—É–≥–æ–≤–∞—è –≤—Å–ø—ã—à–∫–∞
                    const radius = progress * 30;
                    const gradient = this.ctx.createRadialGradient(
                        effect.x, effect.y, 0,
                        effect.x, effect.y, radius
                    );
                    
                    gradient.addColorStop(0, `rgba(255, 255, 255, ${alpha * 0.8})`);
                    gradient.addColorStop(1, `rgba(255, 255, 255, 0)`);
                    
                    this.ctx.fillStyle = gradient;
                    this.ctx.beginPath();
                    this.ctx.arc(effect.x, effect.y, radius, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }

            // üí´ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò –û–¢–†–ò–°–û–í–ö–ê –ß–ê–°–¢–ò–¶ (–õ–ï–¢–Ø–©–ò–• –í–í–ï–†–•)
            updateAndDrawParticlesUp() {
                for (let i = this.piano.noteParticles.length - 1; i >= 0; i--) {
                    const particle = this.piano.noteParticles[i];
                    
                    // –î–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –≤–º–µ—Å—Ç–æ –≤–ø—Ä–∞–≤–æ
                    particle.y -= particle.speed;
                    particle.alpha -= 0.008;
                    
                    if (particle.alpha <= 0 || particle.y < 0) {
                        this.piano.noteParticles.splice(i, 1);
                        continue;
                    }
                    
                    // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—É
                    this.ctx.save();
                    this.ctx.globalAlpha = particle.alpha;
                    this.ctx.fillStyle = particle.color;
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                    this.ctx.fill();
                    this.ctx.restore();
                }
            }

            // üîÑ –ü–û–°–¢–û–Ø–ù–ù–ê–Ø –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø (–î–ê–ñ–ï –ë–ï–ó –ê–£–î–ò–û)
            startVisualLoop() {
                const render = () => {
                    this.drawProfessionalVisualization();
                    requestAnimationFrame(render);
                };
                render();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            new ProfessionalVocalAnalyzer();
        });
    </script>
</body>
</html> 