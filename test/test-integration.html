<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß –¢–µ—Å—Ç –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Background Effects Engine</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #2C3E50 0%, #3498DB 100%);
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-panel {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .test-panel h3 {
            margin-top: 0;
            color: #3498DB;
        }
        
        .video-container {
            position: relative;
            margin-bottom: 15px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        video, canvas {
            width: 100%;
            height: auto;
            display: block;
            transform: scaleX(-1);
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .effect-btn {
            background: linear-gradient(45deg, #E74C3C, #8E44AD);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .effect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .effect-btn.active {
            background: linear-gradient(45deg, #27AE60, #16A085);
        }
        
        .status {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .log {
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .comparison {
            background: rgba(52, 152, 219, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .face-mesh-test {
            background: rgba(155, 89, 182, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .engine-btn {
            background: linear-gradient(45deg, #2ECC71, #27AE60);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .engine-btn:hover {
            transform: scale(1.05);
        }
        
        .engine-btn:disabled {
            background: #7F8C8D;
            cursor: not-allowed;
            transform: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß –¢–µ—Å—Ç –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Background Effects Engine v2.0</h1>
        
        <div class="test-grid">
            <!-- –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ -->
            <div class="test-panel">
                <h3>üìã –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (MaskSystem)</h3>
                <div class="video-container">
                    <video id="video1" autoplay muted playsinline></video>
                    <canvas id="canvas1"></canvas>
                </div>
                
                <div class="controls">
                    <button class="effect-btn active" onclick="setOldEffect('none')">‚ùå –ù–µ—Ç</button>
                    <button class="effect-btn" onclick="setOldEffect('blur')">üå´Ô∏è –†–∞–∑–º—ã—Ç–∏–µ</button>
                    <button class="effect-btn" onclick="setOldEffect('green')">üíö –ó–µ–ª–µ–Ω—ã–π</button>
                    <button class="effect-btn" onclick="setOldEffect('blue')">üíô –°–∏–Ω–∏–π</button>
                    <button class="effect-btn" onclick="setOldEffect('matrix')">üîã –ú–∞—Ç—Ä–∏—Ü–∞</button>
                </div>
                
                <div class="status" id="status1">–ì–æ—Ç–æ–≤ –∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...</div>
            </div>
            
            <!-- –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ -->
            <div class="test-panel">
                <h3>üöÄ –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ (BackgroundEffectsEngine)</h3>
                <div class="video-container">
                    <video id="video2" autoplay muted playsinline></video>
                    <canvas id="canvas2"></canvas>
                </div>
                
                <div class="controls">
                    <button class="effect-btn active" onclick="setNewEffect('none')">‚ùå –ù–µ—Ç</button>
                    <button class="effect-btn" onclick="setNewEffect('blur')">üå´Ô∏è –†–∞–∑–º—ã—Ç–∏–µ</button>
                    <button class="effect-btn" onclick="setNewEffect('green')">üíö –ó–µ–ª–µ–Ω—ã–π</button>
                    <button class="effect-btn" onclick="setNewEffect('blue')">üíô –°–∏–Ω–∏–π</button>
                    <button class="effect-btn" onclick="setNewEffect('matrix')">üîã –ú–∞—Ç—Ä–∏—Ü–∞</button>
                </div>
                
                <div class="status" id="status2">–ì–æ—Ç–æ–≤ –∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...</div>
            </div>
        </div>
        
        <div class="comparison">
            <h3>üéØ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–º</h3>
            <button class="engine-btn" onclick="initializeTest()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
            <button class="engine-btn" onclick="toggleMirroring()">ü™û –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
            <button class="engine-btn" onclick="showStatus()">üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <button class="engine-btn" onclick="stopTest()">‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
        </div>
        
        <div class="face-mesh-test">
            <h3>üé≠ –¢–µ—Å—Ç Face Mesh (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)</h3>
            <div class="video-container">
                <video id="video3" autoplay muted playsinline></video>
                <canvas id="canvas3"></canvas>
            </div>
            <button class="engine-btn" onclick="testFaceMesh()">üé≠ –¢–µ—Å—Ç Face Mesh</button>
            <button class="engine-btn" onclick="stopFaceMesh()">‚èπÔ∏è –°—Ç–æ–ø Face Mesh</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <!-- MediaPipe –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    
    <!-- –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ -->
    <script src="js/background-effects-engine.js"></script>

    <script>
        let video1, video2, video3;
        let canvas1, canvas2, canvas3;
        let backgroundEngine;
        let faceMesh;
        let mirroringEnabled = true;
        let oldSystemActive = false;
        let newSystemActive = false;
        let faceMeshActive = false;

        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateStatus(id, message) {
            document.getElementById(id).textContent = message;
            log(`${id}: ${message}`);
        }

        async function initializeTest() {
            try {
                log('üöÄ –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                video1 = document.getElementById('video1');
                video2 = document.getElementById('video2');
                video3 = document.getElementById('video3');
                canvas1 = document.getElementById('canvas1');
                canvas2 = document.getElementById('canvas2');
                canvas3 = document.getElementById('canvas3');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: 'user' }
                });
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                video1.srcObject = stream.clone();
                video2.srcObject = stream.clone();
                video3.srcObject = stream.clone();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º canvas —Ä–∞–∑–º–µ—Ä—ã
                [canvas1, canvas2, canvas3].forEach((canvas, index) => {
                    canvas.width = 640;
                    canvas.height = 480;
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞
                backgroundEngine = new BackgroundEffectsEngine();
                const engineReady = await backgroundEngine.initialize();
                
                if (engineReady) {
                    backgroundEngine.setTargetCanvas(canvas2);
                    backgroundEngine.setVideoSource(video2);
                    updateStatus('status2', '‚úÖ –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –≥–æ—Ç–æ–≤');
                } else {
                    updateStatus('status2', '‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞');
                }
                
                updateStatus('status1', '‚ö†Ô∏è –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
                log('‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ—Å—Ç–∞: ${error.message}`);
            }
        }

        function setNewEffect(effect) {
            if (!backgroundEngine) {
                log('‚ùå –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.test-panel:nth-child(2) .effect-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            backgroundEngine.setEffect(effect);
            
            if (effect === 'none') {
                backgroundEngine.stopProcessing();
                canvas2.getContext('2d').clearRect(0, 0, canvas2.width, canvas2.height);
                newSystemActive = false;
            } else {
                if (!newSystemActive) {
                    backgroundEngine.startProcessing();
                    newSystemActive = true;
                }
            }
            
            log(`üöÄ –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫: —ç—Ñ—Ñ–µ–∫—Ç ${effect}`);
        }

        function setOldEffect(effect) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.test-panel:nth-child(1) .effect-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            log(`üìã –°—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞: —ç—Ñ—Ñ–µ–∫—Ç ${effect} (—Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)`);
            updateStatus('status1', `–í—ã–±—Ä–∞–Ω —ç—Ñ—Ñ–µ–∫—Ç: ${effect}`);
        }

        async function testFaceMesh() {
            try {
                if (!faceMesh) {
                    faceMesh = new FaceMesh({
                        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
                    });
                    
                    await faceMesh.setOptions({
                        maxNumFaces: 1,
                        refineLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    
                    faceMesh.onResults((results) => {
                        const ctx = canvas3.getContext('2d');
                        ctx.clearRect(0, 0, canvas3.width, canvas3.height);
                        
                        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                            const landmarks = results.multiFaceLandmarks[0];
                            
                            ctx.fillStyle = '#00FF00';
                            landmarks.forEach((landmark) => {
                                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–µ—Ä–∫–∞–ª–∏—Ä—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã X
                                const x = (1 - landmark.x) * canvas3.width;
                                const y = landmark.y * canvas3.height;
                                
                                ctx.beginPath();
                                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                                ctx.fill();
                            });
                            
                            ctx.font = '16px Arial';
                            ctx.fillStyle = '#FFD700';
                            ctx.fillText(`Face Mesh: ${landmarks.length} —Ç–æ—á–µ–∫ (–ò–°–ü–†–ê–í–õ–ï–ù–û)`, 10, 30);
                        } else {
                            ctx.font = '16px Arial';
                            ctx.fillStyle = '#FF6B6B';
                            ctx.fillText('–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ', 10, 30);
                        }
                    });
                }
                
                faceMeshActive = true;
                processFaceMeshFrame();
                log('üé≠ Face Mesh —Ç–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º)');
                
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ Face Mesh —Ç–µ—Å—Ç–∞: ${error.message}`);
            }
        }

        async function processFaceMeshFrame() {
            if (!faceMeshActive || !faceMesh || !video3) return;
            
            try {
                await faceMesh.send({ image: video3 });
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Face Mesh –∫–∞–¥—Ä–∞: ${error.message}`);
            }
            
            if (faceMeshActive) {
                requestAnimationFrame(processFaceMeshFrame);
            }
        }

        function stopFaceMesh() {
            faceMeshActive = false;
            if (canvas3) {
                canvas3.getContext('2d').clearRect(0, 0, canvas3.width, canvas3.height);
            }
            log('‚èπÔ∏è Face Mesh —Ç–µ—Å—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        }

        function toggleMirroring() {
            mirroringEnabled = !mirroringEnabled;
            if (backgroundEngine) {
                backgroundEngine.setMirroring(mirroringEnabled);
            }
            log(`ü™û –ó–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: ${mirroringEnabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–≤—ã–∫–ª—é—á–µ–Ω–æ'}`);
        }

        function showStatus() {
            if (backgroundEngine) {
                const status = backgroundEngine.getStatus();
                log(`üìä –°—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞: ${JSON.stringify(status, null, 2)}`);
            } else {
                log('üìä –ù–æ–≤—ã–π –¥–≤–∏–∂–æ–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            }
        }

        function stopTest() {
            if (backgroundEngine) {
                backgroundEngine.stopProcessing();
                backgroundEngine.dispose();
                backgroundEngine = null;
            }
            stopFaceMesh();
            newSystemActive = false;
            oldSystemActive = false;
            log('‚èπÔ∏è –í—Å–µ —Ç–µ—Å—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üåü –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            log('üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:');
            log('1. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç" –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏');
            log('2. –°—Ä–∞–≤–Ω–∏—Ç–µ —Ä–∞–±–æ—Ç—É —Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã');
            log('3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π Face Mesh');
            log('4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ');
        });
    </script>
</body>
</html> 