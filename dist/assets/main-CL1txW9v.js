var K=Object.defineProperty;var Q=(y,t,e)=>t in y?K(y,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):y[t]=e;var v=(y,t,e)=>Q(y,typeof t!="symbol"?t+"":t,e);import{PitchDetector as X}from"https://esm.sh/pitchy@4";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const s of n.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();window.PitchDetector=X;console.log("‚úÖ Pitchy –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ beLive");class Z{constructor({engine:t,markerManager:e,lyricsDisplay:o,blockLoopControl:r}){v(this,"DEBUG",!0);v(this,"CLEANUP_DETACH",!1);var n;this.DEBUG&&console.log("[AudioExporter Constructor] Received engine:",t,"engine.audioContext:",t==null?void 0:t.audioContext),this.engine=t,this.DEBUG&&console.log("[AudioExporter Constructor] this.engine after assignment:",this.engine,"this.engine.audioContext:",(n=this.engine)==null?void 0:n.audioContext),this.markerManager=e||(t==null?void 0:t.markerManager)||null,this.lyricsDisplay=o||(t==null?void 0:t.lyricsDisplay)||null,this.blockLoopControl=r,this.DEBUG=!0,this.ac=null,this.sampleRate=44100,this.maxDurationSec=10*60,this.smartMicroFade=!1,this.defaultBitrate=320,this.fadeMs=2}async exportBlocks({blockIds:t,onProgress:e}){var k,F,L,M;if(!Array.isArray(t)||t.length===0)throw console.error("AudioExporter: –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞."),new Error("–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞");const{instBuf:o,vocBuf:r,sampleRate:n}=await this._getStemBuffers(),s=this._buildSegmentsFromBlocks(t);if(s.length===0)throw console.error("AudioExporter: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –±–ª–æ–∫–∞–º."),new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –±–ª–æ–∫–∞–º");const c=this.engine.getPlaybackRate?this.engine.getPlaybackRate():1,a=((F=(k=this.engine.instrumentalGain)==null?void 0:k.gain)==null?void 0:F.value)??1,g=((M=(L=this.engine.vocalsGain)==null?void 0:L.gain)==null?void 0:M.value)??1,p=s.reduce((R,U)=>R+(U.end-U.start),0)/Math.max(.001,c);if(p>this.maxDurationSec)throw console.error(`AudioExporter: –ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ${p.toFixed(1)}—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ${this.maxDurationSec}—Å`),new Error(`–ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ${p.toFixed(1)}—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ${this.maxDurationSec}—Å`);const l=2,u=Math.ceil(this.sampleRate*p),h=new OfflineAudioContext(l,u,this.sampleRate),d=h.createGain();d.gain.value=a;const w=h.createGain();w.gain.value=g,d.connect(h.destination),w.connect(h.destination);let f=0;const E=this.fadeMs/1e3;for(const R of s){const U=Math.max(0,R.end-R.start);if(U<=0)continue;const I=U/Math.max(.001,c);if(o){const C=h.createBufferSource();C.buffer=o,C.playbackRate.value=c;const b=h.createGain();b.gain.setValueAtTime(0,f),b.gain.linearRampToValueAtTime(1,f+E),b.gain.setValueAtTime(1,f+Math.max(0,I-E)),b.gain.linearRampToValueAtTime(0,f+I),C.connect(b).connect(d),C.start(f,R.start,U)}if(r){const C=h.createBufferSource();C.buffer=r,C.playbackRate.value=c;const b=h.createGain();b.gain.setValueAtTime(0,f),b.gain.linearRampToValueAtTime(1,f+E),b.gain.setValueAtTime(1,f+Math.max(0,I-E)),b.gain.linearRampToValueAtTime(0,f+I),C.connect(b).connect(w),C.start(f,R.start,U)}f+=I}const A=await h.startRendering(),S=await this._encodeToMp3(A,{bitrate:this.defaultBitrate,onProgress:e}),T=this._makeFileName();return{blob:S,filename:T}}_buildSegmentsFromBlocks(t){const e=this.lyricsDisplay&&Array.isArray(this.lyricsDisplay.textBlocks)?this.lyricsDisplay.textBlocks:[],o=new Set(t.map(String)),r=e.filter(s=>o.has(String(s.id))),n=[];for(const s of r){const c=this._getTimeRangeForBlock(s);c&&typeof c.startTime=="number"&&typeof c.endTime=="number"&&c.endTime>c.startTime?n.push({start:c.startTime,end:c.endTime,id:s.id,name:s.name}):console.warn(`AudioExporter: _buildSegmentsFromBlocks - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±–ª–æ–∫–∞ ${s.id}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`)}return n}_getTimeRangeForBlock(t){if(!this.markerManager)return console.error("AudioExporter: _getTimeRangeForBlock - markerManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω."),null;const e=this.markerManager.getMarkers();if(!Array.isArray(e)||e.length===0)return console.warn("AudioExporter: _getTimeRangeForBlock - –ú–∞—Ä–∫–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã."),null;const o=Math.min(...t.lineIndices||[]),r=Math.max(...t.lineIndices||[]);let n=e.find(c=>c.lineIndex===o);n||(n=e.find(c=>c.lineIndex>=o),n&&console.warn(`AudioExporter: _getTimeRangeForBlock - –¢–æ—á–Ω—ã–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ª–∏–Ω–∏–∏ ${o} –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–∏–∂–∞–π—à–∏–π: ${n.lineIndex} –≤ ${n.time.toFixed(2)}—Å.`));let s=e.find(c=>c.lineIndex>r);if(!s){const c=this.engine.getDuration?this.engine.getDuration():this.engine.duration||0;c>0&&(s={time:c},console.warn(`AudioExporter: _getTimeRangeForBlock - –ö–æ–Ω–µ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ª–∏–Ω–∏–∏ ${r} –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞: ${c.toFixed(2)}—Å.`))}return!n||!s?(console.error("AudioExporter: _getTimeRangeForBlock - –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä."),null):{startTime:n.time,endTime:s.time}}async _getStemBuffers(){var s,c,a,g,i,p,l,u;const t=((c=(s=this.engine)==null?void 0:s.hybridEngine)==null?void 0:c.originalInstrumentalUrl)||((g=(a=this.engine)==null?void 0:a.hybridEngine)==null?void 0:g.instrumentalUrl),e=((p=(i=this.engine)==null?void 0:i.hybridEngine)==null?void 0:p.originalVocalsUrl)||((u=(l=this.engine)==null?void 0:l.hybridEngine)==null?void 0:u.vocalsUrl),[o,r]=await Promise.all([t?this._fetchDecodeToBuffer(t,"Instrumental"):Promise.resolve(null),e?this._fetchDecodeToBuffer(e,"Vocals"):Promise.resolve(null)]),n=o&&o.sampleRate||r&&r.sampleRate||this.sampleRate;return{instBuf:o,vocBuf:r,sampleRate:n}}async _fetchDecodeToBuffer(t,e="Unknown"){try{const o=await fetch(t);if(!o.ok)throw new Error(`Fetch failed ${o.status} ${o.statusText}`);const r=await o.arrayBuffer();return await new OfflineAudioContext(2,2,44100).decodeAudioData(r)}catch(o){throw console.error(`AudioExporter: _fetchDecodeToBuffer - –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ ${e} –∏–∑ ${t}:`,o),o}}_makeFileName(){var n,s,c;const t=((c=(s=(n=window.trackCatalog)==null?void 0:n.tracks)==null?void 0:s[window.trackCatalog.currentTrackIndex])==null?void 0:c.title)||"belive_export",e=this.engine.getPlaybackRate?this.engine.getPlaybackRate():1,o=Math.abs(e-1)<.001?"":`__BPM${Math.round(e*100)}`;return`${t}${o}.mp3`}_encodeWav(t,e,o){const r=t&&e?2:1,n=t.length,s=n*r*2,c=new ArrayBuffer(44+s),a=new DataView(c);function g(l,u,h){for(let d=0;d<h.length;d++)l.setUint8(u+d,h.charCodeAt(d))}let i=0;g(a,i,"RIFF"),i+=4,a.setUint32(i,36+s,!0),i+=4,g(a,i,"WAVE"),i+=4,g(a,i,"fmt "),i+=4,a.setUint32(i,16,!0),i+=4,a.setUint16(i,1,!0),i+=2,a.setUint16(i,r,!0),i+=2,a.setUint32(i,o,!0),i+=4,a.setUint32(i,o*r*2,!0),i+=4,a.setUint16(i,r*2,!0),i+=2,a.setUint16(i,16,!0),i+=2,g(a,i,"data"),i+=4,a.setUint32(i,s,!0),i+=4;function p(l,u,h){for(let d=0;d<h.length;d++,u+=2){let w=Math.max(-1,Math.min(1,h[d]));l.setInt16(u,w<0?w*32768:w*32767,!0)}}if(p(a,i,t),r===2)for(let l=0;l<n;l++){let u=Math.max(-1,Math.min(1,t[l])),h=Math.max(-1,Math.min(1,e[l]));a.setInt16(i,u<0?u*32768:u*32767,!0),i+=2,a.setInt16(i,h<0?h*32768:h*32767,!0),i+=2}else for(let l=0;l<n;l++){let u=Math.max(-1,Math.min(1,t[l]));a.setInt16(i,u<0?u*32768:u*32767,!0),i+=2}return new Blob([c],{type:"audio/wav"})}async _encodeToMp3(t,{bitrate:e=320,onProgress:o}){return new Promise((r,n)=>{try{const s=new Worker("js/workers/mp3-encoder.worker.js"),c=1152,a=t.getChannelData(0),g=t.numberOfChannels>1?t.getChannelData(1):t.getChannelData(0);let i=0;const p=[],l=h=>{const d=new Int16Array(h.length);for(let w=0;w<h.length;w++){let f=Math.max(-1,Math.min(1,h[w]));d[w]=f<0?f*32768:f*32767}return d};s.onmessage=h=>{const d=h.data||{};if(d.type==="data"&&d.buffer)p.push(new Uint8Array(d.buffer));else if(d.type==="done"&&d.buffer){p.push(new Uint8Array(d.buffer));const w=new ArrayBuffer(p.reduce((E,A)=>E+A.length,0));let f=0;for(const E of p)new Uint8Array(w,f,E.length).set(E),f+=E.length;s.terminate(),r(w)}else d.type==="error"?(s.terminate(),n(new Error(d.message||"MP3 worker error"))):d.type==="progress"&&o&&o(d.progress)},s.postMessage({type:"init",numChannels:t.numberOfChannels,sampleRate:t.sampleRate,bitrate:e});const u=()=>{if(i>=a.length){s.postMessage({type:"flush"});return}const h=Math.min(a.length,i+c),d=l(a.subarray(i,h)),w=l(g.subarray(i,h));i=h,s.postMessage({type:"encode",left:d,right:w},[d.buffer,w.buffer]),setTimeout(u,0)};u()}catch(s){console.error("AudioExporter: _encodeToMp3 - –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –∑–∞–ø—É—Å–∫–µ Worker'–∞:",s),n(new Error(`Failed to create or start MP3 worker: ${s.message}`))}})}async _encodeMp3WithWorker({left:t,right:e,sampleRate:o,bitrate:r=320}){return new Promise((n,s)=>{const c=new Worker("js/workers/mp3-encoder.worker.js"),a=1152*20,g=t,i=e.length===t.length?e:new Float32Array(t.length);let p=0;const l=[];let u=!1;c.onmessage=w=>{const f=w.data||{},E=f.type||f.command;if(E==="inited")u=!0,d();else if(E==="data"&&f.buffer)l.push(new Uint8Array(f.buffer));else if(E==="done"&&f.buffer){l.push(new Uint8Array(f.buffer));const A=new Blob(l,{type:"audio/mpeg"});c.terminate(),n(A)}else E==="error"&&(c.terminate(),s(new Error(f.message||"MP3 worker error")))},c.postMessage({command:"init",numChannels:2,sampleRate:o,bitrate:r});const h=w=>{const f=new Int16Array(w.length);for(let E=0;E<w.length;E++){let A=Math.max(-1,Math.min(1,w[E]));f[E]=A<0?A*32768:A*32767}return f},d=()=>{if(!u)return;if(p>=g.length){c.postMessage({command:"flush"});return}const w=Math.min(g.length,p+a),f=g.subarray(p,w),E=i.subarray(p,w);if(f.length===0){p=w,setTimeout(d,0);return}const A=h(f),S=h(E);p=w,c.postMessage({command:"encode",left:A,right:S},[A.buffer,S.buffer]),setTimeout(d,0)}})}async _initMp3Worker(t,e){return this.mp3Worker&&this.mp3Worker.terminate(),this.mp3Worker=new Worker("js/workers/mp3-encoder.worker.js"),this.mp3WorkerPromise=new Promise((o,r)=>{this.mp3Worker.onmessage=n=>{n.data.type==="inited"?o():n.data.type==="error"&&r(new Error(n.data.message||"MP3 worker init error"))},this.mp3Worker.onerror=n=>r(new Error(n.message||"MP3 worker error")),this.mp3Worker.postMessage({type:"init",numChannels:2,sampleRate:t,bitrate:e})}),this.mp3WorkerPromise}async _flushMp3Worker(){return new Promise((t,e)=>{if(!this.mp3Worker)return e(new Error("MP3 worker not active."));const o=[];this.mp3Worker.onmessage=r=>{r.data.type==="data"&&r.data.buffer?o.push(new Uint8Array(r.data.buffer)):r.data.type==="done"&&r.data.buffer?(o.push(new Uint8Array(r.data.buffer)),this.mp3Worker.terminate(),this.mp3Worker=null,t(o)):r.data.type==="error"&&(this.mp3Worker.terminate(),this.mp3Worker=null,e(new Error(r.data.message||"MP3 worker flush error")))},this.mp3Worker.onerror=r=>{this.mp3Worker.terminate(),this.mp3Worker=null,e(new Error(r.message||"MP3 worker error during flush"))},this.mp3Worker.postMessage({type:"flush"})})}async _probeWorkletAndGraph(t){var i,p;if(t||(t=this.ac||this.engine.audioContext),!t)throw new Error("AudioContext not found");if(t.state!=="running")try{await t.resume()}catch(l){throw console.error("[Probe] resume failed",l),l}try{await t.audioWorklet.addModule("js/worklets/recorder-processor.js")}catch(l){if(!String(l.message||"").includes("already"))throw l}const e=t.createGain();e.gain.value=1;const o=new AudioWorkletNode(t,"recorder-processor",{processorOptions:{channels:2,chunkFrames:16384}});this.DEBUG&&console.log("[Probe] Checkpoint 3.1: probeExportSum and probeRecNode created"),e.connect(o),this.DEBUG&&console.log("[Probe] Checkpoint 3.2: probeExportSum connected to probeRecNode");const r=t.createGain();r.gain.value=0,o.connect(r).connect(t.destination),this.DEBUG&&console.log("[Probe] Checkpoint 3.3: probeRecNode connected to probeSink and ac.destination");let n=0,s=0;const c=l=>{var h;const u=l.data||{};u.type==="chunk"&&u.buffers&&(n++,s+=(((h=u.buffers[0])==null?void 0:h.byteLength)||0)/4)};o.port.addEventListener("message",c),(p=(i=o.port).start)==null||p.call(i);const a=t.createOscillator(),g=t.createGain();g.gain.value=.12,a.connect(g).connect(e),a.start(),a.stop(t.currentTime+.3),await new Promise(l=>setTimeout(l,500));try{a.disconnect(),g.disconnect()}catch{}await new Promise(l=>setTimeout(l,40));try{o.port.removeEventListener("message",c)}catch{}try{o.port.postMessage({type:"flush"}),await new Promise(l=>setTimeout(l,40)),o.port.postMessage({type:"stop"}),await new Promise(l=>setTimeout(l,40))}catch{}try{e.disconnect()}catch{}try{o.disconnect()}catch{}try{r.disconnect()}catch{}return{probeChunks:n,probeFrames:s}}async exportBlocksRealtime({blockIds:t,onProgress:e,format:o="wav",bitrate:r=320,muteDuringExport:n=!1}){var C,b,V,H,j;const s=this.engine;if(!s)throw new Error("[Exporter] engine not found");this._exportAbortController=new AbortController;const{signal:c}=this._exportAbortController;this.DEBUG&&console.log("[Exporter] Checkpoint 0.5: this.engine at start of exportBlocksRealtime:",this.engine,"this.engine.audioContext:",(C=this.engine)==null?void 0:C.audioContext),this.ac||(this.ac=this.engine.audioContext);const a=this.ac;if(!a)throw new Error("[Exporter] AudioContext not found");if(this.isExporting){console.warn("AudioExporter: –≠–∫—Å–ø–æ—Ä—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.");return}if(this.isExporting=!0,this.DEBUG&&console.log("[Exporter] Checkpoint 1: exportBlocksRealtime called"),a.state!=="running")try{await a.resume(),this.DEBUG&&console.log("[Exporter] AudioContext resumed:",a.state)}catch(m){throw console.error("[Exporter] ac.resume() failed",m),m}if(this.DEBUG)try{this.DEBUG&&console.log("[Exporter] Checkpoint 1.3: Calling _probeWorkletAndGraph");const{probeChunks:m,probeFrames:x}=await this._probeWorkletAndGraph(a);console.log(`[Probe] chunks=${m} frames=${x}`),m===0&&console.warn("Probe returned 0 chunks ‚Äî check worklet path/name later")}catch(m){console.error("[Exporter] Checkpoint 1.4: probe error (non-fatal):",m)}if(this.DEBUG&&o==="wav"&&(t!=null&&t.length)){const m=a.sampleRate,x=Math.floor(m*.5),_=new Float32Array(x),O=new Float32Array(x);for(let W=0;W<x;W++){const J=W/m,z=Math.sin(2*Math.PI*440*J)*.2;_[W]=z,O[W]=z}const D=this._encodeWav(_,O,m);return console.log("[Exporter] TEST WAV created, size:",D.size),{blob:D,durationSec:.5,sampleRate:m,channels:2,format:"wav",filename:"test-beep.wav"}}try{await a.audioWorklet.addModule("js/worklets/recorder-processor.js")}catch(m){if(!String(m.message||"").includes("already"))throw m;this.DEBUG&&console.log("[Exporter] Recorder processor already loaded")}const g=(s==null?void 0:s.hybridEngine)||{};this.DEBUG&&console.log("[Exporter] Checkpoint 2.0: Hybrid Engine properties:",{originalInstrumentalUrl:g.originalInstrumentalUrl,instrumentalUrl:g.instrumentalUrl,engineInstrumentalAudioSrc:(b=s==null?void 0:s.instrumentalAudio)==null?void 0:b.src});const i=(...m)=>{for(const x of m)if(x&&typeof x=="string"&&x.trim())return x;return null};let p=i(g.originalInstrumentalUrl,g.instrumentalUrl,(V=s==null?void 0:s.instrumentalAudio)==null?void 0:V.src),l=i(g.originalVocalsUrl,g.vocalsUrl,(H=s==null?void 0:s.vocalsAudio)==null?void 0:H.src);if(this.DEBUG&&console.log("[Exporter] Checkpoint 2.1: Initial instrumentalSrcUrl:",p),this.DEBUG&&console.log("[Exporter] Checkpoint 2.2: Initial vocalsSrcUrl:",l),!p){const m=s==null?void 0:s.instrumentalAudio;m&&(await new Promise(x=>{if(m.readyState>=2&&m.src)return x();const _=()=>{m.removeEventListener("loadedmetadata",_),x()};m.addEventListener("loadedmetadata",_),setTimeout(x,500)}),p=i(g.originalInstrumentalUrl,g.instrumentalUrl,(j=s==null?void 0:s.instrumentalAudio)==null?void 0:j.src))}if(!p)throw console.error("[Exporter] –ù–µ—Ç URL –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∞ (hybridEngine/element)."),this.isExporting=!1,this._exportAbortController=null,new Error("–ù–µ—Ç URL –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∞: –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã.");const u=a.createGain();u.gain.value=1;const h=new AudioWorkletNode(a,"recorder-processor",{processorOptions:{channels:2,chunkFrames:16384}});u.connect(h);const d=a.createGain();d.gain.value=0,h.connect(d).connect(a.destination);const w=[],f=[];h.port.onmessage=m=>{const x=m.data||{};x.type==="chunk"&&x.buffers&&(w.push(new Float32Array(x.buffers[0])),f.push(new Float32Array(x.buffers[1])))},o==="mp3"&&await this._initMp3Worker(a.sampleRate,r);const A=this.lyricsDisplay&&Array.isArray(this.lyricsDisplay.textBlocks)?this.lyricsDisplay.textBlocks:[];if(t.map(m=>A.find(x=>String(x.id)===m)).filter(Boolean).length===0)throw new Error("–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");a.currentTime+.12,q(te(256),.7),q(oe(256),.7),n&&(s.instrumentalAudio&&(s.instrumentalAudio.muted=!0),s.vocalsAudio&&(s.vocalsAudio.muted=!0),this.DEBUG&&console.log("AudioExporter: –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–µ–Ω."));const k=ee(p,rate);await new Promise(m=>{if(k.readyState>=2)return m();k.addEventListener("loadedmetadata",m,{once:!0})});const F=a.createMediaElementSource(k),L=a.createGain();L.gain.value=(options.instrumentalGain??1)*.8,F.connect(L).connect(u);try{k.paused&&await k.play()}catch(m){console.error("elA.play failed",m)}await new Promise(m=>setTimeout(m,1200));try{k.pause()}catch{}h.port.postMessage({type:"flush"}),await new Promise(m=>setTimeout(m,80)),h.port.postMessage({type:"stop"}),await new Promise(m=>setTimeout(m,80));const M=m=>{let x=0;for(const D of m)x+=D.length;const _=new Float32Array(x);let O=0;for(const D of m)_.set(D,O),O+=D.length;return _},R=M(w),U=M(f),I=this._encodeWav(R,U,a.sampleRate);return console.log("[Exporter] WAV built from A-slot, size:",I.size),{blob:I,durationSec:R.length/a.sampleRate,sampleRate:a.sampleRate,channels:2,format:"wav",filename:"a-slot.wav"}}_floatTo16(t){const e=new Int16Array(t.length);for(let o=0;o<t.length;o++){let r=Math.max(-1,Math.min(1,t[o]));e[o]=r<0?r*32768:r*32767}return e}_encodeWav(t,e,o){const r=new Float32Array(t.length+e.length);for(let l=0,u=0;l<t.length;l++,u+=2)r[u]=t[l],r[u+1]=e[l]??0;const n=this._floatTo16(r),s=2*2,c=o*s,a=n.byteLength,g=new ArrayBuffer(44+a),i=new DataView(g),p=(l,u,h)=>{for(let d=0;d<h.length;d++)l.setUint8(u+d,h.charCodeAt(d))};return p(i,0,"RIFF"),i.setUint32(4,36+a,!0),p(i,8,"WAVE"),p(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,2,!0),i.setUint32(24,o,!0),i.setUint32(28,c,!0),i.setUint16(32,s,!0),i.setUint16(34,16,!0),p(i,36,"data"),i.setUint32(40,a,!0),new Int16Array(g,44).set(n),new Blob([i],{type:"audio/wav"})}}function ee(y,t=1){const e=new Audio;e.crossOrigin="anonymous",e.preload="auto",e.playsInline=!0,e.playbackRate=t;try{"preservesPitch"in e&&(e.preservesPitch=!0),"mozPreservesPitch"in e&&(e.mozPreservesPitch=!0),"webkitPreservesPitch"in e&&(e.webkitPreservesPitch=!0)}catch{}return e.src=y,e}function te(y=256){const t=new Float32Array(y);for(let e=0;e<y;e++)t[e]=Math.sin(e/(y-1)*Math.PI/2);return t}function oe(y=256){const t=new Float32Array(y);for(let e=0;e<y;e++)t[e]=Math.cos(e/(y-1)*Math.PI/2);return t}function q(y,t){const e=new Float32Array(y.length);for(let o=0;o<y.length;o++)e[o]=y[o]*t;return e}window.audioExporter=new Z({engine:window.audioEngine,markerManager:window.markerManager,lyricsDisplay:window.lyricsDisplay,blockLoopControl:window.blockLoopControl});class P extends Error{constructor(t,e,o,r){super(e),this.code=t,this.provider=o,this.statusCode=r,this.name="AIError"}}class re extends EventTarget{constructor(){super();v(this,"providers",new Map);v(this,"models",[]);v(this,"_activeModel",null);this.loadActiveModelFromLocalStorage()}register(e){this.providers.set(e.id,e),this.models=Array.from(this.providers.values()).flatMap(r=>r.models);const o=localStorage.getItem("belive:active-model");o&&this.models.some(r=>r.id===o)?this._activeModel=this.models.find(r=>r.id===o)||null:(this._activeModel=null,localStorage.removeItem("belive:active-model")),this.dispatchEvent(new CustomEvent("modelChanged",{detail:this._activeModel}))}getAllModels(){return this.models}setActiveModel(e){var r;let o=null;e!==null&&(o=this.models.find(n=>n.id===e)||null),((r=this._activeModel)==null?void 0:r.id)!==(o==null?void 0:o.id)&&(this._activeModel=o,this._activeModel?localStorage.setItem("belive:active-model",this._activeModel.id):localStorage.removeItem("belive:active-model"),this.dispatchEvent(new CustomEvent("modelChanged",{detail:this._activeModel})))}getActiveModel(){return this._activeModel}getActiveProvider(){const e=this.getActiveModel();return e&&this.providers.get(e.provider)||null}on(e,o){this.addEventListener(e,o)}off(e,o){this.removeEventListener(e,o)}async sendMessage(e,o){var s,c;const r=this.getActiveModel();if(!r){(s=o==null?void 0:o.onError)==null||s.call(o,new P("NO_MODEL_SELECTED","No active AI model selected."));return}const n=this.providers.get(r.provider);if(!n){(c=o==null?void 0:o.onError)==null||c.call(o,new P("PROVIDER_NOT_FOUND",`AI provider ${r.provider} not found.`));return}return n.sendChat(e,o)}stopAllProviders(){this.providers.forEach(e=>{var o;return(o=e.stop)==null?void 0:o.call(e)})}loadActiveModelFromLocalStorage(){}}const B=new re,ne="http://localhost:8787";class se{constructor(t=ne){v(this,"id","gateway");v(this,"displayName","beLive Gateway");v(this,"models",[{id:"openrouter/google/gemini-2.5-pro",shortName:"Gemini 2.5 Pro",provider:"gateway",contextWindow:1e6,costTier:"mid",capabilities:["chat","vision"]},{id:"openrouter/anthropic/claude-4.5-sonnet-20250929-thinking",shortName:"Claude 4.5 Sonnet",provider:"gateway",contextWindow:2e5,costTier:"mid",capabilities:["chat","vision","artifacts"],icon:"https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/claude.svg"},{id:"openrouter/openai/gpt-5-high",shortName:"GPT-5 High",provider:"gateway",contextWindow:128e3,costTier:"high",capabilities:["chat","function-calling"],icon:"https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/openai.svg"},{id:"openrouter/openai/gpt-4o-mini",shortName:"GPT-4o Mini",provider:"gateway",contextWindow:128e3,costTier:"low",capabilities:["chat","vision","function-calling"],icon:"https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/openai.svg"},{id:"openrouter/meta-llama/llama-3.1-8b-instruct",shortName:"Llama 3.1 8B",provider:"gateway",contextWindow:128e3,costTier:"low",capabilities:["chat"]},{id:"openrouter/xai/grok-1-vision",shortName:"Grok 4 Vision",provider:"gateway",contextWindow:128e3,costTier:"low",capabilities:["chat"],icon:"https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/grok.svg"},{id:"openrouter/deepseek/deepseek-v3.1",shortName:"DeepSeek-V3.1",provider:"gateway",contextWindow:184e4,costTier:"free",capabilities:["chat","vision","function-calling"]}]);v(this,"ephemeral",null);v(this,"currentAbortController",null);this.gatewayUrl=t}async healthCheck(){try{return(await fetch(`${this.gatewayUrl}/health`,{method:"GET",signal:AbortSignal.timeout(5e3)})).ok}catch{return!1}}async sendChat(t,e){var o;if(t.stream&&e)return this.streamChat(t,e);(o=e==null?void 0:e.onError)==null||o.call(e,new P("NOT_IMPLEMENTED","Non-streaming chat is not implemented."))}stop(){var t;(t=this.currentAbortController)==null||t.abort(),this.currentAbortController=null}async getEphemeralToken(){var e;const t=Date.now();if(this.ephemeral&&this.ephemeral.expiresAt-t>5e3)return this.ephemeral.token;try{const o=await fetch(`${this.gatewayUrl}/auth/ephemeral`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!o.ok){const n=await o.json();throw new P("AUTH_ERROR",((e=n.error)==null?void 0:e.message)||"Failed to get ephemeral token",this.id,o.status)}const r=await o.json();return this.ephemeral={token:r.token,expiresAt:r.expiresAt},this.ephemeral.token}catch(o){throw new P("NETWORK_ERROR",o.message||"Network error during ephemeral token request",this.id)}}async streamChat(t,e){var n,s,c,a,g,i,p,l,u,h;const o=await this.getEphemeralToken();(n=this.currentAbortController)==null||n.abort(),this.currentAbortController=new AbortController;const{signal:r}=this.currentAbortController;try{const d=await fetch(`${this.gatewayUrl}/v1/chat/stream`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(t),signal:r});if(!d.ok){const S=await d.text();let T;try{T=JSON.parse(S)}catch{}(a=e.onError)==null||a.call(e,new P(((s=T==null?void 0:T.error)==null?void 0:s.code)||"GATEWAY_ERROR",((c=T==null?void 0:T.error)==null?void 0:c.message)||`Gateway error: ${d.status} ${S}`,this.id,d.status));return}const w=d.body.getReader(),f=new TextDecoder;let E="",A="";for((g=e.onStart)==null||g.call(e,t.model);;){const{done:S,value:T}=await w.read();if(S)break;E+=f.decode(T,{stream:!0});const k=E.split(`
`);E=k.pop()||"";for(const F of k){if(!F.trim()||!F.startsWith("data: "))continue;const L=F.slice(6).trim();if(L!=="[DONE]")try{const M=JSON.parse(L);switch(M.type){case"token":A+=M.data,(i=e.onToken)==null||i.call(e,M.data);break;case"done":(p=e.onDone)==null||p.call(e,M.data.fullText||A,M.data.usage);break;case"error":(l=e.onError)==null||l.call(e,new P(M.data.code,M.data.message,this.id));break}}catch(M){console.warn("Failed to parse SSE event:",F,M)}}}(u=e.onDone)==null||u.call(e,A)}catch(d){if(d.name==="AbortError"){console.log("Stream aborted.");return}(h=e.onError)==null||h.call(e,new P("STREAM_FETCH_ERROR",d.message||"Failed to fetch stream",this.id))}}}class ie{constructor(){v(this,"dropdownElement");v(this,"modelListElement");v(this,"isOpen",!1);if(this.dropdownElement=document.getElementById("belive-ai-picker"),this.modelListElement=this.dropdownElement.querySelector(".model-list"),!this.dropdownElement||!this.modelListElement){console.error("ModelDropdownUI: –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã UI –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π.");return}this.init()}init(){this.renderModels(),document.addEventListener("click",t=>{this.dropdownElement.contains(t.target)||this.closeDropdown()}),B.on("modelChanged",()=>this.renderModels())}renderModels(){var o;this.modelListElement.innerHTML="";const t=B.getAllModels(),e=(o=B.getActiveModel())==null?void 0:o.id;t.forEach(r=>{const n=document.createElement("div");n.className="model-item",r.id===e&&n.classList.add("active"),n.dataset.modelId=r.id,n.innerHTML=`
                <span class="model-name">${r.shortName}</span>
                <span class="model-badge">${r.costTier}</span>
            `,n.addEventListener("click",()=>{B.setActiveModel(r.id),this.closeDropdown()}),this.modelListElement.appendChild(n)})}openAt(t){const e=t.getBoundingClientRect();Object.assign(this.dropdownElement.style,{left:`${e.left}px`,top:`${e.bottom+8}px`}),this.dropdownElement.classList.add("active"),this.isOpen=!0}closeDropdown(){this.dropdownElement.classList.remove("active"),this.isOpen=!1}toggleDropdown(){this.isOpen?this.closeDropdown():(console.warn("ModelDropdownUI: toggleDropdown –≤—ã–∑–≤–∞–Ω –±–µ–∑ —è–∫–æ—Ä—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ openAt(anchor)."),this.dropdownElement.classList.toggle("active"),this.isOpen=this.dropdownElement.classList.contains("active"))}}async function*ae(y){var r,n,s;const t=y.getReader(),e=new TextDecoder;let o="";try{for(;;){const{done:c,value:a}=await t.read();if(c)break;o+=e.decode(a,{stream:!0});const g=o.split(`
`);o=g.pop()||"";for(const i of g)if(i.startsWith("data: ")){const p=i.slice(6).trim();if(p==="[DONE]")return;try{const u=(s=(n=(r=JSON.parse(p).choices)==null?void 0:r[0])==null?void 0:n.delta)==null?void 0:s.content;u&&(yield u)}catch{}}}}finally{t.releaseLock()}}class ce{constructor(t){v(this,"recognition",null);v(this,"isRecording",!1);this.opts=t;const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e){console.warn("Speech Recognition not supported");return}this.recognition=new e,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.lang="ru-RU",this.recognition.onresult=o=>{var s,c;let r="",n=!1;for(const a of o.results)r+=a[0].transcript,a.isFinal&&(n=!0);(c=(s=this.opts).onPartial)==null||c.call(s,r),n&&this.opts.onFinal&&this.opts.onFinal(r)},this.recognition.onerror=o=>{console.error("Speech recognition error:",o.error),this.stopRecording()},this.recognition.onend=()=>{this.isRecording=!1}}startRecording(){return this.recognition?(this.isRecording=!0,this.recognition.start(),!0):!1}stopRecording(){this.recognition&&this.isRecording&&(this.recognition.stop(),this.isRecording=!1)}isActive(){return this.isRecording}}class Y{static parseToolCalls(t){const e=[],o=/```json\s*(\{[\s\S]*?"tool"[\s\S]*?\})\s*```/g;let r;for(;(r=o.exec(t))!==null;)try{const n=JSON.parse(r[1]);n.tool&&n.arguments&&e.push(n)}catch(n){console.warn("Failed to parse tool_call:",n)}return e}static async execute(t){try{switch(t.tool){case"set_metronome":return await this.setMetronome(t.arguments);case"analyze_vocal":return await this.analyzeVocal();case"suggest_exercise":return await this.suggestExercise(t.arguments);case"adjust_volume":return await this.adjustVolume(t.arguments);default:return{success:!1,message:`Unknown tool: ${t.tool}`}}}catch(e){return{success:!1,message:`Error executing ${t.tool}: ${e.message}`}}}static async setMetronome(t){const{bpm:e}=t;if(e<40||e>240)return{success:!1,message:"BPM –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–∂–¥—É 40 –∏ 240"};const o=document.getElementById("metronome-bpm");return o&&(o.value=String(e),o.dispatchEvent(new Event("change",{bubbles:!0}))),{success:!0,message:`–ú–µ—Ç—Ä–æ–Ω–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${e} BPM`,data:{bpm:e}}}static async analyzeVocal(){return{success:!0,message:"–ê–Ω–∞–ª–∏–∑ –≤–æ–∫–∞–ª–∞ –∑–∞–ø—É—â–µ–Ω. –°–ø–æ–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!",data:{analyzing:!0}}}static async suggestExercise(t){const o={breathing:'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "4-7-8": –í–¥–æ—Ö –Ω–∞ 4 —Å—á–µ—Ç–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7, –≤—ã–¥–æ—Ö –Ω–∞ 8',pitch:'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "–°–∏—Ä–µ–Ω–∞": –ü–ª–∞–≤–Ω–æ —Å–∫–æ–ª—å–∑–∏—Ç–µ –æ—Ç –Ω–∏–∑–∫–æ–π –Ω–æ—Ç—ã –¥–æ –≤—ã—Å–æ–∫–æ–π',resonance:'–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "–ú—ã—á–∞–Ω–∏–µ": –ú—ã—á–∏—Ç–µ –Ω–∞ —É–¥–æ–±–Ω–æ–π –Ω–æ—Ç–µ, –æ—â—É—â–∞—è –≤–∏–±—Ä–∞—Ü–∏—é –≤ –º–∞—Å–∫–µ –ª–∏—Ü–∞'}[t.type];return o?{success:!0,message:o,data:{type:t.type,exercise:o}}:{success:!1,message:`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${t.type}`}}static async adjustVolume(t){const{track:e,level:o}=t;if(o<0||o>100)return{success:!1,message:"–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 100"};const r=document.querySelector(`[data-track="${e}"]`);return r&&(r.value=String(o),r.dispatchEvent(new Event("input",{bubbles:!0}))),{success:!0,message:`–ì—Ä–æ–º–∫–æ—Å—Ç—å ${e} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ ${o}%`,data:{track:e,level:o}}}}class N{static measureChatOpen(){performance.mark("chat-open-start")}static measureChatOpened(){performance.mark("chat-open-end"),performance.measure("chat-open-duration","chat-open-start","chat-open-end");const t=performance.getEntriesByName("chat-open-duration")[0];console.log(`‚úÖ Chat opened in ${t.duration.toFixed(2)}ms`),t.duration>150&&console.warn("‚ö†Ô∏è Chat open time exceeded 150ms threshold")}static measureFirstToken(){performance.mark("first-token"),performance.measure("time-to-first-token","message-sent","first-token");const t=performance.getEntriesByName("time-to-first-token")[0];console.log(`‚úÖ First token in ${t.duration.toFixed(2)}ms`)}}let $=!1,G=0;function le(){$||($=!0,G=window.scrollY||window.pageYOffset,document.documentElement.style.scrollbarGutter="stable both-edges",document.body.style.position="fixed",document.body.style.top=`-${G}px`,document.body.style.left="0",document.body.style.right="0",document.body.style.width="100%")}function de(){$&&($=!1,document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.right="",document.body.style.width="",window.scrollTo(0,G))}class he{constructor(){v(this,"chatWindow");v(this,"messagesContainer");v(this,"inputField");v(this,"sendButton");v(this,"voiceButton");v(this,"modelSwitchButton");v(this,"closeButton");v(this,"chatTitleText");v(this,"appRoot");v(this,"isOpen",!1);v(this,"isStreaming",!1);v(this,"abortController",null);v(this,"currentMessageElement",null);v(this,"voiceInput");v(this,"handleSend",async()=>{const t=this.inputField.value.trim();if(!t||this.isStreaming)return;const e=B.getActiveProvider(),o=B.getActiveModel();if(!e||!o){this.addSystemMessage("‚ö†Ô∏è –ú–æ–¥–µ–ª—å AI –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å.");return}this.addMessage(t,"user"),this.inputField.value="",this.sendButton.disabled=!0,this.inputField.disabled=!0;const r=this.addMessage("","ai",!0);this.currentMessageElement=r,this.abortController=new AbortController,performance.mark("message-sent");try{this.isStreaming=!0;const n=await fetch("/api/gateway/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:o.id,messages:[{role:"user",content:t}],stream:!0}),signal:this.abortController.signal});if(!n.ok){const a=await n.text();throw new Error(`HTTP ${n.status}: ${this.mapError(n.status)} - ${a}`)}let s="",c=!0;for await(const a of ae(n.body))c&&(N.measureFirstToken(),this.updateMessage(r,"",!1),c=!1),s+=a,this.updateMessage(r,s,!1);this.checkForToolCalls(s)}catch(n){n.name==="AbortError"?this.updateMessage(r,"‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞",!1):(console.error("AI Chat Error:",n),this.updateMessage(r,`‚ùå –û—à–∏–±–∫–∞: ${n.message}`,!1))}finally{this.isStreaming=!1,this.sendButton.disabled=!1,this.inputField.disabled=!1,this.abortController=null,this.currentMessageElement=null,this.inputField.focus()}});if(this.chatWindow=document.getElementById("ai-chat-window"),this.messagesContainer=document.getElementById("ai-chat-messages"),this.inputField=document.getElementById("ai-input"),this.sendButton=document.getElementById("ai-send-button"),this.voiceButton=this.chatWindow.querySelector(".ai-voice-btn"),this.modelSwitchButton=this.chatWindow.querySelector(".ai-model-switch-btn"),this.closeButton=this.chatWindow.querySelector(".ai-close-btn"),this.chatTitleText=document.getElementById("ai-chat-title-text"),this.appRoot=document.getElementById("app-root"),this.voiceInput=new ce({onPartial:t=>{this.inputField.value=t},onFinal:t=>{this.inputField.value=t,this.handleSend()}}),!this.chatWindow||!this.messagesContainer||!this.inputField||!this.sendButton||!this.voiceButton||!this.modelSwitchButton||!this.closeButton||!this.chatTitleText||!this.appRoot){console.error("‚ùå AIChatUI: –û—à–∏–±–∫–∞! –ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI —á–∞—Ç–∞ –∏–ª–∏ #app-root.");return}this.init()}init(){var t;this.setupEventListeners(),this.subscribeToModelChanges(),this.updateOperatorButtonUI(((t=B.getActiveModel())==null?void 0:t.shortName)||null)}setupEventListeners(){var t;(t=document.getElementById("toggle-loopblock-mode"))==null||t.addEventListener("click",()=>this.toggleChat()),this.sendButton.addEventListener("click",this.handleSend),this.inputField.addEventListener("keypress",e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.handleSend())}),this.closeButton.addEventListener("click",()=>this.closeChat()),this.voiceButton.addEventListener("click",()=>this.toggleVoiceInput()),this.modelSwitchButton.addEventListener("click",e=>{e.stopPropagation();const o=document.getElementById("belive-ai-picker");if(o){const r=this.modelSwitchButton.getBoundingClientRect();Object.assign(o.style,{position:"fixed",left:`${r.left}px`,top:`${r.bottom+8}px`,transform:"translateY(0)",opacity:"1",pointerEvents:"all"}),o.classList.toggle("active")}}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.isOpen&&(e.preventDefault(),this.closeChat())})}subscribeToModelChanges(){B.on("modelChanged",t=>{const o=t.detail;o?(this.addSystemMessage(`‚úÖ –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞: ${o.shortName}`),this.chatTitleText.textContent=`AI –û–ø–µ—Ä–∞—Ç–æ—Ä (${o.shortName})`):(this.addSystemMessage("‚ö†Ô∏è –ú–æ–¥–µ–ª—å AI –Ω–µ –≤—ã–±—Ä–∞–Ω–∞."),this.chatTitleText.textContent="AI –û–ø–µ—Ä–∞—Ç–æ—Ä"),this.updateOperatorButtonUI((o==null?void 0:o.shortName)||null)})}updateOperatorButtonUI(t){const e=document.getElementById("toggle-loopblock-mode");e&&(t?(e.innerHTML=`<span class="operator-text">${t}</span>`,e.classList.add("ai-active")):(e.innerHTML='<span class="operator-text">Operator</span>',e.classList.remove("ai-active")))}toggleChat(){console.log("üí¨ AIChatUI: toggleChat called."),this.isOpen?this.closeChat():this.openChat()}openChat(){console.log("üí¨ AIChatUI: openChat called."),N.measureChatOpen(),this.isOpen=!0,this.chatWindow.classList.add("active"),this.chatWindow.classList.remove("hidden"),le(),this.appRoot&&this.appRoot.setAttribute("inert",""),this.inputField.focus(),this.messagesContainer.children.length===0&&this.addSystemMessage("üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI –û–ø–µ—Ä–∞—Ç–æ—Ä beLive. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"),requestAnimationFrame(()=>{N.measureChatOpened(),this.afterOpenLayoutFix()})}closeChat(){console.log("üí¨ AIChatUI: closeChat called."),this.isOpen=!1,this.chatWindow.classList.remove("active"),this.chatWindow.classList.add("hidden"),de(),this.appRoot&&this.appRoot.removeAttribute("inert"),this.isStreaming&&this.abortController&&(this.abortController.abort(),this.isStreaming=!1,this.sendButton.disabled=!1,this.inputField.disabled=!1,this.currentMessageElement&&this.updateMessage(this.currentMessageElement,"‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞",!1));const t=document.getElementById("belive-ai-picker");t&&t.classList.remove("active")}afterOpenLayoutFix(){requestAnimationFrame(()=>{this.chatWindow.getBoundingClientRect();const t=this.messagesContainer;requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight})})}addMessage(t,e,o=!1){const r=document.createElement("div");r.className=`message ${e}`;const n=document.createElement("div");return n.className="message-content",o?n.innerHTML=`
        <div class="ai-thinking">
          <span></span><span></span><span></span>
        </div>
      `:n.textContent=t,r.appendChild(n),this.messagesContainer.appendChild(r),r}updateMessage(t,e,o){const r=t.querySelector(".message-content");o?r.innerHTML=`
        <div class="ai-thinking">
          <span></span><span></span><span></span>
        </div>
      `:r.textContent=e,this.scrollToBottom()}addSystemMessage(t){const e=document.createElement("div");e.className="message system",e.innerHTML=`<div class="message-content">${t}</div>`,this.messagesContainer.appendChild(e),this.scrollToBottom()}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}toggleVoiceInput(){this.voiceInput.isActive()?(this.voiceInput.stopRecording(),this.voiceButton.classList.remove("recording")):this.voiceInput.startRecording()?(this.voiceButton.classList.add("recording"),this.addSystemMessage("üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ...")):this.addSystemMessage("‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")}async checkForToolCalls(t){const e=Y.parseToolCalls(t);if(e.length>0)for(const o of e){const r=await Y.execute(o),n=r.success?"‚úÖ":"‚ùå";this.addSystemMessage(`${n} ${r.message}`)}}mapError(t){return t===401||t===403?"–ù—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –≤–æ–π—Ç–∏.":t===429?"–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥‚Ä¶":t>=500?"–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.":"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."}}document.addEventListener("DOMContentLoaded",async()=>{if(window.__BELIVE_BOOTED__)return;window.__BELIVE_BOOTED__=!0;const y="http://localhost:8787",t=new se(y);B.register(t),new he,new ie,document.getElementById("toggle-loopblock-mode"),B.on("modelChanged",r=>{const s=r.detail,c=document.getElementById("toggle-loopblock-mode");c&&(s?(c.innerHTML=`<span class="operator-text">${s.shortName}</span>`,c.classList.add("ai-active")):(c.innerHTML='<span class="operator-text">Operator</span>',c.classList.remove("ai-active")))});const e=B.getActiveModel(),o=document.getElementById("toggle-loopblock-mode");o&&(e?(o.innerHTML=`<span class="operator-text">${e.shortName}</span>`,o.classList.add("ai-active")):(o.innerHTML='<span class="operator-text">Operator</span>',o.classList.remove("ai-active")))});
//# sourceMappingURL=main-CL1txW9v.js.map
