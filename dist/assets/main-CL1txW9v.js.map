{"version":3,"file":"main-CL1txW9v.js","sources":["../../index.html?html-proxy&index=0.js","../../js/audio-exporter.js","../../src/js/ai/types.ts","../../src/js/ai/registry.ts","../../src/js/ai/providers/gateway-provider.ts","../../src/js/ui/model-dropdown-ui.ts","../../src/js/utils/stream-openai.ts","../../src/js/utils/voice-input.ts","../../src/js/ai/action-executor.ts","../../src/js/utils/performance-monitor.ts","../../src/js/utils/scroll-lock.ts","../../src/js/ui/ai-chat-ui.ts","../../src/main.ts"],"sourcesContent":["\n        import { PitchDetector } from \"https://esm.sh/pitchy@4\";\n        window.PitchDetector = PitchDetector;\n        console.log('‚úÖ Pitchy –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ beLive');\n    ","class AudioExporter {\n  // üéØ –ù–û–í–û–ï: –ü–µ—Ä–µ–Ω–æ—Å–∏–º —Ñ–ª–∞–≥ –æ—Ç–ª–∞–¥–∫–∏ –≤ –Ω–∞—á–∞–ª–æ –∫–ª–∞—Å—Å–∞, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –≤–µ–∑–¥–µ\n  DEBUG = true;           \n  CLEANUP_DETACH = false;  \n\n  constructor({ engine, markerManager, lyricsDisplay, blockLoopControl }) {\n    this.DEBUG && console.log('[AudioExporter Constructor] Received engine:', engine, 'engine.audioContext:', engine?.audioContext);\n    this.engine = engine; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    this.DEBUG && console.log('[AudioExporter Constructor] this.engine after assignment:', this.engine, 'this.engine.audioContext:', this.engine?.audioContext);\n    this.markerManager = markerManager || engine?.markerManager || null; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback\n    this.lyricsDisplay = lyricsDisplay || engine?.lyricsDisplay || null; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback\n    this.blockLoopControl = blockLoopControl;\n    this.DEBUG = true; // –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–ª–∞–¥–∫–∏, –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ\n\n    // üéØ –ò–ó–ú–ï–ù–ï–ù–û: –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é this.ac. –û–Ω–∞ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –ø–µ—Ä–≤–æ–º –º–µ—Ç–æ–¥–µ, –∫–æ—Ç–æ—Ä—ã–π –µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç.\n    this.ac = null; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ null\n\n    this.sampleRate = 44100; // —Ü–µ–ª–∏–º—Å—è –≤ 44.1kHz –¥–ª—è MP3\n    this.maxDurationSec = 10 * 60; // –ª–∏–º–∏—Ç 10 –º–∏–Ω—É—Ç\n    this.smartMicroFade = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é off\n    this.defaultBitrate = 320; // MP3 320 kbps\n    this.fadeMs = 2; // –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–π –¥–µ-–∫–ª–∏–∫ —Ñ–µ–π–¥ –Ω–∞ —Å—Ç—ã–∫–∞—Ö (–Ω–µ —Å–ª—ã—à–Ω–æ, –Ω–æ —Å–ø–∞—Å–∞–µ—Ç –æ—Ç —â–µ–ª—á–∫–æ–≤)\n\n    // console.log('AudioExporter: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n  }\n\n  // –ì–ª–∞–≤–Ω—ã–π –≤—Ö–æ–¥: blockIds ‚Äî –º–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è\n  async exportBlocks({ blockIds, onProgress }) {\n    // console.log('AudioExporter: exportBlocks –≤—ã–∑–≤–∞–Ω —Å –±–ª–æ–∫–∞–º–∏:', blockIds); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    if (!Array.isArray(blockIds) || blockIds.length === 0) {\n      console.error('AudioExporter: –ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');\n      throw new Error('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');\n    }\n\n    // 1) –ü–æ–ª—É—á–∞–µ–º —Å—Ç–µ–º—ã (AudioBuffer)\n    // console.log('AudioExporter: –ü–æ–ª—É—á–µ–Ω–∏–µ stem-–±—É—Ñ–µ—Ä–æ–≤...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const { instBuf, vocBuf, sampleRate } = await this._getStemBuffers();\n    // console.log('AudioExporter: Stem-–±—É—Ñ–µ—Ä—ã –ø–æ–ª—É—á–µ–Ω—ã. Sample Rate:', sampleRate, 'Inst Buffer:', instBuf, 'Voc Buffer:', vocBuf); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 2) –°–µ–≥–º–µ–Ω—Ç—ã –∏–∑ –±–ª–æ–∫–æ–≤ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º\n    // console.log('AudioExporter: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏–∑ –±–ª–æ–∫–æ–≤...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const segments = this._buildSegmentsFromBlocks(blockIds);\n    // console.log('AudioExporter: –°–µ–≥–º–µ–Ω—Ç—ã –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã:', segments); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    if (segments.length === 0) {\n      console.error('AudioExporter: –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –±–ª–æ–∫–∞–º.');\n      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–≥–º–µ–Ω—Ç—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –±–ª–æ–∫–∞–º');\n    }\n\n    // 3) –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–µ–∫—É—â–µ–≥–æ –º–∏–∫—Å–∞\n    const rate = this.engine.getPlaybackRate ? this.engine.getPlaybackRate() : 1.0; // BPM coef (0.5..2.0)\n    const gI = this.engine.instrumentalGain?.gain?.value ?? 1.0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ\n    const gV = this.engine.vocalsGain?.gain?.value ?? 1.0; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ\n    // console.log('AudioExporter: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–∏–∫—Å–∞: Rate:', rate, 'Instrumental Gain:', gI, 'Vocals Gain:', gV); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 4) –û—Ü–µ–Ω–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏\n    const totalSrcSec = segments.reduce((acc, s) => acc + (s.end - s.start), 0);\n    const totalOutSec = totalSrcSec / Math.max(0.001, rate);\n    // console.log('AudioExporter: –ò—Å—Ö–æ–¥–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:', totalSrcSec, '–ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (—Å —É—á–µ—Ç–æ–º BPM):', totalOutSec); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    if (totalOutSec > this.maxDurationSec) {\n      console.error(`AudioExporter: –ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ${totalOutSec.toFixed(1)}—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ${this.maxDurationSec}—Å`);\n      throw new Error(`–ò—Ç–æ–≥–æ–≤–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ${totalOutSec.toFixed(1)}—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ${this.maxDurationSec}—Å`);\n    }\n\n    // 5) OfflineAudioContext –ø–æ–¥ –∏—Ç–æ–≥–æ–≤—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\n    const channels = 2;\n    const length = Math.ceil(this.sampleRate * totalOutSec);\n    // console.log('AudioExporter: –°–æ–∑–¥–∞–Ω–∏–µ OfflineAudioContext. –ö–∞–Ω–∞–ª—ã:', channels, '–î–ª–∏–Ω–∞ (—Å–µ–º–ø–ª–æ–≤):', length, 'Sample Rate:', this.sampleRate); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const off = new OfflineAudioContext(channels, length, this.sampleRate);\n\n    // –º–∞—Å—Ç–µ—Ä-–≥–µ–π–Ω—ã (–∫–∞–∫ –≤ –∂–∏–≤–æ–º –º–∏–∫—Å–µ)\n    const instMaster = off.createGain();\n    instMaster.gain.value = gI;\n    const vocMaster = off.createGain();\n    vocMaster.gain.value = gV;\n    instMaster.connect(off.destination);\n    vocMaster.connect(off.destination);\n    // console.log('AudioExporter: Master GainNodes —Å–æ–∑–¥–∞–Ω—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã.'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 6) –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ ¬´–≤—Å—Ç—ã–∫¬ª\n    let timeline = 0;\n    const fade = this.fadeMs / 1000;\n    // console.log('AudioExporter: –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    for (const seg of segments) {\n      // console.log('AudioExporter: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–∞:', seg); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      const srcDur = Math.max(0, seg.end - seg.start); // —Å–µ–∫—É–Ω–¥—ã –∏—Å—Ö–æ–¥–Ω–∏–∫–∞\n      if (srcDur <= 0) continue;\n      const outDur = srcDur / Math.max(0.001, rate);\n      // console.log(`AudioExporter: –°–µ–≥–º–µ–Ω—Ç ${seg.id} - Source Duration: ${srcDur.toFixed(2)}s, Output Duration: ${outDur.toFixed(2)}s`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n      // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª\n      if (instBuf) {\n        const src = off.createBufferSource();\n        src.buffer = instBuf;\n        src.playbackRate.value = rate;\n        const gain = off.createGain();\n        gain.gain.setValueAtTime(0, timeline);\n        gain.gain.linearRampToValueAtTime(1, timeline + fade);\n        gain.gain.setValueAtTime(1, timeline + Math.max(0, outDur - fade));\n        gain.gain.linearRampToValueAtTime(0, timeline + outDur);\n        src.connect(gain).connect(instMaster);\n        src.start(timeline, seg.start, srcDur);\n        // console.log(`AudioExporter: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π Source –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞ ${seg.id} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${timeline.toFixed(2)}s.`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      }\n\n      // –í–æ–∫–∞–ª\n      if (vocBuf) {\n        const src = off.createBufferSource();\n        src.buffer = vocBuf;\n        src.playbackRate.value = rate;\n        const gain = off.createGain();\n        gain.gain.setValueAtTime(0, timeline);\n        gain.gain.linearRampToValueAtTime(1, timeline + fade);\n        gain.gain.setValueAtTime(1, timeline + Math.max(0, outDur - fade));\n        gain.gain.linearRampToValueAtTime(0, timeline + outDur);\n        src.connect(gain).connect(vocMaster);\n        src.start(timeline, seg.start, srcDur);\n        // console.log(`AudioExporter: –í–æ–∫–∞–ª—å–Ω—ã–π Source –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞ ${seg.id} –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${timeline.toFixed(2)}s.`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      }\n      timeline += outDur;\n    }\n    // console.log('AudioExporter: –í—Å–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã. –û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–∞–π–º–ª–∞–π–Ω–∞:', timeline.toFixed(2), 's'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 7) –†–µ–Ω–¥–µ—Ä\n    // console.log('AudioExporter: –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const rendered = await off.startRendering();\n    // console.log('AudioExporter: –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω. –ü–æ–ª—É—á–µ–Ω AudioBuffer:', rendered); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 8) –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ MP3 320\n    // console.log('AudioExporter: –ó–∞–ø—É—Å–∫ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è MP3. Bitrate:', this.defaultBitrate); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const mp3Blob = await this._encodeToMp3(rendered, { bitrate: this.defaultBitrate, onProgress });\n    // console.log('AudioExporter: MP3 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–æ–ª—É—á–µ–Ω Blob:', mp3Blob); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    // 9) –ò–º—è —Ñ–∞–π–ª–∞\n    const filename = this._makeFileName();\n    // console.log('AudioExporter: –ò–º—è —Ñ–∞–π–ª–∞:', filename); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return { blob: mp3Blob, filename };\n  }\n\n  // –°–µ–≥–º–µ–Ω—Ç—ã –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º (—Ç–æ—á–Ω–æ –∫–∞–∫ –≤ BlockLoopControl._getBlockTimeRange)\n  _buildSegmentsFromBlocks(blockIds) {\n    // console.log('AudioExporter: _buildSegmentsFromBlocks - –í—Ö–æ–¥. blockIds:', blockIds); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const blocks = (this.lyricsDisplay && Array.isArray(this.lyricsDisplay.textBlocks)) ? this.lyricsDisplay.textBlocks : [];\n    // console.log('AudioExporter: _buildSegmentsFromBlocks - –î–æ—Å—Ç—É–ø–Ω—ã–µ textBlocks:', blocks); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const idSet = new Set(blockIds.map(String));\n    const ordered = blocks.filter(b => idSet.has(String(b.id)));\n    // console.log('AudioExporter: _buildSegmentsFromBlocks - –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –ø–æ id:', ordered); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const out = [];\n    for (const b of ordered) {\n      const r = this._getTimeRangeForBlock(b);\n      if (r && typeof r.startTime === 'number' && typeof r.endTime === 'number' && r.endTime > r.startTime) {\n        out.push({ start: r.startTime, end: r.endTime, id: b.id, name: b.name });\n        // console.log(`AudioExporter: _buildSegmentsFromBlocks - –î–æ–±–∞–≤–ª–µ–Ω —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –±–ª–æ–∫–∞ ${b.id}: ${r.startTime.toFixed(2)} - ${r.endTime.toFixed(2)}`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      } else {\n        console.warn(`AudioExporter: _buildSegmentsFromBlocks - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –±–ª–æ–∫–∞ ${b.id}. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);\n      }\n    }\n    // console.log('AudioExporter: _buildSegmentsFromBlocks - –í—ã—Ö–æ–¥. –†–µ–∑—É–ª—å—Ç–∞—Ç:', out); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return out;\n  }\n\n  // Fallback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤, –µ—Å–ª–∏ blockLoopControl._getBlockTimeRange –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n  _getTimeRangeForBlock(block) {\n    // console.log('AudioExporter: _getTimeRangeForBlock - –í—Ö–æ–¥. –ë–ª–æ–∫:', block); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    if (!this.markerManager) {\n      console.error('AudioExporter: _getTimeRangeForBlock - markerManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.');\n      return null;\n    }\n    const markers = this.markerManager.getMarkers();\n    if (!Array.isArray(markers) || markers.length === 0) {\n      console.warn('AudioExporter: _getTimeRangeForBlock - –ú–∞—Ä–∫–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã.');\n      return null;\n    }\n    // console.log('AudioExporter: _getTimeRangeForBlock - –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã:', markers.length); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    const firstLine = Math.min(...(block.lineIndices || []));\n    const lastLine = Math.max(...(block.lineIndices || []));\n    // console.log(`AudioExporter: _getTimeRangeForBlock - block.lineIndices: ${block.lineIndices}, firstLine: ${firstLine}, lastLine: ${lastLine}`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    let startM = markers.find(m => m.lineIndex === firstLine);\n    if (!startM) {\n      startM = markers.find(m => m.lineIndex >= firstLine);\n      if (startM) console.warn(`AudioExporter: _getTimeRangeForBlock - –¢–æ—á–Ω—ã–π —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ª–∏–Ω–∏–∏ ${firstLine} –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–ª–∏–∂–∞–π—à–∏–π: ${startM.lineIndex} –≤ ${startM.time.toFixed(2)}—Å.`);\n    }\n\n    let endM = markers.find(m => m.lineIndex > lastLine);\n    if (!endM) {\n      const dur = this.engine.getDuration ? this.engine.getDuration() : (this.engine.duration || 0);\n      if (dur > 0) {\n        endM = { time: dur };\n        console.warn(`AudioExporter: _getTimeRangeForBlock - –ö–æ–Ω–µ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä –¥–ª—è –ª–∏–Ω–∏–∏ ${lastLine} –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–µ–∫–∞: ${dur.toFixed(2)}—Å.`);\n      }\n    }\n\n    if (!startM || !endM) {\n      console.error('AudioExporter: _getTimeRangeForBlock - –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–ª–∏ –∫–æ–Ω–µ—á–Ω—ã–π –º–∞—Ä–∫–µ—Ä.');\n      return null;\n    }\n    \n    // console.log(`AudioExporter: _getTimeRangeForBlock - –ù–∞–π–¥–µ–Ω—ã –º–∞—Ä–∫–µ—Ä—ã: Start ${startM.time.toFixed(2)}s (line ${startM.lineIndex || 'N/A'}), End ${endM.time.toFixed(2)}s (line ${endM.lineIndex || 'N/A'}).`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return { startTime: startM.time, endTime: endM.time };\n  }\n\n\n  // –ü–æ–ª—É—á–∞–µ–º AudioBuffer –¥–ª—è —Å—Ç–µ–º–æ–≤: IndexedDB ‚Üí fallback –Ω–∞ –≥–∏–±—Ä–∏–¥–Ω—ã–µ URL\n  async _getStemBuffers() {\n    // console.log('AudioExporter: _getStemBuffers - –í—Ö–æ–¥.'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const srcInst = this.engine?.hybridEngine?.originalInstrumentalUrl || this.engine?.hybridEngine?.instrumentalUrl;\n    const srcVoc = this.engine?.hybridEngine?.originalVocalsUrl || this.engine?.hybridEngine?.vocalsUrl;\n    // console.log('AudioExporter: _getStemBuffers - Instrumental URL:', srcInst, 'Vocals URL:', srcVoc); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    const [instBuf, vocBuf] = await Promise.all([\n      srcInst ? this._fetchDecodeToBuffer(srcInst, 'Instrumental') : Promise.resolve(null),\n      srcVoc ? this._fetchDecodeToBuffer(srcVoc, 'Vocals') : Promise.resolve(null),\n    ]);\n    // console.log('AudioExporter: _getStemBuffers - –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä—ã: Instrumental:', instBuf ? '–µ—Å—Ç—å' : '–Ω–µ—Ç', 'Vocals:', vocBuf ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n\n    const sr = (instBuf && instBuf.sampleRate) || (vocBuf && vocBuf.sampleRate) || this.sampleRate;\n    // console.log('AudioExporter: _getStemBuffers - –ò—Ç–æ–≥–æ–≤—ã–π sampleRate:', sr); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return { instBuf, vocBuf, sampleRate: sr };\n  }\n\n  async _fetchDecodeToBuffer(url, type = 'Unknown') {\n    // console.log(`AudioExporter: _fetchDecodeToBuffer - –ó–∞–ø—Ä–æ—Å –∏ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ${type} –∏–∑ URL:`, url); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    try {\n      const res = await fetch(url);\n      if (!res.ok) {\n        throw new Error(`Fetch failed ${res.status} ${res.statusText}`);\n      }\n      const arr = await res.arrayBuffer();\n      // console.log(`AudioExporter: _fetchDecodeToBuffer - ${type} ArrayBuffer –ø–æ–ª—É—á–µ–Ω, —Ä–∞–∑–º–µ—Ä: ${arr.byteLength} –±–∞–π—Ç.`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      // –º–∞–ª–µ–Ω—å–∫–∏–π offline-–∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è decode\n      const tmp = new OfflineAudioContext(2, 2, 44100);\n      const buf = await tmp.decodeAudioData(arr);\n      // console.log(`AudioExporter: _fetchDecodeToBuffer - ${type} AudioBuffer –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω. –ö–∞–Ω–∞–ª—ã: ${buf.numberOfChannels}, SampleRate: ${buf.sampleRate}, –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${buf.duration.toFixed(2)}s.`); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      return buf;\n    } catch (e) {\n      console.error(`AudioExporter: _fetchDecodeToBuffer - –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏ ${type} –∏–∑ ${url}:`, e);\n      throw e;\n    }\n  }\n\n  _makeFileName() {\n    // console.log('AudioExporter: _makeFileName - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞...'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    const title = (window.trackCatalog?.tracks?.[window.trackCatalog.currentTrackIndex]?.title) || 'belive_export';\n    // –õ–∞–∫–æ–Ω–∏—á–Ω–æ, –∫–∞–∫ –ø—Ä–æ—Å–∏–ª: —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ BPM, –µ—Å–ª–∏ –Ω–µ 100\n    const rate = this.engine.getPlaybackRate ? this.engine.getPlaybackRate() : 1.0;\n    const bpmSuffix = Math.abs(rate - 1.0) < 0.001 ? '' : `__BPM${Math.round(rate * 100)}`;\n    const filename = `${title}${bpmSuffix}.mp3`;\n    // console.log('AudioExporter: _makeFileName - –ò–º—è —Ñ–∞–π–ª–∞:', filename); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return filename;\n  }\n\n  // üéØ –ù–û–í–û–ï: –ú–µ—Ç–æ–¥ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è AudioBuffer –≤ WAV Blob (–¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ü–µ–ª–µ–π)\n  _encodeWav(left, right, sampleRate) {\n    const numChannels = (left && right) ? 2 : 1; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤\n    const numSamples = left.length;\n    const dataLength = numSamples * numChannels * 2; // 2 –±–∞–π—Ç–∞ –Ω–∞ —Å—ç–º–ø–ª (Int16)\n    const buffer = new ArrayBuffer(44 + dataLength); // WAV-—Ö–µ–¥–µ—Ä 44 –±–∞–π—Ç–∞\n    const view = new DataView(buffer);\n\n    function writeString(view, offset, string) {\n      for (let i = 0; i < string.length; i++) {\n        view.setUint8(offset + i, string.charCodeAt(i));\n      }\n    }\n\n    let offset = 0;\n    /* Chunk ID */ writeString(view, offset, 'RIFF'); offset += 4;\n    /* Chunk Size */ view.setUint32(offset, 36 + dataLength, true); offset += 4;\n    /* Format */ writeString(view, offset, 'WAVE'); offset += 4;\n    /* Subchunk1 ID */ writeString(view, offset, 'fmt '); offset += 4;\n    /* Subchunk1 Size */ view.setUint32(offset, 16, true); offset += 4;\n    /* Audio Format */ view.setUint16(offset, 1, true); offset += 2;\n    /* Num Channels */ view.setUint16(offset, numChannels, true); offset += 2;\n    /* Sample Rate */ view.setUint32(offset, sampleRate, true); offset += 4;\n    /* Byte Rate */ view.setUint32(offset, sampleRate * numChannels * 2, true); offset += 4;\n    /* Block Align */ view.setUint16(offset, numChannels * 2, true); offset += 2;\n    /* Bits Per Sample */ view.setUint16(offset, 16, true); offset += 2;\n    /* Subchunk2 ID */ writeString(view, offset, 'data'); offset += 4;\n    /* Subchunk2 Size */ view.setUint32(offset, dataLength, true); offset += 4;\n\n    // –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (Float32Array –≤ Int16Array)\n    function floatTo16BitPCM(output, offset, input) {\n      for (let i = 0; i < input.length; i++, offset += 2) {\n        let s = Math.max(-1, Math.min(1, input[i]));\n        output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);\n      }\n    }\n\n    floatTo16BitPCM(view, offset, left);\n    if (numChannels === 2) {\n      // –ï—Å–ª–∏ —Å—Ç–µ—Ä–µ–æ, —á–µ—Ä–µ–¥—É–µ–º —Å—ç–º–ø–ª—ã\n      let lOffset = 0;\n      let rOffset = 0;\n      for (let i = 0; i < numSamples; i++) {\n        let sL = Math.max(-1, Math.min(1, left[i]));\n        let sR = Math.max(-1, Math.min(1, right[i]));\n        view.setInt16(offset, sL < 0 ? sL * 0x8000 : sL * 0x7FFF, true); offset += 2;\n        view.setInt16(offset, sR < 0 ? sR * 0x8000 : sR * 0x7FFF, true); offset += 2;\n      }\n    } else {\n      // –ï—Å–ª–∏ –º–æ–Ω–æ, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–µ–≤—ã–π –∫–∞–Ω–∞–ª\n      for (let i = 0; i < numSamples; i++) {\n        let sL = Math.max(-1, Math.min(1, left[i]));\n        view.setInt16(offset, sL < 0 ? sL * 0x8000 : sL * 0x7FFF, true); offset += 2;\n      }\n    }\n\n    return new Blob([buffer], { type: 'audio/wav' });\n  }\n\n  async _encodeToMp3(audioBuffer, { bitrate = 320, onProgress }) {\n    // console.log('AudioExporter: _encodeToMp3 - –í—Ö–æ–¥. AudioBuffer:', audioBuffer, 'Bitrate:', bitrate); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    return new Promise((resolve, reject) => {\n      // console.log('AudioExporter: _encodeToMp3 - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ Web Worker –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è.'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n      try {\n        const worker = new Worker('js/workers/mp3-encoder.worker.js');\n        const CHUNK = 1152; // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–ª–æ–∫ lamejs\n        const l = audioBuffer.getChannelData(0);\n        const r = audioBuffer.numberOfChannels > 1 ? audioBuffer.getChannelData(1) : audioBuffer.getChannelData(0); // –ú–æ–Ω–æ -> —Å—Ç–µ—Ä–µ–æ\n        let pos = 0;\n        const parts = [];\n\n        const floatTo16 = (f32) => {\n          const i16 = new Int16Array(f32.length);\n          for (let i = 0; i < f32.length; i++) {\n            let s = Math.max(-1, Math.min(1, f32[i]));\n            i16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;\n          }\n          return i16;\n        };\n\n        worker.onmessage = (e) => {\n          const msg = e.data || {};\n          if (msg.type === 'data' && msg.buffer) {\n            parts.push(new Uint8Array(msg.buffer));\n          } else if (msg.type === 'done' && msg.buffer) {\n            parts.push(new Uint8Array(msg.buffer));\n            const out = new ArrayBuffer(parts.reduce((acc, p) => acc + p.length, 0));\n            let offset = 0;\n            for (const p of parts) { new Uint8Array(out, offset, p.length).set(p); offset += p.length; }\n            worker.terminate();\n            resolve(out);\n          } else if (msg.type === 'error') {\n            worker.terminate();\n            reject(new Error(msg.message || 'MP3 worker error'));\n          } else if (msg.type === 'progress' && onProgress) {\n            onProgress(msg.progress);\n          }\n        };\n\n        worker.postMessage({ type: 'init', numChannels: audioBuffer.numberOfChannels, sampleRate: audioBuffer.sampleRate, bitrate });\n\n        const pump = () => {\n          if (pos >= l.length) {\n            worker.postMessage({ type: 'flush' });\n            return;\n          }\n          const end = Math.min(l.length, pos + CHUNK);\n          const l16 = floatTo16(l.subarray(pos, end));\n          const r16 = floatTo16(r.subarray(pos, end));\n          pos = end;\n          worker.postMessage({ type: 'encode', left: l16, right: r16 }, [l16.buffer, r16.buffer]);\n          // –ß—É—Ç—å —Ä–∞–∑–≥—Ä—É–∑–∏–º –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫\n          setTimeout(pump, 0);\n        };\n        pump();\n\n      } catch (e) {\n        console.error('AudioExporter: _encodeToMp3 - –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–ª–∏ –∑–∞–ø—É—Å–∫–µ Worker\\'–∞:', e);\n        reject(new Error(`Failed to create or start MP3 worker: ${e.message}`));\n      }\n    });\n  }\n\n  // –î–æ–±–∞–≤—å –≤ –∫–ª–∞—Å—Å –ø—Ä–æ—Å—Ç–æ–π –∞–¥–∞–ø—Ç–µ—Ä –∫ –≤–∞—à–µ–º—É mp3 worker'—É\n  async _encodeMp3WithWorker({ left, right, sampleRate, bitrate = 320 }) {\n    return new Promise((resolve, reject) => {\n      const worker = new Worker('js/workers/mp3-encoder.worker.js');\n      const CHUNK = 1152 * 20; // –ø–∞—á–∫–∞–º–∏ –ø–æ ~20 —Ñ—Ä–µ–π–º–æ–≤\n      const l = left;\n      const r = right.length === left.length ? right : new Float32Array(left.length); // —Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ –º–æ–Ω–æ: –µ—Å–ª–∏ right –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –±—É—Ñ–µ—Ä\n      let pos = 0;\n      const parts = [];\n      let ready = false; // –§–ª–∞–≥ –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è —Å worker-–æ–º\n\n      worker.onmessage = (e) => {\n        const msg = e.data || {};\n        const t = msg.type || msg.command; // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±–∞\n        if (t === 'inited') {\n          ready = true; // Worklet –≥–æ—Ç–æ–≤, –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å pump\n          pump();\n        } else if (t === 'data' && msg.buffer) {\n          parts.push(new Uint8Array(msg.buffer));\n        } else if (t === 'done' && msg.buffer) {\n          parts.push(new Uint8Array(msg.buffer));\n          const out = new Blob(parts, { type: 'audio/mpeg' });\n          worker.terminate();\n          resolve(out);\n        } else if (t === 'error') {\n          worker.terminate();\n          reject(new Error(msg.message || 'MP3 worker error'));\n        }\n      };\n\n      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º INIT, –æ–∂–∏–¥–∞–µ–º inited –¥–ª—è —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è\n      worker.postMessage({ command: 'init', numChannels: 2, sampleRate, bitrate });\n\n      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ _floatTo16 –∏–∑ –∫–ª–∞—Å—Å–∞ AudioExporter\n      const floatTo16 = (f32) => {\n        const i16 = new Int16Array(f32.length);\n        for (let i = 0; i < f32.length; i++) {\n          let s = Math.max(-1, Math.min(1, f32[i]));\n          i16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;\n        }\n        return i16;\n      };\n\n      const pump = () => {\n        if (!ready) return; // –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ ready –æ—Ç worker-–∞\n        if (pos >= l.length) {\n          worker.postMessage({ command: 'flush' });\n          return;\n        }\n        const end = Math.min(l.length, pos + CHUNK);\n        const subL = l.subarray(pos, end); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–º–∞—Å—Å–∏–≤\n        const subR = r.subarray(pos, end); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–º–∞—Å—Å–∏–≤\n\n        if (subL.length === 0) {\n          pos = end; // –ü–µ—Ä–µ–¥–≤–∏–≥–∞–µ–º pos, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞\n          setTimeout(pump, 0); // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º pump\n          return;\n        }\n\n        const l16 = floatTo16(subL);\n        const r16 = floatTo16(subR);\n        pos = end;\n        // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ transfer'–∏–º, —Ç.–∫. —ç—Ç–æ –Ω–æ–≤—ã–µ –±—É—Ñ–µ—Ä—ã\n        worker.postMessage({ command: 'encode', left: l16, right: r16 }, [l16.buffer, r16.buffer]);\n        // –ß—É—Ç—å —Ä–∞–∑–≥—Ä—É–∑–∏–º –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫\n        setTimeout(pump, 0);\n      };\n      // pump() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è 'inited' –æ—Ç worker-–∞\n    });\n  }\n\n  // --- MP3 Worker –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è exportBlocksRealtime) ---\n  async _initMp3Worker(sampleRate, bitrate) {\n    if (this.mp3Worker) {\n      this.mp3Worker.terminate();\n    }\n    this.mp3Worker = new Worker('js/workers/mp3-encoder.worker.js');\n    this.mp3WorkerPromise = new Promise((resolve, reject) => {\n      this.mp3Worker.onmessage = (e) => {\n        if (e.data.type === 'inited') {\n          resolve();\n        } else if (e.data.type === 'error') {\n          reject(new Error(e.data.message || 'MP3 worker init error'));\n        }\n      };\n      this.mp3Worker.onerror = (e) => reject(new Error(e.message || 'MP3 worker error'));\n      this.mp3Worker.postMessage({ type: 'init', numChannels: 2, sampleRate, bitrate });\n    });\n    return this.mp3WorkerPromise;\n  }\n\n  async _flushMp3Worker() {\n    return new Promise((resolve, reject) => {\n      if (!this.mp3Worker) return reject(new Error('MP3 worker not active.'));\n\n      const mp3Data = [];\n      this.mp3Worker.onmessage = (e) => {\n        if (e.data.type === 'data' && e.data.buffer) {\n          mp3Data.push(new Uint8Array(e.data.buffer));\n        } else if (e.data.type === 'done' && e.data.buffer) {\n          mp3Data.push(new Uint8Array(e.data.buffer));\n          this.mp3Worker.terminate();\n          this.mp3Worker = null;\n          resolve(mp3Data);\n        } else if (e.data.type === 'error') {\n          this.mp3Worker.terminate();\n          this.mp3Worker = null;\n          reject(new Error(e.data.message || 'MP3 worker flush error'));\n        }\n      };\n      this.mp3Worker.onerror = (e) => {\n        this.mp3Worker.terminate();\n        this.mp3Worker = null;\n        reject(new Error(e.message || 'MP3 worker error during flush'));\n      };\n      this.mp3Worker.postMessage({ type: 'flush' });\n    });\n  }\n  // --- –ö–æ–Ω–µ—Ü MP3 Worker –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---\n\n  async _probeWorkletAndGraph(ac) {\n    if (!ac) {\n      ac = this.ac || this.engine.audioContext; // –ò—Å–ø–æ–ª—å–∑—É–µ–º this.ac –∏–ª–∏ this.engine.audioContext\n    }\n    // 1) –ö–æ–Ω—Ç–µ–∫—Å—Ç\n    if (!ac) throw new Error('AudioContext not found');\n    if (ac.state !== 'running') {\n      try { await ac.resume(); } catch (e) {\n        console.error('[Probe] resume failed', e); throw e;\n      }\n    }\n    // 2) –ú–æ–¥—É–ª—å –≤–æ—Ä–∫–ª–µ—Ç–∞\n    try {\n      await ac.audioWorklet.addModule('js/worklets/recorder-processor.js');\n    } catch (e) {\n      if (!String(e.message||'').includes('already')) throw e;\n    }\n    // 3) –õ–æ–∫–∞–ª—å–Ω—ã–µ, –ù–ï –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –∏–º–µ–Ω–∞\n    const probeExportSum = ac.createGain(); probeExportSum.gain.value = 1;\n    const probeRecNode = new AudioWorkletNode(ac, 'recorder-processor', {\n      processorOptions: { channels: 2, chunkFrames: 16384 }\n    });\n    this.DEBUG && console.log('[Probe] Checkpoint 3.1: probeExportSum and probeRecNode created');\n\n    probeExportSum.connect(probeRecNode);\n    this.DEBUG && console.log('[Probe] Checkpoint 3.2: probeExportSum connected to probeRecNode');\n\n    const probeSink = ac.createGain(); probeSink.gain.value = 0;\n    probeRecNode.connect(probeSink).connect(ac.destination);\n    this.DEBUG && console.log('[Probe] Checkpoint 3.3: probeRecNode connected to probeSink and ac.destination');\n\n    // –°—á—ë—Ç—á–∏–∫–∏ —á–∞–Ω–∫–æ–≤\n    let probeChunks = 0; let probeFrames = 0;\n    const onMsg = (e) => {\n      const m = e.data || {};\n      if (m.type === 'chunk' && m.buffers) {\n        probeChunks++;\n        // –¥–ª–∏–Ω–∞ –≤ —Å—ç–º–ø–ª–∞—Ö: byteLength/4 –¥–ª—è Float32Array\n        probeFrames += (m.buffers[0]?.byteLength || 0) / 4;\n      }\n    };\n    probeRecNode.port.addEventListener('message', onMsg);\n    probeRecNode.port.start?.();\n    // 4) –ì–µ–Ω–µ—Ä–∏–º –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–æ–Ω (0.3—Å)\n    const probeOsc = ac.createOscillator();\n    const probeG = ac.createGain(); probeG.gain.value = 0.12;\n    probeOsc.connect(probeG).connect(probeExportSum);\n    probeOsc.start();\n    probeOsc.stop(ac.currentTime + 0.3);\n    // –∂–¥—ë–º –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã\n    await new Promise(r => setTimeout(r, 500));\n    // 5) –û—á–∏—Å—Ç–∫–∞\n    try { probeOsc.disconnect(); probeG.disconnect(); } catch(_){}\n    // –¥–∞—ë–º –≤–æ—Ä–∫–ª–µ—Ç—É –≤—ã—Å–ª–∞—Ç—å —Ö–≤–æ—Å—Ç\n    await new Promise(r => setTimeout(r, 40));\n    try { probeRecNode.port.removeEventListener('message', onMsg); } catch(_){}\n    try {\n      probeRecNode.port.postMessage({ type:'flush' });\n      await new Promise(r => setTimeout(r, 40));\n      probeRecNode.port.postMessage({ type:'stop' });\n      await new Promise(r => setTimeout(r, 40));\n    } catch(_){}\n    try { probeExportSum.disconnect(); } catch(_){}\n    try { probeRecNode.disconnect(); } catch(_){}\n    try { probeSink.disconnect(); } catch(_){}\n    return { probeChunks, probeFrames };\n  }\n\n  /**\n   * –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∞—É–¥–∏–æ –≤ MP3/WAV –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ —Å –±–µ—Å—à–æ–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏.\n   * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç A/B –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∏–Ω–≥ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏.\n   * @param {object} options - –û–ø—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞.\n   * @param {string[]} options.blockIds - –ú–∞—Å—Å–∏–≤ ID –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.\n   * @param {function(number):void} options.onProgress - –ö–æ–ª–±—ç–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (0-1).\n   * @param {'wav'|'mp3'} [options.format='wav'] - –§–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞.\n   * @param {number} [options.bitrate=320] - –ë–∏—Ç—Ä–µ–π—Ç –¥–ª—è MP3.\n   * @param {boolean} [options.muteDuringExport=false] - –ì–ª—É—à–∏—Ç—å –ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤–æ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞.\n   * @returns {Promise<{blob: Blob, durationSec: number, sampleRate: number, channels: number, format: string, filename: string}>} - –ü—Ä–æ–º–∏—Å —Å Blob —Ñ–∞–π–ª–∞.\n   */\n  async exportBlocksRealtime({ blockIds, onProgress, format = 'wav', bitrate = 320, muteDuringExport = false }) {\n    // 0) –ë–∞–∑–æ–≤—ã–µ —Å—Å—ã–ª–∫–∏, —Å—Ä–∞–∑—É –Ω–∞–≤–µ—Ä—Ö (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ TDZ)\n    const engine = this.engine;\n    if (!engine) throw new Error('[Exporter] engine not found');\n\n    this._exportAbortController = new AbortController();\n    const { signal } = this._exportAbortController;\n\n    this.DEBUG && console.log('[Exporter] Checkpoint 0.5: this.engine at start of exportBlocksRealtime:', this.engine, 'this.engine.audioContext:', this.engine?.audioContext);\n\n    // üéØ –ù–û–í–û–ï: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º this.ac –∑–¥–µ—Å—å, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –±—ã–ª –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω\n    if (!this.ac) {\n      this.ac = this.engine.audioContext;\n    }\n    const ac = this.ac; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞\n    if (!ac) throw new Error('[Exporter] AudioContext not found');\n\n    if (this.isExporting) {\n      console.warn('AudioExporter: –≠–∫—Å–ø–æ—Ä—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω.');\n      return;\n    }\n    this.isExporting = true;\n\n    this.DEBUG && console.log('[Exporter] Checkpoint 1: exportBlocksRealtime called');\n\n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è AudioContext\n    if (ac.state !== 'running') {\n      try {\n        await ac.resume();\n        this.DEBUG && console.log('[Exporter] AudioContext resumed:', ac.state);\n      } catch (e) {\n        console.error('[Exporter] ac.resume() failed', e);\n        throw e;\n      }\n    }\n\n    // –ó–∞–ø—É—Å–∫–∞–µ–º probe —Ç–æ–ª—å–∫–æ –≤ DEBUG\n    if (this.DEBUG) {\n      try {\n        this.DEBUG && console.log('[Exporter] Checkpoint 1.3: Calling _probeWorkletAndGraph');\n        const { probeChunks, probeFrames } = await this._probeWorkletAndGraph(ac);\n        console.log(`[Probe] chunks=${probeChunks} frames=${probeFrames}`);\n        if (probeChunks === 0) console.warn('Probe returned 0 chunks ‚Äî check worklet path/name later');\n      } catch (e) {\n        console.error('[Exporter] Checkpoint 1.4: probe error (non-fatal):', e);\n        // –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–ª—å—à–µ ‚Äî —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å UI\n      }\n    }\n\n    // üéØ –ù–û–í–û–ï: –í—Ä–µ–º–µ–Ω–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ WAV –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ UI —Å–∫–∞—á–∏–≤–∞–Ω–∏—è\n    if (this.DEBUG && format === 'wav' && blockIds?.length) {\n      const sr = ac.sampleRate;\n      const N = Math.floor(sr * 0.5);\n      const L = new Float32Array(N), R = new Float32Array(N);\n      for (let i = 0; i < N; i++) { const t = i / sr; const s = Math.sin(2 * Math.PI * 440 * t) * 0.2; L[i] = s; R[i] = s; }\n      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è WAV, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ\n      const testBlob = this._encodeWav(L, R, sr);\n      console.log('[Exporter] TEST WAV created, size:', testBlob.size);\n      return { blob: testBlob, durationSec: 0.5, sampleRate: sr, channels: 2, format: 'wav', filename: 'test-beep.wav' };\n    }\n\n    // Load worklet once\n    try {\n      await ac.audioWorklet.addModule('js/worklets/recorder-processor.js');\n    } catch (e) {\n      if (!String(e.message || '').includes('already')) throw e;\n      this.DEBUG && console.log('[Exporter] Recorder processor already loaded');\n    }\n\n    // –°–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–∑ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –¥–≤–∏–∂–∫–∞ –∏ HTMLAudioElement\n    const he = engine?.hybridEngine || {};\n    this.DEBUG && console.log('[Exporter] Checkpoint 2.0: Hybrid Engine properties:', {\n      originalInstrumentalUrl: he.originalInstrumentalUrl,\n      instrumentalUrl: he.instrumentalUrl,\n      engineInstrumentalAudioSrc: engine?.instrumentalAudio?.src // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    });\n    const pickFirst = (...cands) => {\n      for (const v of cands) if (v && typeof v === 'string' && v.trim()) return v;\n      return null;\n    };\n\n    let instrumentalSrcUrl = pickFirst(\n      he.originalInstrumentalUrl,\n      he.instrumentalUrl,\n      engine?.instrumentalAudio?.src // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    );\n    let vocalsSrcUrl = pickFirst(\n      he.originalVocalsUrl,\n      he.vocalsUrl,\n      engine?.vocalsAudio?.src // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    );\n\n    this.DEBUG && console.log('[Exporter] Checkpoint 2.1: Initial instrumentalSrcUrl:', instrumentalSrcUrl);\n    this.DEBUG && console.log('[Exporter] Checkpoint 2.2: Initial vocalsSrcUrl:', vocalsSrcUrl);\n\n    // –í–∞–∂–Ω–æ: –Ω–µ –∫–∏–¥–∞–µ–º —Å—Ä–∞–∑—É throw, –∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–æ–∂–¥–∞—Ç—å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç\n    if (!instrumentalSrcUrl) {\n      const instEl = engine?.instrumentalAudio; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n      if (instEl) {\n        await new Promise(res => {\n          if (instEl.readyState >= 2 && instEl.src) return res();\n          const onMeta = () => { instEl.removeEventListener('loadedmetadata', onMeta); res(); };\n          instEl.addEventListener('loadedmetadata', onMeta);\n          // –∑–∞–ø–∞—Å–Ω–æ–π —Ç–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–∏–¥–µ—Ç\n          setTimeout(res, 500);\n        });\n        // –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è\n        instrumentalSrcUrl = pickFirst(\n          he.originalInstrumentalUrl,\n          he.instrumentalUrl,\n          engine?.instrumentalAudio?.src // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n        );\n      }\n    }\n\n    if (!instrumentalSrcUrl) {\n      console.error('[Exporter] –ù–µ—Ç URL –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∞ (hybridEngine/element).');\n      this.isExporting = false;\n      this._exportAbortController = null;\n      throw new Error('–ù–µ—Ç URL –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª–∞: –∏—Å—Ç–æ—á–Ω–∏–∫ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 1‚Äì2 —Å–µ–∫—É–Ω–¥—ã.');\n    }\n\n    // –ï—Å–ª–∏ –≤–æ–∫–∞–ª–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º –±–µ–∑ –≤–æ–∫–∞–ª–∞, –Ω–µ –ø–∞–¥–∞–µ–º.\n    // vocalsSrcUrl —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n    // –°–æ–∑–¥–∞—ë–º –æ–±—â–∏–π —Å—É–º–º–∞—Ç–æ—Ä –∏ recNode\n    const exportSum = ac.createGain(); exportSum.gain.value = 1;\n    const recNode = new AudioWorkletNode(ac, 'recorder-processor', {\n      processorOptions: { channels: 2, chunkFrames: 16384 }\n    });\n    exportSum.connect(recNode);\n    const sink = ac.createGain(); sink.gain.value = 0;\n    recNode.connect(sink).connect(ac.destination);\n\n    // –ö–æ–ª–ª–µ–∫—Ç–æ—Ä —á–∞–Ω–∫–æ–≤ (WAV –ø—É—Ç—å)\n    const chunksL = [], chunksR = [];\n    recNode.port.onmessage = (e) => {\n      const m = e.data||{};\n      if (m.type==='chunk' && m.buffers) {\n        chunksL.push(new Float32Array(m.buffers[0]));\n        chunksR.push(new Float32Array(m.buffers[1]));\n      }\n    };\n\n    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ MP3 Worker (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑-–ø–æ–¥ try/catch)\n    if (format === 'mp3') {\n      await this._initMp3Worker(ac.sampleRate, bitrate);\n    }\n\n    const blocks = (this.lyricsDisplay && Array.isArray(this.lyricsDisplay.textBlocks))\n      ? this.lyricsDisplay.textBlocks\n      : [];\n\n    const allTextBlocks = blocks; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ blocks\n    const blocksToExport = blockIds.map(id => allTextBlocks.find(b => String(b.id) === id)).filter(Boolean);\n    if (blocksToExport.length === 0) {\n      throw new Error('–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');\n    }\n\n    let totalOutSec = 0;\n    let playedOutSec = 0;\n    let tCursor = ac.currentTime + 0.12; // —Å (Safari –ª—é–±–∏—Ç 0.12) // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    const finalFadeInCurve = scaleCurve(makeSinCurve(256), 0.7);\n    const finalFadeOutCurve = scaleCurve(makeCosCurve(256), 0.7);\n\n    // –ì–ª—É—à–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤–æ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ\n    if (muteDuringExport) {\n      if (engine.instrumentalAudio) engine.instrumentalAudio.muted = true; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n      if (engine.vocalsAudio) engine.vocalsAudio.muted = true; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n      if (this.DEBUG) console.log('AudioExporter: –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–µ–Ω.');\n    }\n\n    // –ü–∞—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (—á–µ—Ä–µ–¥—É—é—Ç—Å—è A/B)\n    // –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ü–∏–∫–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–¥–Ω–µ–µ\n\n    // üéØ –ù–û–í–û–ï: –°–æ–∑–¥–∞—ë–º –∏ –ø–æ–¥–∫–ª—é—á–∞–µ–º A‚Äë—Å–ª–æ—Ç (—É–ø—Ä–æ—â—ë–Ω–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)\n    const instUrl = instrumentalSrcUrl; // –£–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –Ω–µ null\n\n    // Helper function moved to global scope (createEl)\n    const elA = createEl(instUrl, rate); // rate –ø—Ä–∏—Ö–æ–¥–∏—Ç –∏–∑ options.rate ?? 1\n    await new Promise(res => { if (elA.readyState >= 2) return res(); elA.addEventListener('loadedmetadata', res, {once:true}); });\n    const srcA = ac.createMediaElementSource(elA);\n    const gA = ac.createGain(); gA.gain.value = (options.instrumentalGain ?? 1) * 0.8; // —á—É—Ç—å —Ç–∏—à–µ\n    srcA.connect(gA).connect(exportSum);\n\n    // –ø—Ä–æ–∏–≥—Ä–∞–µ–º 1.2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –ø—Ä–æ–±—ã WAV\n    try { if (elA.paused) await elA.play(); } catch(e) { console.error('elA.play failed', e); }\n    await new Promise(r => setTimeout(r, 1200));\n\n    // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —Ñ–ª—É—à–∏–º –≤–æ—Ä–∫–ª–µ—Ç\n    try { elA.pause(); } catch(_){}\n    recNode.port.postMessage({ type:'flush' }); await new Promise(r => setTimeout(r, 80));\n    recNode.port.postMessage({ type:'stop'  }); await new Promise(r => setTimeout(r, 80));\n\n    // –∫–æ–Ω–∫–∞—Ç\n    const concatF32 = (arrs)=>{ let total=0; for(const a of arrs) total+=a.length; const out=new Float32Array(total); let off=0; for(const a of arrs){ out.set(a,off); off+=a.length; } return out; };\n    const L = concatF32(chunksL), R = concatF32(chunksR);\n\n    // –∫–æ–¥–∏—Ä—É–µ–º WAV –¥–ª—è —Ç–µ—Å—Ç–∞\n    const wav = this._encodeWav(L, R, ac.sampleRate);\n    console.log('[Exporter] WAV built from A-slot, size:', wav.size);\n\n    // –æ—Ç–¥–∞—ë–º\n    return { blob: wav, durationSec: L.length / ac.sampleRate, sampleRate: ac.sampleRate, channels: 2, format: 'wav', filename: 'a-slot.wav' };\n\n    // –£–î–ê–õ–ï–ù–û –≤—Ä–µ–º–µ–Ω–Ω–æ: A/B –ø–∞—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (—á–µ—Ä–µ–¥—É—é—Ç—Å—è A/B)\n    // let currentInstPair = { el: createEl(instrumentalSrcUrl, rate), gain: ac.createGain() };\n    // let nextInstPair = { el: createEl(instrumentalSrcUrl, rate), gain: ac.createGain() };\n    // let currentVocPair = null;\n    // let nextVocPair = null;\n\n    // if (vocalsSrcUrl) {\n    //   currentVocPair = { el: createEl(vocalsSrcUrl, rate), gain: ac.createGain() };\n    //   nextVocPair = { el: createEl(vocalsSrcUrl, rate), gain: ac.createGain() };\n    // }\n\n    // const allPairs = [\n    //   { el: currentInstPair.el, src: null, gain: currentInstPair.gain },\n    //   { el: nextInstPair.el, src: null, gain: nextInstPair.gain },\n    // ];\n    // if (currentVocPair) allPairs.push({ el: currentVocPair.el, src: null, gain: currentVocPair.gain });\n    // if (nextVocPair) allPairs.push({ el: nextVocPair.el, src: null, gain: nextVocPair.gain });\n\n    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MediaElementSource –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä\n    // for (const pair of allPairs) {\n    //   await new Promise(res => {\n    //     if (pair.el.readyState >= 2 && pair.el.src) return res();\n    //     const onMeta = () => { pair.el.removeEventListener('loadedmetadata', onMeta); res(); };\n    //     pair.el.addEventListener('loadedmetadata', onMeta);\n    //     setTimeout(res, 500); // –ó–∞–ø–∞—Å–Ω–æ–π —Ç–∞–π–º–∞—É—Ç\n    //   });\n    //   pair.src = ac.createMediaElementSource(pair.el);\n    //   pair.src.connect(pair.gain).connect(exportSum);\n    //   pair.gain.gain.value = 0; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ 0\n    // }\n\n    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–ª—è Gain Node\n    // const originalInstGain = engine.instrumentalGainNode?.gain.value || 1;\n    // const originalVocGain = engine.vocalsGainNode?.gain.value || 1;\n\n    // try {\n    //   // AudioWorklet –¥–ª—è –∑–∞–ø–∏—Å–∏ PCM\n    //   // await ac.audioWorklet.addModule('js/worklets/recorder-processor.js');\n    //   // if (this.DEBUG) console.log('AudioExporter: AudioWorklet module added.');\n\n    //   // –û–±—â–∞—è —à–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤, –∏–¥—É—â–∏—Ö –Ω–∞ –∑–∞–ø–∏—Å—å\n    //   // let exportSum = ac.createGain();\n    //   // exportSum.channelCount = 2;\n    //   // exportSum.channelCountMode = 'explicit';\n    //   // exportSum.channelInterpretation = 'speakers';\n\n    //   // –ü–æ–¥–∫–ª—é—á–∞–µ–º A/B –ø–∞—Ä—ã –∫ exportSum\n    //   // instPair.srcA.connect(instPair.gA).connect(exportSum);\n    //   // instPair.srcB.connect(instPair.gB).connect(exportSum);\n    //   // if (vocPair) {\n    //   //   vocPair.srcA.connect(vocPair.gA).connect(exportSum);\n    //   //   vocPair.srcB.connect(vocPair.gB).connect(exportSum);\n    //   // }\n\n    //   // RecorderProcessor\n    //   // let recNode = new AudioWorkletNode(ac, 'recorder-processor', {\n    //   //   numberOfInputs: 1,\n    //   //   numberOfOutputs: 1,\n    //   //   channelCount: 2,\n    //   //   channelCountMode: 'explicit',\n    //   //   channelInterpretation: 'speakers',\n    //   //   processorOptions: {\n    //   //     channels: 2,\n    //   //     chunkFrames: 16384\n    //   //   }\n    //   // });\n\n    //   // Sink –¥–ª—è —Å–∫—Ä—ã—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è Worklet. –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å, Chrome –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.\n    //   // –í–∞–∂–Ω–æ: –Ω–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å –∫ ac.destination, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª—ã—à–Ω–æ.\n    //   // let sink = ac.createGain();\n    //   // sink.gain.value = 0;\n    //   // exportSum.connect(recNode).connect(sink).connect(ac.destination); // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫ destination —Å –Ω—É–ª–µ–≤–æ–π –≥—Ä–æ–º–∫–æ—Å—Ç—å—é\n    //   // if (this.DEBUG) console.log('AudioExporter: RecorderProcessor –∏ Sink –ø–æ–¥–∫–ª—é—á–µ–Ω—ã.');\n\n    //   // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ MP3 Worker\n    //   // if (format === 'mp3') {\n    //   //   await this._initMp3Worker(ac.sampleRate, bitrate);\n    //   // }\n\n    //   const allTextBlocks = engine.lyricsDisplay.textBlocks; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    //   const blocksToExport = blockIds.map(id => allTextBlocks.find(b => String(b.id) === id)).filter(Boolean);\n    //   if (blocksToExport.length === 0) {\n    //     throw new Error('–ù–µ—Ç –±–ª–æ–∫–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏–ª–∏ –æ–Ω–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');\n    //   }\n\n    //   let totalOutSec = 0;\n    //   let playedOutSec = 0;\n    //   let tCursor = ac.currentTime + 0.12; // —Å (Safari –ª—é–±–∏—Ç 0.12) // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    //   const finalFadeInCurve = scaleCurve(makeSinCurve(256), 0.7);\n    //   const finalFadeOutCurve = scaleCurve(makeCosCurve(256), 0.7);\n\n    //   // –ì–ª—É—à–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤–æ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ\n    //   if (muteDuringExport) {\n    //     if (engine.instrumentalAudio) engine.instrumentalAudio.muted = true; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    //     if (engine.vocalsAudio) engine.vocalsAudio.muted = true; // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'engine'\n    //     if (this.DEBUG) console.log('AudioExporter: –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≥–ª—É—à–µ–Ω.');\n    //   }\n\n    //   // –ü–∞—Ä—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (—á–µ—Ä–µ–¥—É—é—Ç—Å—è A/B)\n    //   let currentInstPair = { el: createEl(instrumentalSrcUrl, rate), gain: ac.createGain() };\n    //   let nextInstPair = { el: createEl(instrumentalSrcUrl, rate), gain: ac.createGain() };\n    //   let currentVocPair = null;\n    //   let nextVocPair = null;\n\n    //   if (vocalsSrcUrl) {\n    //     currentVocPair = { el: createEl(vocalsSrcUrl, rate), gain: ac.createGain() };\n    //     nextVocPair = { el: createEl(vocalsSrcUrl, rate), gain: ac.createGain() };\n    //   }\n\n    //   const allPairs = [\n    //     { el: currentInstPair.el, src: null, gain: currentInstPair.gain },\n    //     { el: nextInstPair.el, src: null, gain: nextInstPair.gain },\n    //   ];\n    //   if (currentVocPair) allPairs.push({ el: currentVocPair.el, src: null, gain: currentVocPair.gain });\n    //   if (nextVocPair) allPairs.push({ el: nextVocPair.el, src: null, gain: nextVocPair.gain });\n\n    //   // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MediaElementSource –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ä\n    //   for (const pair of allPairs) {\n    //     await new Promise(res => {\n    //       if (pair.el.readyState >= 2 && pair.el.src) return res();\n    //       const onMeta = () => { pair.el.removeEventListener('loadedmetadata', onMeta); res(); };\n    //       pair.el.addEventListener('loadedmetadata', onMeta);\n    //       setTimeout(res, 500); // –ó–∞–ø–∞—Å–Ω–æ–π —Ç–∞–π–º–∞—É—Ç\n    //     });\n    //     pair.src = ac.createMediaElementSource(pair.el);\n    //     pair.src.connect(pair.gain).connect(exportSum);\n    //     pair.gain.gain.value = 0; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ 0\n    //   }\n\n    //   // –¶–∏–∫–ª –ø–æ –±–ª–æ–∫–∞–º\n    //   for (let i = 0; i < blocksToExport.length; i++) {\n    //     if (signal.aborted) throw new Error('–≠–∫—Å–ø–æ—Ä—Ç –æ—Ç–º–µ–Ω–µ–Ω.');\n    //     const block = blocksToExport[i];\n    //     const nextBlock = blocksToExport[i + 1];\n    //     const segStart = (this.markerManager._getTimeForLine(block.lineIndices[0]) || 0) / rate; // –ò—Å–ø–æ–ª—å–∑—É–µ–º _getTimeForLine\n    //     const segEnd = (this.markerManager._getTimeForLine(block.lineIndices[block.lineIndices.length - 1] + 1) || (block.start_time_sec + 5) || 0) / rate; // –ò—Å–ø–æ–ª—å–∑—É–µ–º _getTimeForLine –¥–ª—è –∫–æ–Ω—Ü–∞ –±–ª–æ–∫–∞\n    //     const outDur = segEnd - segStart;\n    //     if (outDur <= 0) {\n    //       if (this.DEBUG) console.warn(`AudioExporter: –ü—Ä–æ–ø—É—â–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –±–ª–æ–∫–∞ ${block.id}`);\n    //       continue;\n    //     }\n\n    //     const currentSegmentStartTime = tCursor;\n    //     const currentSegmentEndTime = tCursor + outDur;\n\n    //     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—Ä–æ—Å—Å—Ñ–µ–π–¥\n    //     const actualCrossfadeSec = Math.min(30 / 1000, outDur * 0.5); // –ù–µ –±–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–µ–≥–º–µ–Ω—Ç–∞\n    //     const xfadeStart = currentSegmentEndTime - actualCrossfadeSec;\n    //     if (this.DEBUG) console.log(`Block ${block.id}: Seg: [${segStart.toFixed(3)}, ${segEnd.toFixed(3)}] -> Out: [${currentSegmentStartTime.toFixed(3)}, ${currentSegmentEndTime.toFixed(3)}], xfadeStart: ${xfadeStart.toFixed(3)}`);\n\n    //     // Seek –∏ play –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞\n    //     await seekTo(currentInstPair.el, segStart);\n    //     await currentInstPair.el.play();\n    //     if (currentVocPair) {\n    //       await seekTo(currentVocPair.el, segStart);\n    //       await currentVocPair.el.play();\n    //     }\n\n    //     // –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—Å–∏–ª–µ–Ω–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (fadeOut)\n    //     currentInstPair.gain.gain.setValueAtTime(0.7 * originalInstGain, currentSegmentStartTime);\n    //     applyConstPower(currentInstPair.gain.gain, xfadeStart, currentSegmentEndTime, finalFadeOutCurve, ac);\n    //     if (currentVocPair) {\n    //       currentVocPair.gain.gain.setValueAtTime(0.7 * originalVocGain, currentSegmentStartTime);\n    //       applyConstPower(currentVocPair.gain.gain, xfadeStart, currentSegmentEndTime, finalFadeOutCurve, ac);\n    //     }\n\n    //     // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å\n    //     if (nextBlock) {\n    //       const nextSegStart = (this.markerManager._getTimeForLine(nextBlock.lineIndices[0]) || 0) / rate; // Pre-seek —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞\n    //       await seekTo(nextInstPair.el, nextSegStart);\n    //       if (nextVocPair) {\n    //         await seekTo(nextVocPair.el, nextSegStart);\n    //       }\n\n    //       // –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π play() –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–≤ pre-roll)\n    //       const nextPlayTime = Math.max(ac.currentTime + 0.005, xfadeStart - (260 / 1000)); // –í–∞–∂–Ω–æ: play() –º–æ–∂–µ—Ç –±—ã—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º, –Ω–æ –º—ã –Ω–µ –∂–¥–µ–º –µ–≥–æ –∑–¥–µ—Å—å, —Ç.–∫. —Ç–∞–π–º–∏–Ω–≥ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è setValueAtTime\n    //       nextInstPair.el.play().catch(e => console.warn('Error playing next instrumental:', e));\n    //       if (nextVocPair) {\n    //         nextVocPair.el.play().catch(e => console.warn('Error playing next vocals:', e));\n    //       }\n\n    //       // –£–¥–µ—Ä–∂–∞–Ω–∏–µ gain=0 –¥–æ –Ω–∞—á–∞–ª–∞ –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞\n    //       const holdUntilTime = Math.max(ac.currentTime + 0.005, xfadeStart - 0.002);\n    //       nextInstPair.gain.gain.setValueAtTime(0, ac.currentTime);\n    //       nextInstPair.gain.gain.setValueAtTime(0, holdUntilTime);\n    //       if (nextVocPair) {\n    //         nextVocPair.gain.gain.setValueAtTime(0, ac.currentTime);\n    //         nextVocPair.gain.gain.setValueAtTime(0, holdUntilTime);\n    //       }\n\n    //       // –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É—Å–∏–ª–µ–Ω–∏—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (fadeIn)\n    //       applyConstPower(nextInstPair.gain.gain, xfadeStart, currentSegmentEndTime, finalFadeInCurve, ac);\n    //       if (nextVocPair) {\n    //         applyConstPower(nextVocPair.gain.gain, xfadeStart, currentSegmentEndTime, finalFadeInCurve, ac);\n    //       }\n    //     }\n\n    //     // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ + –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∞\n    //     const segmentWaitTime = (currentSegmentEndTime - ac.currentTime) * 1000;\n    //     if (segmentWaitTime > 0) {\n    //       await wait(segmentWaitTime);\n    //     }\n\n    //     // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞\n    //     totalOutSec += outDur;\n    //     playedOutSec += outDur;\n    //     onProgress(playedOutSec / totalOutSec);\n\n    //     // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ A/B –ø–∞—Ä –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏\n    //     if (vocalsSrcUrl) {\n    //       [currentInstPair, nextInstPair] = [nextInstPair, currentInstPair];\n    //       [currentVocPair, nextVocPair] = [nextVocPair, currentVocPair];\n    //     } else {\n    //       // –ï—Å–ª–∏ –≤–æ–∫–∞–ª–∞ –Ω–µ—Ç, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª\n    //       [currentInstPair, nextInstPair] = [nextInstPair, currentInstPair];\n    //     }\n\n    //     // –û–±–Ω–æ–≤–ª—è–µ–º tCursor –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞\n    //     tCursor = currentSegmentEndTime; // –°–ª–µ–¥—É—é—â–∏–π —Å–µ–≥–º–µ–Ω—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ\n    //     if (this.DEBUG) console.log(`AudioExporter: –ó–∞–≤–µ—Ä—à–µ–Ω –±–ª–æ–∫ ${block.id}. –ü—Ä–æ–≥—Ä–µ—Å—Å: ${(onProgress / totalOutSec * 100).toFixed(2)}%`);\n    //   }\n\n    //   // –ü–æ—Å–ª–µ —Ü–∏–∫–ª–∞, —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç –¥–æ–∏–≥—Ä–∞–ª —Å–≤–æ–π fadeOut\n    //   await wait(Math.max(0, (tCursor - ac.currentTime) * 1000));\n\n    //   // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è worklet/encoder\n    //   recNode.port.postMessage({ type: 'flush' });\n    //   await wait(80);\n    //   recNode.port.postMessage({ type: 'stop' });\n    //   await wait(80);\n    //   try { recNode.port.onmessage = null; } catch (_) {}\n    //   try { exportSum.disconnect(); } catch (_) {}\n    //   try { recNode.disconnect(); } catch (_) {}\n    //   try { sink.disconnect(); } catch (_) {}\n\n    //   // –û—á–∏—Å—Ç–∫–∞ A/B —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n    //   cleanupExportElements(allPairs);\n\n    //   // –†–∞–∑–≥–ª—É—à–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä\n    //   if (muteDuringExport) {\n    //     if (engine.instrumentalAudio) engine.instrumentalAudio.muted = false;\n    //     if (engine.vocalsAudio) engine.vocalsAudio.muted = false;\n    //     if (this.DEBUG) console.log('AudioExporter: –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä —Ä–∞–∑–≥–ª—É—à–µ–Ω.');\n    //   }\n\n    //   // –°–±–æ—Ä–∫–∞ Blob\n    //   let blob;\n    //   if (format === 'mp3') {\n    //     const mp3Data = await this._flushMp3Worker();\n    //     blob = new Blob(mp3Data, { type: 'audio/mp3' });\n    //   } else {\n    //     // ... (–ª–æ–≥–∏–∫–∞ WAV, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ —Å–µ–π—á–∞—Å —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ MP3)\n    //     // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ mp3, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π blob –∏–ª–∏ –æ—à–∏–±–∫—É\n    //     throw new Error('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ MP3 —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞.');\n    //   }\n\n    //   // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞\n    //   const currentTrack = window.trackCatalog?.tracks?.[window.trackCatalog.currentTrackIndex];\n    //   const title = currentTrack?.title || 'exported_track';\n    //   const filename = this._makeFileName(title, format);\n\n    //   this.isExporting = false;\n    //   this._exportAbortController = null;\n    //   if (this.DEBUG) console.log(`AudioExporter: –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –§–∞–π–ª: ${filename}, –†–∞–∑–º–µ—Ä: ${blob.size}`);\n    //   return { blob, durationSec: totalOutSec, sampleRate: ac.sampleRate, channels: 2, format, filename };\n\n    // } catch (e) {\n    //   console.error('AudioExporter: –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞:', e);\n    //   if (this.mp3Worker) {\n    //     this.mp3Worker.postMessage({ type: 'flush' }); // –ü–æ–ø—ã—Ç–∫–∞ —Å–±—Ä–æ—Å–∏—Ç—å –≤–æ—Ä–∫–µ—Ä\n    //     this.mp3Worker.postMessage({ type: 'close' }); // –ó–∞–∫—Ä—ã—Ç—å –≤–æ—Ä–∫–µ—Ä\n    //     this.mp3Worker = null;\n    //   }\n    //   // –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏\n    //   try { if (recNode) recNode.port.postMessage({ type: 'stop' }); } catch (_) {}\n    //   try { if (exportSum) exportSum.disconnect(); } catch (_) {}\n    //   try { if (recNode) recNode.disconnect(); } catch (_) {}\n    //   try { if (sink) sink.disconnect(); } catch (_) {}\n    //   cleanupExportElements(allPairs);\n    //   // –†–∞–∑–≥–ª—É—à–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏\n    //   if (muteDuringExport) {\n    //     if (engine.instrumentalAudio) engine.instrumentalAudio.muted = false;\n    //     if (engine.vocalsAudio) engine.vocalsAudio.muted = false;\n    //   }\n    //   this.isExporting = false;\n    //   this._exportAbortController = null;\n    //   throw e; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ\n    // } finally {\n    //   // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ isExporting –≤—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è\n    //   this.isExporting = false;\n    //   this._exportAbortController = null;\n    // }\n  }\n\n  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ Float32Array –≤ Int16Array (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)\n  _floatTo16(float32) {\n    const out = new Int16Array(float32.length);\n    for (let i = 0; i < float32.length; i++) {\n      let s = Math.max(-1, Math.min(1, float32[i]));\n      out[i] = s < 0 ? (s * 0x8000) : (s * 0x7FFF);\n    }\n    return out;\n  }\n\n  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è WAV (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è)\n  _encodeWav(left, right, sampleRate) {\n    const interleaved = new Float32Array(left.length + right.length);\n    for (let i=0, j=0; i<left.length; i++, j+=2) {\n      interleaved[j] = left[i];\n      interleaved[j+1] = right[i] ?? 0; // –î–ª—è –º–æ–Ω–æ-–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∞–≤—ã–π –∫–∞–Ω–∞–ª –±—É–¥–µ—Ç –Ω—É–ª–µ–º\n    }\n\n    const pcm16 = this._floatTo16(interleaved); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞\n\n    const blockAlign = 2 * 2; // 16-bit * 2ch\n    const byteRate = sampleRate * blockAlign;\n    const dataSize = pcm16.byteLength;\n    const buffer = new ArrayBuffer(44 + dataSize);\n    const view = new DataView(buffer);\n\n    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å—Ç—Ä–æ–∫–∏ –≤ DataView (–ª–æ–∫–∞–ª—å–Ω–∞—è –¥–ª—è _encodeWav)\n    const writeString = (view, offset, string) => {\n      for (let i = 0; i < string.length; i++) {\n        view.setUint8(offset + i, string.charCodeAt(i));\n      }\n    };\n\n    // RIFF header\n    writeString(view, 0, 'RIFF'); // ChunkID\n    view.setUint32(4, 36 + dataSize, true); // ChunkSize\n    writeString(view, 8, 'WAVE'); // Format\n\n    // Subchunk1: Format header\n    writeString(view, 12, 'fmt '); // Subchunk1ID\n    view.setUint32(16, 16, true); // Subchunk1Size\n    view.setUint16(20, 1, true); // AudioFormat\n    view.setUint16(22, 2, true); // NumChannels\n    view.setUint32(24, sampleRate, true); // SampleRate\n    view.setUint32(28, byteRate, true); // ByteRate\n    view.setUint16(32, blockAlign, true); // BlockAlign\n    view.setUint16(34, 16, true); // BitsPerSample\n\n    // Subchunk2: Data header\n    writeString(view, 36, 'data'); // Subchunk2ID\n    view.setUint32(40, dataSize, true); // Subchunk2Size\n\n    // Write the PCM data to the buffer\n    new Int16Array(buffer, 44).set(pcm16);\n\n    return new Blob([view], { type: 'audio/wav' });\n  }\n}\n\n// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Web Audio API –∏ –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∏–Ω–≥–æ–º ---\n\n// üéØ –ù–û–í–û–ï: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTMLAudioElement\nfunction createEl(srcUrl, rate = 1) {\n  const el = new Audio();\n  el.crossOrigin = 'anonymous';\n  el.preload = 'auto';\n  el.playsInline = true;\n  el.playbackRate = rate;\n  try {\n    if ('preservesPitch' in el) el.preservesPitch = true;\n    if ('mozPreservesPitch' in el) el.mozPreservesPitch = true;\n    if ('webkitPreservesPitch' in el) el.webkitPreservesPitch = true;\n  } catch (_) {}\n  el.src = srcUrl;\n  return el;\n}\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω—É—é –∫—Ä–∏–≤—É—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –Ω–∞—Ä–∞—Å—Ç–∞–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (fade-in)\nfunction makeSinCurve(n = 256) {\n  const a = new Float32Array(n);\n  for (let i = 0; i < n; i++) {\n    a[i] = Math.sin((i / (n - 1)) * Math.PI / 2); // –û—Ç 0 –¥–æ 1\n  }\n  return a;\n}\n\n// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ—Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω—É—é –∫—Ä–∏–≤—É—é –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (fade-out)\nfunction makeCosCurve(n = 256) {\n  const a = new Float32Array(n);\n  for (let i = 0; i < n; i++) {\n    a[i] = Math.cos((i / (n - 1)) * Math.PI / 2); // –û—Ç 1 –¥–æ 0\n  }\n  return a;\n}\n\n// –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç –∫—Ä–∏–≤—É—é —É—Å–∏–ª–µ–Ω–∏—è –¥–æ –Ω—É–∂–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è\nfunction scaleCurve(curve, gain) {\n  const out = new Float32Array(curve.length);\n  for (let i = 0; i < curve.length; i++) out[i] = curve[i] * gain;\n  return out;\n}\n\n// –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∫—Ä–∏–≤—É—é —É—Å–∏–ª–µ–Ω–∏—è –∫ AudioParam, –∏—Å–ø–æ–ª—å–∑—É—è constant-power (sin/cos)\nfunction applyConstPower(param, t0, t1, curve, ac) {\n  const now = ac.currentTime;\n  const start = Math.max(t0, now + 0.015); // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 15 –º—Å –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏\n  const dur = Math.max(0.015, t1 - start);\n\n  if (typeof param.cancelAndHoldAtTime === 'function') {\n    param.cancelAndHoldAtTime(start);\n  } else {\n    const v = param.value;\n    param.cancelScheduledValues(start);\n    param.setValueAtTime(v, start);\n  }\n  param.setValueCurveAtTime(curve, start, dur);\n}\n\n// –ù–∞–¥–µ–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è seekTo –¥–ª—è HTMLMediaElement\nfunction seekTo(el, t) {\n  return new Promise((res) => {\n    if (!el) return res();\n    if (Math.abs((el.currentTime || 0) - t) < 0.008) return res(); // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ –º–µ—Å—Ç–µ\n\n    let done = false;\n    const finish = () => { if (!done) { done = true; cleanup(); res(); } };\n    const onSeeked = () => finish();\n    const onTU = () => { if (Math.abs(el.currentTime - t) < 0.01) finish(); };\n    const cleanup = () => {\n      el.removeEventListener('seeked', onSeeked);\n      el.removeEventListener('timeupdate', onTU);\n    };\n\n    el.addEventListener('seeked', onSeeked, { once: true });\n    el.addEventListener('timeupdate', onTU);\n    el.currentTime = Math.max(0, Math.min(el.duration || t, t));\n    setTimeout(finish, 300); // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π –∑–∞–≤–∏—Å–∞–Ω–∏—è\n  });\n}\n\n// –°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä—É HTMLAudioElement –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —É–∑–ª–æ–≤ Web Audio API –¥–ª—è –∫—Ä–æ—Å—Å—Ñ–µ–π–¥–∏–Ω–≥–∞\nfunction createAudioPair(ac, srcUrl, rate) {\n  const elA = new Audio(),\n    elB = new Audio();\n  [elA, elB].forEach(el => {\n    el.crossOrigin = 'anonymous'; // –û–ß–ï–ù–¨ –í–ê–ñ–ù–û –¥–ª—è CORS –∏ Web Audio API\n    el.preload = 'auto';\n    el.playsInline = true;\n    el.playbackRate = rate;\n    try {\n      if ('preservesPitch' in el) el.preservesPitch = true;\n      if ('mozPreservesPitch' in el) el.mozPreservesPitch = true;\n      if ('webkitPreservesPitch' in el) el.webkitPreservesPitch = true;\n    } catch (_) {}\n    el.src = srcUrl;\n  });\n\n  const srcA = ac.createMediaElementSource(elA);\n  const srcB = ac.createMediaElementSource(elB);\n  const gA = ac.createGain();\n  gA.gain.value = 0; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ 0\n  const gB = ac.createGain();\n  gB.gain.value = 0; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –≥—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ 0\n\n  return { elA, elB, srcA, srcB, gA, gB };\n}\n\n// –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ—Å–ª–µ —ç–∫—Å–ø–æ—Ä—Ç–∞\nfunction cleanupExportElements(pairList) {\n  for (const p of pairList) {\n    try {\n      p.srcA.disconnect();\n      p.srcB.disconnect();\n    } catch (_) {}\n    try {\n      p.gA.disconnect();\n      p.gB.disconnect();\n    } catch (_) {}\n    [p.elA, p.elB].forEach(el => {\n      try {\n        el.pause();\n        // –ï—Å–ª–∏ —ç—Ç–æ blob: URL, –Ω—É–∂–Ω–æ revokeObjectURL (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∑–¥–µ—Å—å, –Ω–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ–±—â–µ–≥–æ —Å–ª—É—á–∞—è)\n        el.src = '';\n        el.removeAttribute('src');\n        // el.load(); // –í–∫–ª—é—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ CLEANUP_DETACH –≤–∫–ª—é—á–µ–Ω)\n      } catch (_) {}\n    });\n  }\n}\n\n// –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏\nfunction wait(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç—ë—Ä\nwindow.audioExporter = new AudioExporter({\n  engine: window.audioEngine, // üéØ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–µ—Ä–µ–¥–∞–µ–º –∫–∞–∫ 'engine'\n  markerManager: window.markerManager,\n  lyricsDisplay: window.lyricsDisplay,\n  blockLoopControl: window.blockLoopControl\n});\n","export type MessageRole = 'system' | 'user' | 'assistant';\n\nexport interface Message {\n  role: MessageRole;\n  content: string;\n  name?: string;\n}\n\nexport interface ChatRequest {\n  model: string;\n  messages: Message[];\n  temperature?: number;\n  maxTokens?: number;\n  stream?: boolean;\n  user?: string;\n  injectOperator?: boolean;\n}\n\nexport type StreamEvent =\n  | { type: 'start'; model: string; timestamp: number }\n  | { type: 'token'; data: string }\n  | { type: 'done'; data: { fullText: string; usage?: TokenUsage } }\n  | { type: 'error'; data: { code: string; message: string } };\n\nexport interface TokenUsage {\n  promptTokens: number;\n  completionTokens: number;\n  totalTokens: number;\n}\n\nexport interface StreamCallbacks {\n  onStart?: (model: string) => void;\n  onToken?: (token: string) => void;\n  onDone?: (fullText: string, usage?: TokenUsage) => void;\n  onError?: (error: AIError) => void;\n}\n\nexport class AIError extends Error {\n  constructor(\n    public code: string,\n    message: string,\n    public provider?: string,\n    public statusCode?: number\n  ) {\n    super(message);\n    this.name = 'AIError';\n  }\n}\n\nexport interface AIProvider {\n  readonly id: string;\n  readonly displayName: string;\n  readonly models: ModelInfo[];\n  sendChat(\n    request: ChatRequest,\n    callbacks?: StreamCallbacks\n  ): Promise<string | void>;\n  healthCheck(): Promise<boolean>;\n  stop?(): void; // –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞\n}\n\nexport interface ModelInfo {\n  id: string;\n  shortName: string;\n  provider: string;\n  contextWindow: number;\n  costTier: 'free' | 'low' | 'mid' | 'high';\n  capabilities: string[];\n  icon?: string;\n}\n","import { AIProvider, ChatRequest, ModelInfo, StreamCallbacks, AIError } from './types';\n\nexport class AIHub extends EventTarget {\n  private providers = new Map<string, AIProvider>();\n  private models: ModelInfo[] = [];\n  private _activeModel: ModelInfo | null = null;\n\n  constructor() {\n    super();\n    this.loadActiveModelFromLocalStorage();\n  }\n\n  register(provider: AIProvider): void {\n    this.providers.set(provider.id, provider);\n    this.models = Array.from(this.providers.values()).flatMap(p => p.models);\n\n    const savedModelId = localStorage.getItem('belive:active-model');\n    if (savedModelId && this.models.some(m => m.id === savedModelId)) {\n        this._activeModel = this.models.find(m => m.id === savedModelId) || null;\n    } else {\n        this._activeModel = null;\n        localStorage.removeItem('belive:active-model');\n    }\n    this.dispatchEvent(new CustomEvent('modelChanged', { detail: this._activeModel }));\n  }\n\n  getAllModels(): ModelInfo[] {\n    return this.models;\n  }\n\n  setActiveModel(modelId: string | null): void {\n    let newActiveModel: ModelInfo | null = null;\n    if (modelId !== null) {\n      newActiveModel = this.models.find(m => m.id === modelId) || null;\n    }\n\n    if (this._activeModel?.id === newActiveModel?.id) {\n        return; // –ú–æ–¥–µ–ª—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å\n    }\n\n    this._activeModel = newActiveModel;\n\n    if (this._activeModel) {\n      localStorage.setItem('belive:active-model', this._activeModel.id);\n    } else {\n      localStorage.removeItem('belive:active-model');\n    }\n    this.dispatchEvent(new CustomEvent('modelChanged', { detail: this._activeModel }));\n  }\n\n  getActiveModel(): ModelInfo | null {\n    return this._activeModel;\n  }\n\n  getActiveProvider(): AIProvider | null {\n    const model = this.getActiveModel();\n    return model ? this.providers.get(model.provider) || null : null;\n  }\n\n  on(eventName: string, listener: EventListenerOrEventListenerObject): void {\n    this.addEventListener(eventName, listener);\n  }\n\n  off(eventName: string, listener: EventListenerOrEventListenerObject): void {\n    this.removeEventListener(eventName, listener);\n  }\n\n  async sendMessage(\n    request: ChatRequest,\n    callbacks?: StreamCallbacks\n  ): Promise<string | void> {\n    const model = this.getActiveModel();\n    if (!model) {\n      callbacks?.onError?.(new AIError('NO_MODEL_SELECTED', 'No active AI model selected.'));\n      return;\n    }\n    const provider = this.providers.get(model.provider);\n    if (!provider) {\n      callbacks?.onError?.(new AIError('PROVIDER_NOT_FOUND', `AI provider ${model.provider} not found.`));\n      return;\n    }\n    return provider.sendChat(request, callbacks);\n  }\n\n  stopAllProviders(): void {\n    this.providers.forEach(p => p.stop?.());\n  }\n\n  private loadActiveModelFromLocalStorage(): void {\n    // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ register(), —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ª–∏—á–∏–µ –º–æ–¥–µ–ª–µ–π\n  }\n}\n\nexport const aiHub = new AIHub();\n","import { AIProvider, ChatRequest, ModelInfo, StreamCallbacks, AIError, StreamEvent } from '../types';\n\nconst GATEWAY_URL = 'http://localhost:8787'; // TODO: Replace with your Cloudflare Workers Gateway URL\n\ninterface EphemeralToken {\n  token: string;\n  expiresAt: number;\n}\n\nexport class GatewayProvider implements AIProvider {\n  readonly id = 'gateway';\n  readonly displayName = 'beLive Gateway';\n  readonly models: ModelInfo[] = [\n    {\n      id: 'openrouter/google/gemini-2.5-pro',\n      shortName: 'Gemini 2.5 Pro',\n      provider: 'gateway',\n      contextWindow: 1000000,\n      costTier: 'mid',\n      capabilities: ['chat', 'vision'],\n      // icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/google-gemini-pro.svg', // SVG Icon for Gemini 2.5 Pro\n    },\n    {\n      id: 'openrouter/anthropic/claude-4.5-sonnet-20250929-thinking',\n      shortName: 'Claude 4.5 Sonnet',\n      provider: 'gateway',\n      contextWindow: 200000,\n      costTier: 'mid',\n      capabilities: ['chat', 'vision', 'artifacts'],\n      icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/claude.svg', // SVG Icon for Claude 4.5 Sonnet\n    },\n    {\n      id: 'openrouter/openai/gpt-5-high',\n      shortName: 'GPT-5 High',\n      provider: 'gateway',\n      contextWindow: 128000,\n      costTier: 'high',\n      capabilities: ['chat', 'function-calling'],\n      icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/openai.svg', // SVG Icon for GPT-5 High\n    },\n    {\n      id: 'openrouter/openai/gpt-4o-mini',\n      shortName: 'GPT-4o Mini',\n      provider: 'gateway',\n      contextWindow: 128000,\n      costTier: 'low',\n      capabilities: ['chat', 'vision', 'function-calling'],\n      icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/openai.svg', // SVG Icon for GPT-4o Mini\n    },\n    {\n      id: 'openrouter/meta-llama/llama-3.1-8b-instruct',\n      shortName: 'Llama 3.1 8B',\n      provider: 'gateway',\n      contextWindow: 128000,\n      costTier: 'low',\n      capabilities: ['chat'],\n      // icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/llama.svg', // SVG Icon for Llama 3.1 8B\n    },\n    {\n      id: 'openrouter/xai/grok-1-vision',\n      shortName: 'Grok 4 Vision',\n      provider: 'gateway',\n      contextWindow: 128000,\n      costTier: 'low',\n      capabilities: ['chat'],\n      icon: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/grok.svg', // SVG Icon for Grok 4 Vision\n    },\n    {\n      id: 'openrouter/deepseek/deepseek-v3.1',\n      shortName: 'DeepSeek-V3.1',\n      provider: 'gateway',\n      contextWindow: 1840000, // 1.84M tokens\n      costTier: 'free',\n      capabilities: ['chat', 'vision', 'function-calling'], // Multimodal and tool calling\n    },\n  ];\n\n  private ephemeral: EphemeralToken | null = null;\n  private currentAbortController: AbortController | null = null;\n\n  constructor(private gatewayUrl: string = GATEWAY_URL) {}\n\n  async healthCheck(): Promise<boolean> {\n    try {\n      const res = await fetch(`${this.gatewayUrl}/health`, {\n        method: 'GET',\n        signal: AbortSignal.timeout(5000),\n      });\n      return res.ok;\n    } catch {\n      return false;\n    }\n  }\n\n  async sendChat(\n    request: ChatRequest,\n    callbacks?: StreamCallbacks\n  ): Promise<string | void> {\n    if (request.stream && callbacks) {\n      return this.streamChat(request, callbacks);\n    } else {\n      // For non-streaming requests, we'd implement a different endpoint or handle it differently.\n      // For now, we only support streaming.\n      callbacks?.onError?.(new AIError('NOT_IMPLEMENTED', 'Non-streaming chat is not implemented.'));\n      return;\n    }\n  }\n\n  stop(): void {\n    this.currentAbortController?.abort();\n    this.currentAbortController = null;\n  }\n\n  private async getEphemeralToken(): Promise<string> {\n    const now = Date.now();\n    if (this.ephemeral && this.ephemeral.expiresAt - now > 5000) {\n      return this.ephemeral.token;\n    }\n\n    try {\n      const res = await fetch(`${this.gatewayUrl}/auth/ephemeral`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n      });\n      if (!res.ok) {\n        const errorData = await res.json();\n        throw new AIError('AUTH_ERROR', errorData.error?.message || 'Failed to get ephemeral token', this.id, res.status);\n      }\n      const data = await res.json();\n      this.ephemeral = { token: data.token, expiresAt: data.expiresAt };\n      return this.ephemeral.token;\n    } catch (e: any) {\n      throw new AIError('NETWORK_ERROR', e.message || 'Network error during ephemeral token request', this.id);\n    }\n  }\n\n  private async streamChat(\n    request: ChatRequest,\n    callbacks: StreamCallbacks\n  ): Promise<void> {\n    const token = await this.getEphemeralToken();\n\n    this.currentAbortController?.abort(); // Abort any ongoing stream\n    this.currentAbortController = new AbortController();\n    const { signal } = this.currentAbortController;\n\n    try {\n      const res = await fetch(`${this.gatewayUrl}/v1/chat/stream`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify(request),\n        signal, // Pass the abort signal\n      });\n\n      if (!res.ok) {\n        const errorText = await res.text();\n        let errorData;\n        try { errorData = JSON.parse(errorText); } catch { /* ignore */ }\n        callbacks.onError?.(new AIError(\n          errorData?.error?.code || 'GATEWAY_ERROR',\n          errorData?.error?.message || `Gateway error: ${res.status} ${errorText}`,\n          this.id,\n          res.status\n        ));\n        return;\n      }\n\n      const reader = res.body!.getReader();\n      const decoder = new TextDecoder();\n      let buffer = '';\n      let fullText = '';\n\n      callbacks.onStart?.(request.model);\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        buffer += decoder.decode(value, { stream: true });\n        const lines = buffer.split('\\n');\n        buffer = lines.pop() || ''; // Keep incomplete line in buffer\n\n        for (const line of lines) {\n          if (!line.trim() || !line.startsWith('data: ')) continue;\n\n          const jsonStr = line.slice(6).trim();\n          if (jsonStr === '[DONE]') continue; // Handled by backend logic, but good to have fallback\n\n          try {\n            const event: StreamEvent = JSON.parse(jsonStr);\n            switch (event.type) {\n              case 'token':\n                fullText += event.data;\n                callbacks.onToken?.(event.data);\n                break;\n              case 'done':\n                callbacks.onDone?.(event.data.fullText || fullText, event.data.usage);\n                break;\n              case 'error':\n                callbacks.onError?.(new AIError(event.data.code, event.data.message, this.id));\n                break;\n              // 'start' event is handled directly by callbacks.onStart\n            }\n          } catch (e) {\n            console.warn('Failed to parse SSE event:', line, e);\n            // callbacks.onError?.(new AIError('PARSE_ERROR', `Failed to parse SSE event: ${line}`, this.id));\n          }\n        }\n      }\n      // Ensure onDone is called if not explicitly sent by gateway (fallback)\n      callbacks.onDone?.(fullText);\n    } catch (e: any) {\n      if (e.name === 'AbortError') {\n        console.log('Stream aborted.');\n        return; // Stream was intentionally stopped\n      }\n      callbacks.onError?.(new AIError('STREAM_FETCH_ERROR', e.message || 'Failed to fetch stream', this.id));\n    }\n  }\n}\n","import { ModelInfo } from '../ai/types';\nimport { aiHub } from '../ai/registry';\n\nexport class ModelDropdownUI {\n    private dropdownElement: HTMLElement;\n    private modelListElement: HTMLElement;\n    private isOpen = false;\n\n    constructor() {\n        this.dropdownElement = document.getElementById('belive-ai-picker')!;\n        this.modelListElement = this.dropdownElement.querySelector('.model-list')!;\n\n        if (!this.dropdownElement || !this.modelListElement) {\n            console.error('ModelDropdownUI: –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã UI –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π.');\n            return;\n        }\n\n        this.init();\n    }\n\n    private init(): void {\n        this.renderModels();\n        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ\n        document.addEventListener('click', (e) => {\n            if (!this.dropdownElement.contains(e.target as Node)) {\n                this.closeDropdown();\n            }\n        });\n\n        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–∑ aiHub –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞\n        aiHub.on('modelChanged', () => this.renderModels());\n    }\n\n    private renderModels(): void {\n        this.modelListElement.innerHTML = '';\n        const models = aiHub.getAllModels();\n        const activeModelId = aiHub.getActiveModel()?.id;\n\n        models.forEach((model: ModelInfo) => {\n            const modelItem = document.createElement('div');\n            modelItem.className = 'model-item';\n            if (model.id === activeModelId) {\n                modelItem.classList.add('active');\n            }\n            modelItem.dataset.modelId = model.id;\n\n            modelItem.innerHTML = `\n                <span class=\"model-name\">${model.shortName}</span>\n                <span class=\"model-badge\">${model.costTier}</span>\n            `;\n\n            modelItem.addEventListener('click', () => {\n                aiHub.setActiveModel(model.id);\n                this.closeDropdown();\n            });\n            this.modelListElement.appendChild(modelItem);\n        });\n    }\n\n    public openAt(anchor: HTMLElement): void {\n        const rect = anchor.getBoundingClientRect();\n        Object.assign(this.dropdownElement.style, {\n            left: `${rect.left}px`,\n            top: `${rect.bottom + 8}px`,\n        });\n        this.dropdownElement.classList.add('active');\n        this.isOpen = true;\n    }\n\n    public closeDropdown(): void {\n        this.dropdownElement.classList.remove('active');\n        this.isOpen = false;\n    }\n\n    public toggleDropdown(): void {\n        if (this.isOpen) {\n            this.closeDropdown();\n        } else {\n            // –≠—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞ —É–∂–µ –Ω–µ –±—É–¥–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ –∫–Ω–æ–ø–∫–∏ \"Operator\"\n            // openAt –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑ AIChatUI\n            console.warn('ModelDropdownUI: toggleDropdown –≤—ã–∑–≤–∞–Ω –±–µ–∑ —è–∫–æ—Ä—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ openAt(anchor).');\n            this.dropdownElement.classList.toggle('active');\n            this.isOpen = this.dropdownElement.classList.contains('active');\n        }\n    }\n}\n","export async function* streamOpenAI(body: ReadableStream<Uint8Array>): AsyncGenerator<string> {\n  const reader = body.getReader();\n  const decoder = new TextDecoder();\n  let buffer = '';\n\n  try {\n    while (true) {\n      const { done, value } = await reader.read();\n      if (done) break;\n\n      buffer += decoder.decode(value, { stream: true });\n      const lines = buffer.split('\\n');\n      buffer = lines.pop() || '';\n\n      for (const line of lines) {\n        if (line.startsWith('data: ')) {\n          const data = line.slice(6).trim();\n          \n          if (data === '[DONE]') {\n            return;\n          }\n\n          try {\n            const parsed = JSON.parse(data);\n            const content = parsed.choices?.[0]?.delta?.content;\n            \n            if (content) {\n              yield content;\n            }\n          } catch (e) {\n            // Ignore parse errors\n          }\n        }\n      }\n    }\n  } finally {\n    reader.releaseLock();\n  }\n}\n","type VoiceOpts = {\n  onPartial?: (text: string) => void;\n  onFinal?: (text: string) => void;\n};\n\nexport class VoiceInput {\n  private recognition: any = null;\n  private isRecording = false;\n  // private onResultCallback: ((text: string) => void) | null = null; // –£–¥–∞–ª—è–µ–º —ç—Ç–æ –ø–æ–ª–µ\n\n  constructor(private opts: VoiceOpts) { // –ü—Ä–∏–Ω–∏–º–∞–µ–º opts –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ\n    // @ts-ignore\n    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n    \n    if (!SpeechRecognition) {\n      console.warn('Speech Recognition not supported');\n      return;\n    }\n\n    this.recognition = new SpeechRecognition();\n    this.recognition.continuous = false;\n    this.recognition.interimResults = true;\n    this.recognition.lang = 'ru-RU';\n\n    this.recognition.onresult = (event: any) => {\n      let transcript = '';\n      let isFinal = false;\n\n      for (const result of event.results) {\n        transcript += result[0].transcript;\n        if (result.isFinal) {\n          isFinal = true;\n        }\n      }\n\n      this.opts.onPartial?.(transcript); // –í—ã–∑—ã–≤–∞–µ–º onPartial –¥–ª—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n\n      if (isFinal && this.opts.onFinal) {\n        this.opts.onFinal(transcript);\n      }\n    };\n\n    this.recognition.onerror = (event: any) => {\n      console.error('Speech recognition error:', event.error);\n      this.stopRecording();\n    };\n\n    this.recognition.onend = () => {\n      this.isRecording = false;\n    };\n  }\n\n  startRecording(): boolean { // –ë–æ–ª—å—à–µ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–±—ç–∫ –∑–¥–µ—Å—å\n    if (!this.recognition) return false;\n\n    // this.onResultCallback = onResult; // –£–¥–∞–ª—è–µ–º\n    this.isRecording = true;\n    this.recognition.start();\n    return true;\n  }\n\n  stopRecording() {\n    if (this.recognition && this.isRecording) {\n      this.recognition.stop();\n      this.isRecording = false;\n    }\n  }\n\n  isActive(): boolean {\n    return this.isRecording;\n  }\n}\n","interface ToolCall {\n  tool: string;\n  arguments: Record<string, any>;\n}\n\ninterface ActionResponse {\n  success: boolean;\n  message: string;\n  data?: any;\n}\n\nexport class AI_ActionExecutor {\n  // –ü–∞—Ä—Å–∏–Ω–≥ tool_call –∏–∑ –æ—Ç–≤–µ—Ç–∞ AI\n  static parseToolCalls(aiResponse: string): ToolCall[] {\n    const calls: ToolCall[] = [];\n    \n    // –ò—â–µ–º JSON –±–ª–æ–∫–∏ —Å tool_call\n    const regex = /```json\\s*(\\{[\\s\\S]*?\"tool\"[\\s\\S]*?\\})\\s*```/g;\n    let match;\n    \n    while ((match = regex.exec(aiResponse)) !== null) {\n      try {\n        const parsed = JSON.parse(match[1]);\n        if (parsed.tool && parsed.arguments) {\n          calls.push(parsed as ToolCall);\n        }\n      } catch (e) {\n        console.warn('Failed to parse tool_call:', e);\n      }\n    }\n    \n    return calls;\n  }\n\n  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è\n  static async execute(toolCall: ToolCall): Promise<ActionResponse> {\n    try {\n      switch (toolCall.tool) {\n        case 'set_metronome':\n          return await this.setMetronome(toolCall.arguments as { bpm: number });\n        \n        case 'analyze_vocal':\n          return await this.analyzeVocal();\n        \n        case 'suggest_exercise':\n          return await this.suggestExercise(toolCall.arguments as { type: string });\n        \n        case 'adjust_volume':\n          return await this.adjustVolume(toolCall.arguments as { track: string; level: number });\n        \n        default:\n          return {\n            success: false,\n            message: `Unknown tool: ${toolCall.tool}`\n          };\n      }\n    } catch (error: any) {\n      return {\n        success: false,\n        message: `Error executing ${toolCall.tool}: ${error.message}`\n      };\n    }\n  }\n\n  // üéµ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å BPM –º–µ—Ç—Ä–æ–Ω–æ–º–∞\n  private static async setMetronome(args: { bpm: number }): Promise<ActionResponse> {\n    const { bpm } = args;\n    \n    if (bpm < 40 || bpm > 240) {\n      return {\n        success: false,\n        message: 'BPM –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–µ–∂–¥—É 40 –∏ 240'\n      };\n    }\n\n    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–∏–º –º–µ—Ç—Ä–æ–Ω–æ–º–æ–º\n    const metronomeEl = document.getElementById('metronome-bpm') as HTMLInputElement;\n    if (metronomeEl) {\n      metronomeEl.value = String(bpm);\n      metronomeEl.dispatchEvent(new Event('change', { bubbles: true }));\n    }\n\n    return {\n      success: true,\n      message: `–ú–µ—Ç—Ä–æ–Ω–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${bpm} BPM`,\n      data: { bpm }\n    };\n  }\n\n  // üé§ –ê–Ω–∞–ª–∏–∑ –≤–æ–∫–∞–ª–∞\n  private static async analyzeVocal(): Promise<ActionResponse> {\n    // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–∏–º –∞—É–¥–∏–æ –¥–≤–∏–∂–∫–æ–º\n    // –ù–∞–ø—Ä–∏–º–µ—Ä, –∞–Ω–∞–ª–∏–∑ –ø–∏—Ç—á–∞, —Ç–µ–º–±—Ä–∞, —Ä–∏—Ç–º–∞\n    \n    return {\n      success: true,\n      message: '–ê–Ω–∞–ª–∏–∑ –≤–æ–∫–∞–ª–∞ –∑–∞–ø—É—â–µ–Ω. –°–ø–æ–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å!',\n      data: {\n        analyzing: true\n      }\n    };\n  }\n\n  // üèãÔ∏è –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ\n  private static async suggestExercise(args: { type: string }): Promise<ActionResponse> {\n    const exercises = {\n      'breathing': '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ \"4-7-8\": –í–¥–æ—Ö –Ω–∞ 4 —Å—á–µ—Ç–∞, –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7, –≤—ã–¥–æ—Ö –Ω–∞ 8',\n      'pitch': '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ \"–°–∏—Ä–µ–Ω–∞\": –ü–ª–∞–≤–Ω–æ —Å–∫–æ–ª—å–∑–∏—Ç–µ –æ—Ç –Ω–∏–∑–∫–æ–π –Ω–æ—Ç—ã –¥–æ –≤—ã—Å–æ–∫–æ–π',\n      'resonance': '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ \"–ú—ã—á–∞–Ω–∏–µ\": –ú—ã—á–∏—Ç–µ –Ω–∞ —É–¥–æ–±–Ω–æ–π –Ω–æ—Ç–µ, –æ—â—É—â–∞—è –≤–∏–±—Ä–∞—Ü–∏—é –≤ –º–∞—Å–∫–µ –ª–∏—Ü–∞'\n    };\n\n    const exercise = exercises[args.type as keyof typeof exercises];\n    \n    if (!exercise) {\n      return {\n        success: false,\n        message: `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: ${args.type}`\n      };\n    }\n\n    return {\n      success: true,\n      message: exercise,\n      data: { type: args.type, exercise }\n    };\n  }\n\n  // üîä –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏\n  private static async adjustVolume(args: { track: string; level: number }): Promise<ActionResponse> {\n    const { track, level } = args;\n    \n    if (level < 0 || level > 100) {\n      return {\n        success: false,\n        message: '–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 0 –¥–æ 100'\n      };\n    }\n\n    // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∞—à–∏–º–∏ –∞—É–¥–∏–æ —Ç—Ä–µ–∫-—Å–ª–∞–π–¥–µ—Ä–∞–º–∏\n    const volumeControl = document.querySelector(`[data-track=\"${track}\"]`) as HTMLInputElement;\n    if (volumeControl) {\n      volumeControl.value = String(level);\n      volumeControl.dispatchEvent(new Event('input', { bubbles: true }));\n    }\n\n    return {\n      success: true,\n      message: `–ì—Ä–æ–º–∫–æ—Å—Ç—å ${track} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ ${level}%`,\n      data: { track, level }\n    };\n  }\n}\n","export class PerformanceMonitor {\n  static measureChatOpen(): void {\n    performance.mark('chat-open-start');\n  }\n\n  static measureChatOpened(): void {\n    performance.mark('chat-open-end');\n    performance.measure('chat-open-duration', 'chat-open-start', 'chat-open-end');\n    \n    const measure = performance.getEntriesByName('chat-open-duration')[0];\n    console.log(`‚úÖ Chat opened in ${measure.duration.toFixed(2)}ms`);\n    \n    // ‚ùå FAIL –µ—Å–ª–∏ > 150ms\n    if (measure.duration > 150) {\n      console.warn('‚ö†Ô∏è Chat open time exceeded 150ms threshold');\n    }\n  }\n\n  static measureFirstToken(): void {\n    performance.mark('first-token');\n    performance.measure('time-to-first-token', 'message-sent', 'first-token');\n    \n    const measure = performance.getEntriesByName('time-to-first-token')[0];\n    console.log(`‚úÖ First token in ${measure.duration.toFixed(2)}ms`);\n  }\n}\n","let locked = false;\nlet scrollY = 0;\n\nexport function lockScroll() {\n  if (locked) return;\n  locked = true;\n  scrollY = window.scrollY || window.pageYOffset;\n\n  // 1) —Å—Ç–∞–±–∏–ª–∏–∑—É–µ–º —à–∏—Ä–∏–Ω—É: —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ —Å–∫—Ä–æ–ª–ª–±–∞—Ä –≤—Å–µ–≥–¥–∞\n  document.documentElement.style.scrollbarGutter = \"stable both-edges\";\n\n  // 2) —Ñ–∏–∫—Å–∏—Ä—É–µ–º body, –Ω–µ —Å–∫—Ä—ã–≤–∞—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä —É –∫–æ—Ä–Ω—è\n  document.body.style.position = \"fixed\";\n  document.body.style.top = `-${scrollY}px`;\n  document.body.style.left = \"0\";\n  document.body.style.right = \"0\";\n  document.body.style.width = \"100%\";\n}\n\nexport function unlockScroll() {\n  if (!locked) return;\n  locked = false;\n\n  document.body.style.position = \"\";\n  document.body.style.top = \"\";\n  document.body.style.left = \"\";\n  document.body.style.right = \"\";\n  document.body.style.width = \"\";\n\n  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ –ø—Ä–µ–∂–Ω–µ–µ –º–µ—Å—Ç–æ\n  window.scrollTo(0, scrollY);\n\n  // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π gutter –≥–ª–æ–±–∞–ª—å–Ω–æ:\n  // document.documentElement.style.scrollbarGutter = \"\";\n}\n","import { aiHub } from '../ai/registry';\nimport { streamOpenAI } from '../utils/stream-openai';\nimport { VoiceInput } from '../utils/voice-input';\nimport { AI_ActionExecutor } from '../ai/action-executor';\nimport { PerformanceMonitor } from '../utils/performance-monitor';\nimport { lockScroll, unlockScroll } from '../utils/scroll-lock'; // –ò–º–ø–æ—Ä—Ç scroll-lock\n\nexport class AIChatUI {\n  private chatWindow: HTMLElement;\n  private messagesContainer: HTMLElement;\n  private inputField: HTMLInputElement;\n  private sendButton: HTMLButtonElement;\n  private voiceButton: HTMLButtonElement;\n  private modelSwitchButton: HTMLButtonElement;\n  private closeButton: HTMLButtonElement;\n  private chatTitleText: HTMLElement;\n  private appRoot: HTMLElement | null; // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ app-root\n\n  private isOpen = false;\n  private isStreaming = false;\n  private abortController: AbortController | null = null;\n  private currentMessageElement: HTMLElement | null = null;\n  private voiceInput: VoiceInput; // –¢–∏–ø VoiceInput —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω\n\n  constructor() {\n    this.chatWindow = document.getElementById('ai-chat-window')!;\n    this.messagesContainer = document.getElementById('ai-chat-messages')!;\n    this.inputField = document.getElementById('ai-input') as HTMLInputElement;\n    this.sendButton = document.getElementById('ai-send-button') as HTMLButtonElement;\n    this.voiceButton = this.chatWindow.querySelector('.ai-voice-btn')!;\n    this.modelSwitchButton = this.chatWindow.querySelector('.ai-model-switch-btn')!;\n    this.closeButton = this.chatWindow.querySelector('.ai-close-btn')!;\n    this.chatTitleText = document.getElementById('ai-chat-title-text')!;\n    this.appRoot = document.getElementById('app-root'); // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ app-root\n\n    this.voiceInput = new VoiceInput({\n      onPartial: (text) => {\n        this.inputField.value = text;\n      },\n      onFinal: (text) => {\n        this.inputField.value = text;\n        this.handleSend();\n      },\n    });\n\n    if (!this.chatWindow || !this.messagesContainer || !this.inputField || !this.sendButton || !this.voiceButton || !this.modelSwitchButton || !this.closeButton || !this.chatTitleText || !this.appRoot) {\n      console.error('‚ùå AIChatUI: –û—à–∏–±–∫–∞! –ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ UI —á–∞—Ç–∞ –∏–ª–∏ #app-root.');\n      return;\n    }\n\n    this.init();\n  }\n\n  private init() {\n    this.setupEventListeners();\n    this.subscribeToModelChanges();\n    this.updateOperatorButtonUI(aiHub.getActiveModel()?.shortName || null);\n  }\n\n  // –°–¢–†–ï–õ–û–ß–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–ô\n  private handleSend = async (): Promise<void> => {\n    const messageText = this.inputField.value.trim();\n    if (!messageText || this.isStreaming) return;\n\n    const provider = aiHub.getActiveProvider();\n    const activeModel = aiHub.getActiveModel();\n\n    if (!provider || !activeModel) {\n      this.addSystemMessage('‚ö†Ô∏è –ú–æ–¥–µ–ª—å AI –Ω–µ –≤—ã–±—Ä–∞–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å.');\n      return;\n    }\n\n    this.addMessage(messageText, 'user');\n    this.inputField.value = '';\n    this.sendButton.disabled = true;\n    this.inputField.disabled = true;\n\n    const aiMessageEl = this.addMessage('', 'ai', true);\n    this.currentMessageElement = aiMessageEl;\n\n    this.abortController = new AbortController();\n    performance.mark('message-sent');\n\n    try {\n      this.isStreaming = true;\n\n      const response = await fetch('/api/gateway/chat', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          model: activeModel.id,\n          messages: [{ role: 'user', content: messageText }], // TODO: implement history\n          stream: true,\n        }),\n        signal: this.abortController.signal,\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        throw new Error(`HTTP ${response.status}: ${this.mapError(response.status)} - ${errorText}`);\n      }\n\n      let fullText = '';\n      let isFirstToken = true;\n\n      for await (const chunk of streamOpenAI(response.body!)) {\n        if (isFirstToken) {\n          PerformanceMonitor.measureFirstToken();\n          this.updateMessage(aiMessageEl, '', false); // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä \"–¥—É–º–∞–µ—Ç\" –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–æ–∫–µ–Ω–∞\n          isFirstToken = false;\n        }\n        fullText += chunk;\n        this.updateMessage(aiMessageEl, fullText, false);\n      }\n\n      this.checkForToolCalls(fullText);\n\n    } catch (error: any) {\n      if (error.name === 'AbortError') {\n        this.updateMessage(aiMessageEl, '‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', false);\n      } else {\n        console.error('AI Chat Error:', error);\n        this.updateMessage(aiMessageEl, `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, false);\n      }\n    } finally {\n      this.isStreaming = false;\n      this.sendButton.disabled = false;\n      this.inputField.disabled = false;\n      this.abortController = null;\n      this.currentMessageElement = null;\n      this.inputField.focus();\n    }\n  };\n\n  private setupEventListeners(): void {\n    document.getElementById('toggle-loopblock-mode')?.addEventListener('click', () => this.toggleChat());\n    this.sendButton.addEventListener('click', this.handleSend); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é\n    this.inputField.addEventListener('keypress', (e) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        this.handleSend(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é\n      }\n    });\n    this.closeButton.addEventListener('click', () => this.closeChat());\n    this.voiceButton.addEventListener('click', () => this.toggleVoiceInput());\n\n    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–º–µ–Ω—ã –º–æ–¥–µ–ª–∏ (–æ—Ç–∫—Ä–æ–µ—Ç ModelDropdownUI)\n    this.modelSwitchButton.addEventListener('click', (e) => {\n      e.stopPropagation();\n      const picker = document.getElementById('belive-ai-picker');\n      if (picker) {\n        const rect = this.modelSwitchButton.getBoundingClientRect();\n        Object.assign(picker.style, {\n          position: 'fixed',\n          left: `${rect.left}px`,\n          top: `${rect.bottom + 8}px`,\n          transform: 'translateY(0)',\n          opacity: '1',\n          pointerEvents: 'all',\n        });\n        picker.classList.toggle('active');\n      }\n    });\n\n    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Esc\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape' && this.isOpen) {\n        e.preventDefault();\n        this.closeChat();\n      }\n    });\n\n    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ —á–∞—Ç–∞ (overlay)\n    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è fixed —ç–ª–µ–º–µ–Ω—Ç–∞, —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø—Ä—è–º–æ –≤ body, overlay –Ω–µ –Ω—É–∂–µ–Ω, \n    // —Ç–∞–∫ –∫–∞–∫ —Å–∞–º —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç—Å—è.\n    // –ù–æ –¥–ª—è Modal Picker, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤–µ—Ä—Ö —á–∞—Ç–∞, —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ.\n  }\n\n  private subscribeToModelChanges(): void {\n    aiHub.on('modelChanged', (event: Event) => {\n      const customEvent = event as CustomEvent;\n      const newModel = customEvent.detail;\n      if (newModel) {\n        this.addSystemMessage(`‚úÖ –ú–æ–¥–µ–ª—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞: ${newModel.shortName}`);\n        this.chatTitleText.textContent = `AI –û–ø–µ—Ä–∞—Ç–æ—Ä (${newModel.shortName})`;\n      } else {\n        this.addSystemMessage('‚ö†Ô∏è –ú–æ–¥–µ–ª—å AI –Ω–µ –≤—ã–±—Ä–∞–Ω–∞.');\n        this.chatTitleText.textContent = 'AI –û–ø–µ—Ä–∞—Ç–æ—Ä';\n      }\n      this.updateOperatorButtonUI(newModel?.shortName || null);\n    });\n  }\n\n  private updateOperatorButtonUI(modelName: string | null): void {\n    const operatorButton = document.getElementById('toggle-loopblock-mode');\n    if (operatorButton) {\n        if (modelName) {\n            operatorButton.innerHTML = `<span class=\"operator-text\">${modelName}</span>`;\n            operatorButton.classList.add('ai-active');\n        } else {\n            operatorButton.innerHTML = `<span class=\"operator-text\">Operator</span>`;\n            operatorButton.classList.remove('ai-active');\n        }\n    }\n  }\n\n  public toggleChat(): void {\n    console.log('üí¨ AIChatUI: toggleChat called.');\n    this.isOpen ? this.closeChat() : this.openChat();\n  }\n\n  public openChat(): void {\n    console.log('üí¨ AIChatUI: openChat called.');\n    PerformanceMonitor.measureChatOpen();\n    this.isOpen = true;\n    this.chatWindow.classList.add('active');\n    this.chatWindow.classList.remove('hidden');\n\n    // –ù–û–í–´–ô SCROLL LOCK\n    lockScroll();\n    if (this.appRoot) {\n      this.appRoot.setAttribute('inert', ''); // –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–æ–Ω–∞\n    }\n\n    this.inputField.focus();\n\n    if (this.messagesContainer.children.length === 0) {\n      this.addSystemMessage('üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI –û–ø–µ—Ä–∞—Ç–æ—Ä beLive. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?');\n    }\n    requestAnimationFrame(() => {\n      PerformanceMonitor.measureChatOpened();\n      this.afterOpenLayoutFix(); // –§–∏–∫—Å –æ–±—Ä–µ–∑–∞–Ω–∏—è\n    });\n  }\n\n  public closeChat(): void {\n    console.log('üí¨ AIChatUI: closeChat called.');\n    this.isOpen = false;\n    this.chatWindow.classList.remove('active');\n    this.chatWindow.classList.add('hidden');\n\n    // –ù–û–í–´–ô SCROLL UNLOCK\n    unlockScroll();\n    if (this.appRoot) {\n      this.appRoot.removeAttribute('inert'); // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Ñ–æ–Ω–∞\n    }\n\n    if (this.isStreaming && this.abortController) {\n      this.abortController.abort();\n      this.isStreaming = false;\n      this.sendButton.disabled = false;\n      this.inputField.disabled = false;\n      if (this.currentMessageElement) {\n          this.updateMessage(this.currentMessageElement, '‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', false);\n      }\n    }\n    const picker = document.getElementById('belive-ai-picker');\n    if (picker) picker.classList.remove('active');\n  }\n\n  private afterOpenLayoutFix() {\n    // 1 –∫–∞–¥—Ä ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å—Ç–∏–ª–∏, 2 –∫–∞–¥—Ä ‚Äî —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å scroll\n    requestAnimationFrame(() => {\n      // —Ñ–æ—Ä—Å-—Ä–µ—Ñ–ª–æ—É (–ª—é–±–æ–µ —á—Ç–µ–Ω–∏–µ layout)\n      this.chatWindow.getBoundingClientRect(); // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å chatWindow –≤–º–µ—Å—Ç–æ root\n      const msg = this.messagesContainer; // #ai-chat-window .ai-chat-messages\n      // —Å—Ç—Ä–∞—Ö—É–µ–º—Å—è: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –ø–æ–¥—Ç—è–Ω–µ–º —Å–∫—Ä–æ–ª–ª\n      requestAnimationFrame(() => {\n        msg.scrollTop = msg.scrollHeight;\n      });\n    });\n  }\n\n  private addMessage(text: string, type: 'user' | 'ai', thinking = false): HTMLElement {\n    const msgDiv = document.createElement('div');\n    msgDiv.className = `message ${type}`;\n\n    const contentDiv = document.createElement('div');\n    contentDiv.className = 'message-content';\n\n    if (thinking) {\n      contentDiv.innerHTML = `\n        <div class=\"ai-thinking\">\n          <span></span><span></span><span></span>\n        </div>\n      `;\n    } else {\n      contentDiv.textContent = text;\n    }\n\n    msgDiv.appendChild(contentDiv);\n    this.messagesContainer.appendChild(msgDiv);\n    // this.scrollToBottom(); // –£–¥–∞–ª—è–µ–º, —Ç–∞–∫ –∫–∞–∫ afterOpenLayoutFix –¥–µ–ª–∞–µ—Ç —ç—Ç–æ\n\n    return msgDiv;\n  }\n\n  private updateMessage(msgEl: HTMLElement, text: string, thinking: boolean) {\n    const content = msgEl.querySelector('.message-content')!;\n    if (thinking) {\n      content.innerHTML = `\n        <div class=\"ai-thinking\">\n          <span></span><span></span><span></span>\n        </div>\n      `;\n    } else {\n      content.textContent = text;\n    }\n    this.scrollToBottom();\n  }\n\n  private addSystemMessage(text: string) {\n    const msgDiv = document.createElement('div');\n    msgDiv.className = 'message system';\n    msgDiv.innerHTML = `<div class=\"message-content\">${text}</div>`;\n    this.messagesContainer.appendChild(msgDiv);\n    this.scrollToBottom();\n  }\n\n  private scrollToBottom(): void {\n    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;\n  }\n\n  private toggleVoiceInput(): void {\n    if (this.voiceInput.isActive()) {\n      this.voiceInput.stopRecording();\n      this.voiceButton.classList.remove('recording');\n    } else {\n      // VoiceInput —Ç–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–±—ç–∫–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä\n      const started = this.voiceInput.startRecording(); // –ò–∑–º–µ–Ω–µ–Ω–æ: –Ω–µ –ø–µ—Ä–µ–¥–∞–µ–º –∫–æ–ª–±—ç–∫ –∑–¥–µ—Å—å\n\n      if (started) {\n        this.voiceButton.classList.add('recording');\n        this.addSystemMessage('üé§ –ì–æ–≤–æ—Ä–∏—Ç–µ...');\n      } else {\n        this.addSystemMessage('‚ùå –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');\n      }\n    }\n  }\n\n  private async checkForToolCalls(text: string): Promise<void> {\n    const toolCalls = AI_ActionExecutor.parseToolCalls(text);\n\n    if (toolCalls.length > 0) {\n      for (const call of toolCalls) {\n        const result = await AI_ActionExecutor.execute(call);\n        const emoji = result.success ? '‚úÖ' : '‚ùå';\n        this.addSystemMessage(`${emoji} ${result.message}`);\n      }\n    }\n  }\n\n  private mapError(status: number): string {\n    if (status === 401 || status === 403) return \"–ù—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –≤–æ–π—Ç–∏.\";\n    if (status === 429) return \"–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥‚Ä¶\";\n    if (status >= 500) return \"–°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.\";\n    return \"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.\";\n  }\n}\n","import '../css/main.css'; // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å\nimport '../css/ai-chat.css'; // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å\nimport '../css/avatar-studio.css'; // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å\n\nimport { aiHub } from './js/ai/registry';\nimport { GatewayProvider } from './js/ai/providers/gateway-provider';\nimport { ModelDropdownUI } from './js/ui/model-dropdown-ui'; // –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç\nimport { AIChatUI } from './js/ui/ai-chat-ui'; // –ù–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç\n\ndeclare global { interface Window { __BELIVE_BOOTED__?: boolean } }\n\ndocument.addEventListener('DOMContentLoaded', async () => {\n  if (window.__BELIVE_BOOTED__) return; // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –≥–∞—Ä–¥ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏\n  window.__BELIVE_BOOTED__ = true;\n\n  const GATEWAY_URL = import.meta.env.VITE_GATEWAY_URL || 'http://localhost:8787'; // Use environment variable or default\n  const gatewayProvider = new GatewayProvider(GATEWAY_URL);\n  aiHub.register(gatewayProvider);\n\n  new AIChatUI(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AIChatUI\n  new ModelDropdownUI(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ModelDropdownUI\n\n  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ AI Operator. –¢–µ–ø–µ—Ä—å –æ–Ω –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —á–∞—Ç.\n  const aiOperatorButton = document.getElementById('toggle-loopblock-mode');\n  if (aiOperatorButton) {\n    // console.log('‚úÖ Found AI Operator button'); // –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ\n    // aiOperatorButton.addEventListener('click', () => { // –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫\n    //   console.log('‚ö° AI Operator button clicked!');\n    //   aiChatUI.toggleChat(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —á–∞—Ç–∞\n    // });\n  }\n\n  // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –∫–Ω–æ–ø–∫–∏ \"Operator\"\n  aiHub.on('modelChanged', (event: Event) => {\n      const customEvent = event as CustomEvent;\n      const activeModel = customEvent.detail;\n      const operatorButton = document.getElementById('toggle-loopblock-mode');\n      if (operatorButton) {\n          if (activeModel) {\n              operatorButton.innerHTML = `<span class=\"operator-text\">${activeModel.shortName}</span>`;\n              operatorButton.classList.add('ai-active');\n          } else {\n              operatorButton.innerHTML = `<span class=\"operator-text\">Operator</span>`;\n              operatorButton.classList.remove('ai-active');\n          }\n      }\n  });\n\n  // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ\n  const initialActiveModel = aiHub.getActiveModel();\n  const operatorButton = document.getElementById('toggle-loopblock-mode');\n  if (operatorButton) {\n      if (initialActiveModel) {\n          operatorButton.innerHTML = `<span class=\"operator-text\">${initialActiveModel.shortName}</span>`;\n          operatorButton.classList.add('ai-active');\n      } else {\n          operatorButton.innerHTML = `<span class=\"operator-text\">Operator</span>`;\n          operatorButton.classList.remove('ai-active');\n      }\n  }\n});\n"],"names":["PitchDetector","AudioExporter","engine","markerManager","lyricsDisplay","blockLoopControl","__publicField","_a","blockIds","onProgress","instBuf","vocBuf","sampleRate","segments","rate","gI","_b","gV","_d","_c","totalOutSec","acc","s","channels","length","off","instMaster","vocMaster","timeline","fade","seg","srcDur","outDur","src","gain","rendered","mp3Blob","filename","blocks","idSet","ordered","b","out","r","block","markers","firstLine","lastLine","startM","m","endM","dur","srcInst","srcVoc","_f","_e","_h","_g","sr","url","type","res","arr","e","title","bpmSuffix","left","right","numChannels","numSamples","dataLength","buffer","view","writeString","offset","string","i","floatTo16BitPCM","output","input","sL","sR","audioBuffer","bitrate","resolve","reject","worker","CHUNK","l","pos","parts","floatTo16","f32","i16","msg","p","pump","end","l16","r16","ready","t","subL","subR","mp3Data","ac","probeExportSum","probeRecNode","probeSink","probeChunks","probeFrames","onMsg","probeOsc","probeG","format","muteDuringExport","signal","N","L","R","testBlob","he","pickFirst","cands","v","instrumentalSrcUrl","vocalsSrcUrl","instEl","onMeta","exportSum","recNode","sink","chunksL","chunksR","allTextBlocks","id","scaleCurve","makeSinCurve","makeCosCurve","elA","createEl","srcA","gA","concatF32","arrs","total","a","wav","float32","interleaved","j","pcm16","blockAlign","byteRate","dataSize","srcUrl","el","n","curve","AIError","code","message","provider","statusCode","AIHub","savedModelId","modelId","newActiveModel","model","eventName","listener","request","callbacks","aiHub","GATEWAY_URL","GatewayProvider","gatewayUrl","now","errorData","data","token","errorText","reader","decoder","fullText","done","value","lines","line","jsonStr","event","_i","_j","ModelDropdownUI","models","activeModelId","modelItem","anchor","rect","streamOpenAI","body","content","VoiceInput","opts","SpeechRecognition","transcript","isFinal","result","AI_ActionExecutor","aiResponse","calls","regex","match","parsed","toolCall","error","args","bpm","metronomeEl","exercise","track","level","volumeControl","PerformanceMonitor","measure","locked","scrollY","lockScroll","unlockScroll","AIChatUI","messageText","activeModel","aiMessageEl","response","isFirstToken","chunk","text","picker","newModel","modelName","operatorButton","thinking","msgDiv","contentDiv","msgEl","toolCalls","call","emoji","status","gatewayProvider","initialActiveModel"],"mappings":"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"}