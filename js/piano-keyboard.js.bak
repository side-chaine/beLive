/**
 * üéπ Piano Keyboard Integration Module for beLive
 * –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ä–µ–∂–∏–º–æ–≤
 */

class PianoKeyboard {
    constructor() {
        this.isActive = false;
        this.canvas = null;
        this.ctx = null;
        this.renderLoop = null;
        
        // –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ –∑–≤—É–∫–∞
        this.audioContext = null;
        this.analyser = null;
        this.pitchDetector = null;
        this.inputBuffer = null;
        this.bufferSize = 2048;
        
        // üéØ –†–ï–í–û–õ–Æ–¶–ò–û–ù–ù–ê–Ø –ú–û–ù–û–§–û–ù–ò–ß–ï–°–ö–ê–Ø –°–ò–°–¢–ï–ú–ê - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –Ω–æ—Ç–∞!
        this.currentActiveNote = null; // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–∞—è –Ω–æ—Ç–∞
        this.pressedKeys = new Set(); // Set –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        this.activeNotes = new Map(); // Map –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        
        // ‚ö° –°–ò–°–¢–ï–ú–ê –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ì–û –®–ê–†–ò–ö–ê —Å –ø–ª–∞–≤–Ω—ã–º–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏
        this.singleBallIndicator = null; // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞—Ä–∏–∫-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        this.ballAnimation = {
            fromX: 0, fromY: 0,
            toX: 0, toY: 0,
            progress: 1.0,
            isAnimating: false,
            startTime: 0,
            duration: 150 // 150–º—Å –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏
        };
        this.lastAnalysisTime = 0;
        this.analysisInterval = 4; // ‚ö° –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø —á–∞—Å—Ç–æ—Ç–∞ - 250fps
        
        // üé≠ –°–∏—Å—Ç–µ–º–∞ –∑–∞—Ö–≤–∞—Ç–∞ –º–∏–∫—Ä–æ-–Ω—é–∞–Ω—Å–æ–≤ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
        this.vocalNuances = {
            vibrato: [], // –ò—Å—Ç–æ—Ä–∏—è –≤–∏–±—Ä–∞—Ç–æ
            slides: [], // –°–∫–æ–ª—å–∂–µ–Ω–∏—è –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏
            microTiming: [], // –ú–∏–∫—Ä–æ-—Ç–∞–π–º–∏–Ω–≥–∏
            noteTransitions: [] // –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏
        };
        
        // üîá –°–¢–†–û–ì–ê–Ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
        this.harmonicFilter = {
            lastFundamental: null, // –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞
            octaveHistory: [], // –ò—Å—Ç–æ—Ä–∏—è –æ–∫—Ç–∞–≤–Ω—ã—Ö —Å–∫–∞—á–∫–æ–≤
            noiseThreshold: 0.005, // –ü–æ—Ä–æ–≥ —à—É–º–∞
            harmonicTolerance: 0.02 // 2% —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∫
        };
        
        // üìä –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        this.detectionStats = {
            totalDetections: 0,
            acceptedNotes: 0,
            harmonicsRejected: 0,
            octaveJumpsRejected: 0,
            unstableFrequencyRejected: 0,
            impreciseNotesRejected: 0,
            monophonicFiltered: 0 // üéµ –ù–æ–≤–∞—è –º–µ—Ç—Ä–∏–∫–∞ - –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        };
        
        // üé® –ï–¥–∏–Ω–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (–æ–¥–∏–Ω —Ü–≤–µ—Ç –¥–ª—è —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–∞)
        this.REFERENCE_COLOR = '#00ff41'; // –Ø—Ä–∫–∏–π –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å audioEngine
        this.currentTrackHasVocals = false;
        this.isBackgroundAnalyzing = false;
        
        // –ò—Å—Ç–æ—Ä–∏—è —á–∞—Å—Ç–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
        this.frequencyHistory = [];
        
        this.init();
    }

    async init() {
        console.log('üéπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã...');
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ Pitchy
        await this.waitForPitchy();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.setupEventListeners();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ audioEngine
        this.setupAutoAudioEngineIntegration();
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏—à–∏
        this.keys = this.generatePianoKeys();
        
        console.log('üéπ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞');
    }

    async waitForPitchy() {
        return new Promise((resolve) => {
            const check = () => {
                if (window.PitchDetector) {
                    console.log('‚úÖ Pitchy –≥–æ—Ç–æ–≤ –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã');
                    resolve();
                } else {
                    setTimeout(check, 100);
                }
            };
            check();
        });
    }

    setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        this.keydownHandler = (e) => {
            if (e.code === 'Escape') {
                this.hide();
                e.preventDefault();
            }
        };
        
        this.keyupHandler = (e) => {
            // –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ canvas
        this.clickHandler = (e) => {
            if (!this.canvas) return;
            
            const rect = this.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è (–≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)
            const closeButtonSize = 50;
            const closeButtonX = this.canvas.width - closeButtonSize;
            const closeButtonY = 0;
            
            if (x >= closeButtonX && x <= closeButtonX + closeButtonSize && 
                y >= closeButtonY && y <= closeButtonY + closeButtonSize) {
                this.hide();
                return;
            }
            
            // üéõÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            this.handleControlPanelClick(x, y);
        };
        
        document.addEventListener('keydown', this.keydownHandler);
        document.addEventListener('keyup', this.keyupHandler);

        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø–∏–∞–Ω–∏–Ω–æ
        const initPianoButton = () => {
            const pianoBtn = document.getElementById('piano-keyboard-btn');
            if (pianoBtn) {
                console.log('üéπ –ö–Ω–æ–ø–∫–∞ –ø–∏–∞–Ω–∏–Ω–æ –Ω–∞–π–¥–µ–Ω–∞, –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫');
                pianoBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('üéπ –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –ø–∏–∞–Ω–∏–Ω–æ');
                    this.toggle();
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
                pianoBtn.style.background = '#4CAF50';
                pianoBtn.style.color = '#ffffff';
                
                return true;
            } else {
                console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –ø–∏–∞–Ω–∏–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return false;
            }
        };
        
        // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É
        if (!initPianoButton()) {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∂–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initPianoButton);
            } else {
                // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
                setTimeout(initPianoButton, 1000);
            }
        }
    }

    setupCanvas() {
        // –°–æ–∑–¥–∞–µ–º canvas —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (!this.canvas) {
            this.canvas = document.createElement('canvas');
            this.canvas.id = 'piano-canvas';
            this.canvas.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                z-index: 9999 !important;
                background: rgba(0, 0, 0, 0.85) !important;
                backdrop-filter: blur(5px) !important;
                display: block !important;
                pointer-events: all !important;
            `;
            document.body.appendChild(this.canvas);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º canvas
            this.canvas.style.display = 'block';
            this.canvas.style.visibility = 'visible';
            this.canvas.style.opacity = '1';
        }
        
        this.ctx = this.canvas.getContext('2d');
        if (!this.ctx) {
            console.error('üéπ –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å 2D –∫–æ–Ω—Ç–µ–∫—Å—Ç');
            return;
        }
        
        console.log('üéπ Canvas –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        const resize = () => {
            if (!this.canvas) return;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
            
            console.log(`üéπ Canvas —Ä–∞–∑–º–µ—Ä: ${this.canvas.width}x${this.canvas.height}`);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
            if (this.isActive) {
                this.drawVisualization();
            }
        };
        
        resize();
        window.addEventListener('resize', resize);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ canvas
        if (this.canvas) {
            this.canvas.addEventListener('click', this.clickHandler);
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
        setTimeout(() => {
            if (this.isActive) {
                this.drawVisualization();
            }
        }, 100);
    }

    setupAudioContext() {
        console.log('üîä –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞...');
        
        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º audioEngine –∫–æ–Ω—Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            if (window.audioEngine && window.audioEngine.audioContext) {
                this.audioContext = window.audioEngine.audioContext;
                console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º audioEngine.audioContext');
            } else {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    this.audioContext = new AudioContext();
                    console.log('‚úÖ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π AudioContext');
                } else {
                    console.error('‚ùå AudioContext –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    return false;
                }
            }

            // –°–æ–∑–¥–∞–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.fftSize = this.bufferSize;
            this.analyser.smoothingTimeConstant = 0.0;
            
            // –°–æ–∑–¥–∞–µ–º –±—É—Ñ–µ—Ä—ã
            this.inputBuffer = new Float32Array(this.analyser.fftSize);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Pitchy –¥–µ—Ç–µ–∫—Ç–æ—Ä
            if (window.PitchDetector) {
                this.pitchDetector = window.PitchDetector.forFloat32Array(this.bufferSize);
                console.log('‚úÖ Pitchy –¥–µ—Ç–µ–∫—Ç–æ—Ä –≥–æ—Ç–æ–≤');
            } else {
                console.error('‚ùå PitchDetector –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return false;
            }
            
            return true;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ:', error);
            return false;
        }
    }

    setupAutoAudioEngineIntegration() {
        console.log('üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å audioEngine...');
        
        // üéØ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞ - –≤—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
        let hasVocals = false;
        
        if (window.audioEngine) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏
                if (typeof window.audioEngine.hasVocals === 'function') {
                    hasVocals = window.audioEngine.hasVocals();
                    console.log(`üé§ hasVocals() –≤–µ—Ä–Ω—É–ª: ${hasVocals}`);
                } else {
                    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ vocalsGain
                    hasVocals = !!(window.audioEngine.vocalsGain || window.audioEngine._hasVocals);
                    console.log(`üé§ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∫–∞–ª–æ–≤: ${hasVocals}`);
                }
                
                // üöÄ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û–ï –≤–∫–ª—é—á–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å –ª—é–±–æ–π –∑–≤—É–∫
                if (!hasVocals && window.audioEngine._isPlaying) {
                    hasVocals = true;
                    console.log(`üé§ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ (—Ç—Ä–µ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è)`);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∫–∞–ª—å–Ω—ã—Ö –¥–æ—Ä–æ–∂–µ–∫:', error);
                // üöÄ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å audioEngine
                hasVocals = true;
                console.log(`üé§ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏–∑–∞ (–µ—Å—Ç—å audioEngine)`);
            }
        } else {
            console.warn('‚ö†Ô∏è audioEngine –Ω–µ –Ω–∞–π–¥–µ–Ω');
            // üöÄ –ü—Ä–æ–±—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫–∞–∫ fallback
            hasVocals = true;
            console.log(`üé§ –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞`);
        }
        
        this.currentTrackHasVocals = hasVocals;
        console.log(`üé§ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ${this.currentTrackHasVocals}`);
        
        // üöÄ –í–°–ï–ì–î–ê –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        setTimeout(() => {
            this.startBackgroundVocalAnalysis();
        }, 500);
    }

    async startBackgroundVocalAnalysis() {
        console.log('üé§ –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏...');
        
        try {
            if (!this.audioContext) {
                const setupResult = this.setupAudioContext();
                if (!setupResult) {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É–¥–∏–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç');
                    return;
                }
            }

            // üéØ –ü–†–ò–û–†–ò–¢–ï–¢–ù–û–ï –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–µ
            let connected = false;
            
            if (window.audioEngine) {
                // üéµ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –≤–æ–∫–∞–ª—å–Ω—ã–º —É–∑–ª–∞–º
                const vocalNodes = [
                    window.audioEngine.vocalsGain,
                    window.audioEngine.masterGain,
                    window.audioEngine.outputGain
                ];
                
                for (const node of vocalNodes) {
                    if (node && typeof node.connect === 'function') {
                        try {
                            // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                            if (this.analyser) {
                                this.analyser.disconnect();
                            }
                            
                            node.connect(this.analyser);
                            console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –í–û–ö–ê–õ–¨–ù–û–ú–£ —É–∑–ª—É:`, node.constructor.name);
                            connected = true;
                            break;
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –≤–æ–∫–∞–ª—å–Ω–æ–º—É —É–∑–ª—É ${node.constructor.name}:`, error);
                        }
                    }
                }
                
                // üéµ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º —É–∑–ª–∞–º (–µ—Å–ª–∏ –≤–æ–∫–∞–ª –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
                if (!connected) {
                    const instrumentalNodes = [
                        window.audioEngine.instrumentalsGain,
                        window.audioEngine._audioSource,
                        window.audioEngine.gainNode
                    ];
                    
                    for (const node of instrumentalNodes) {
                        if (node && typeof node.connect === 'function') {
                            try {
                                node.connect(this.analyser);
                                console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–º—É —É–∑–ª—É:`, node.constructor.name);
                                connected = true;
                                break;
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ–º—É —É–∑–ª—É ${node.constructor.name}:`, error);
                            }
                        }
                    }
                }
                
                // üéØ –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ destination
                if (!connected && this.audioContext) {
                    try {
                        const mediaSource = this.audioContext.createMediaElementSource(window.audioEngine.audio || document.createElement('audio'));
                        mediaSource.connect(this.analyser);
                        this.analyser.connect(this.audioContext.destination);
                        console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ MediaElementSource`);
                        connected = true;
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è MediaElementSource –Ω–µ —É–¥–∞–ª—Å—è:`, error);
                    }
                }
            }
            
            // üé§ Fallback: –º–∏–∫—Ä–æ—Ñ–æ–Ω –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ—Ç audioEngine
            if (!connected && !window.audioEngine) {
                console.log('üé§ –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (–Ω–µ—Ç audioEngine)...');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { 
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            sampleRate: 44100
                        } 
                    });
                    const micSource = this.audioContext.createMediaStreamSource(stream);
                    micSource.connect(this.analyser);
                    console.log(`‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (fallback)`);
                    connected = true;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`, error);
                }
            }
            
            if (connected) {
                this.isBackgroundAnalyzing = true;
                this.startConditionalAnalysis();
                console.log('‚úÖ –§–æ–Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω');
            } else {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∏ –∫ –æ–¥–Ω–æ–º—É –∞—É–¥–∏–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É');
                // üöÄ –í—Å–µ —Ä–∞–≤–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ - –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø–æ–∑–∂–µ
                this.isBackgroundAnalyzing = true;
                this.startConditionalAnalysis();
                console.log('‚ö° –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞:', error);
            // üöÄ –í—Å–µ —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å
            this.isBackgroundAnalyzing = true;
            this.startConditionalAnalysis();
            console.log('‚ö° –ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω –∞–≤–∞—Ä–∏–π–Ω–æ');
        }
    }

    startConditionalAnalysis() {
        if (!this.isBackgroundAnalyzing) return;
        
        // ‚ö° –°–£–ü–ï–†-–ë–´–°–¢–†–´–ô –∞–Ω–∞–ª–∏–∑ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ "–∏–≥—Ä—ã –Ω–∞ –ø–∏–∞–Ω–∏–Ω–æ –≥–æ–ª–æ—Å–æ–º"
        const analyze = (timestamp) => {
            if (!this.isBackgroundAnalyzing) return;
            
            // ‚ö° –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø —á–∞—Å—Ç–æ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞ - 250fps (4–º—Å)
            if (timestamp - this.lastAnalysisTime >= this.analysisInterval) {
                this.lastAnalysisTime = timestamp;
                
                // üéØ –ù–ï–ü–†–ï–†–´–í–ù–´–ô –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
                if (window.audioEngine && window.audioEngine._isPlaying) {
                    const pitchData = this.detectPitch();
                    if (pitchData) {
                        this.processNote(pitchData);
                        this.updateVocalNuances(pitchData); // üé≠ –ó–∞—Ö–≤–∞—Ç –Ω—é–∞–Ω—Å–æ–≤
                    } else {
                        // üîá –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏—à–∏–Ω—ã
                        this.checkForSilenceInstant(timestamp);
                    }
                } else {
                    // üîá –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                    this.forceStopAllKeys('track_stopped');
                }
            }
            
            // üßπ –ù–ï–ü–†–ï–†–´–í–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∞–≤–∏—à
            this.cleanupInactiveKeysInstant(timestamp);
            
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑ –Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
            requestAnimationFrame(analyze);
        };
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Å—É–ø–µ—Ä-–±—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑
        requestAnimationFrame(analyze);
    }

    // üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏—à–∏–Ω—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–æ—Ç
    checkForSilence(currentTime) {
        if (!this.inputBuffer) return;
        
        this.analyser.getFloatTimeDomainData(this.inputBuffer);
        
        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ RMS –∞–º–ø–ª–∏—Ç—É–¥—ã
        let rms = 0;
        for (let i = 0; i < this.inputBuffer.length; i++) {
            rms += this.inputBuffer[i] * this.inputBuffer[i];
        }
        rms = Math.sqrt(rms / this.inputBuffer.length);
        
        // üîá –¢–û–õ–¨–ö–û –ø—Ä–∏ –ø–æ–ª–Ω–æ–π —Ç–∏—à–∏–Ω–µ –æ—Ç–∫–ª—é—á–∞–µ–º –í–°–ï –∫–ª–∞–≤–∏—à–∏
        const silenceThreshold = 0.002; // –°–Ω–∏–∑–∏–ª–∏ –ø–æ—Ä–æ–≥ —Ç–∏—à–∏–Ω—ã
        if (rms < silenceThreshold) {
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ç–∏—à–∏–Ω–∞
            let silenceCount = 0;
            if (!this.silenceHistory) this.silenceHistory = [];
            
            this.silenceHistory.push(rms);
            if (this.silenceHistory.length > 5) {
                this.silenceHistory.shift();
            }
            
            // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∑–∞–º–µ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–∏—à–∏–Ω—É
            for (const silence of this.silenceHistory) {
                if (silence < silenceThreshold) silenceCount++;
            }
            
            if (silenceCount >= 4 && this.pressedKeys.size > 0) {
                console.log(`üîá –ì–ª—É–±–æ–∫–∞—è —Ç–∏—à–∏–Ω–∞: –æ—á–∏—Å—Ç–∫–∞ ${this.pressedKeys.size} –Ω–æ—Ç`);
                this.pressedKeys.clear();
                this.activeNotes.clear(); // üéØ –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ activeNotes
            }
        }
    }

    // üîá –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–ª–∞–≤–∏—à –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
    forceStopAllKeys(reason = 'manual') {
        if (this.currentActiveNote || this.pressedKeys.size > 0) {
            console.log(`üîá –ú–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (${reason}): ${this.pressedKeys.size} –∫–ª–∞–≤–∏—à`);
            this.currentActiveNote = null;
            this.singleBallIndicator = null; // üéØ –û—á–∏—â–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞—Ä–∏–∫
            this.pressedKeys.clear();
            this.activeNotes.clear();
            this.ballAnimation.isAnimating = false; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            this.harmonicFilter.lastFundamental = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
        }
    }

    stopBackgroundAnalysis() {
        console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞');
        this.isBackgroundAnalyzing = false;
    }

    toggle() {
        if (this.isActive) {
            this.hide();
        } else {
            this.show();
        }
    }

    show() {
        console.log('üéπ –ó–∞–ø—É—Å–∫ Pitchy –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã...');
        
        if (this.isActive) {
            console.log('‚ö†Ô∏è –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞');
            return;
        }

        this.setupCanvas();
        this.setupAudioContext();
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        this.updateAudioEngineStatus();
        
        this.startRender();
        this.isActive = true;
        
        console.log('‚úÖ Pitchy –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ');
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ audioEngine
    updateAudioEngineStatus() {
        console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ audioEngine...');
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∞–Ω–∞–ª–∏–∑ –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
        if (this.isBackgroundAnalyzing) {
            this.stopBackgroundAnalysis();
        }
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
        this.setupAutoAudioEngineIntegration();
    }

    hide() {
        console.log('üéπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Pitchy –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã...');
        
        this.isActive = false;
        this.stopBackgroundAnalysis();
        
        if (this.renderLoop) {
            clearTimeout(this.renderLoop);
            this.renderLoop = null;
        }
        
        if (this.canvas && this.canvas.parentNode) {
            this.canvas.parentNode.removeChild(this.canvas);
        }
        
        this.canvas = null;
        this.ctx = null;
        
        document.removeEventListener('keydown', this.keydownHandler);
        document.removeEventListener('keyup', this.keyupHandler);
        
        console.log('‚úÖ Pitchy –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    }

    generatePianoKeys() {
        const keys = [];
        
        // üéπ –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ—Ä—è–¥–æ–∫ –Ω–æ—Ç –≤ –æ–∫—Ç–∞–≤–µ
        const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B']; // 7 –±–µ–ª—ã—Ö –∫–ª–∞–≤–∏—à
        const blackNotes = ['C#', 'D#', 'F#', 'G#', 'A#']; // 5 —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª–∞–≤–∏—à–∏ –æ—Ç C2 –¥–æ C6 (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–æ–∫–∞–ª—å–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)
        for (let octave = 2; octave <= 6; octave++) {
            // –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏ –æ–∫—Ç–∞–≤—ã
            for (const note of whiteNotes) {
                const frequency = this.noteToFrequency(note, octave);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω C2-C6
                if (frequency >= 65.4 && frequency <= 1046.5) { 
                    const key = {
                        note: note,
                        octave: octave,
                        frequency: frequency,
                        isBlack: false,
                        isPressed: false,
                        x: 0, y: 0, width: 0, height: 0
                    };
                    keys.push(key);
                }
            }
            
            // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —á–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –æ–∫—Ç–∞–≤—ã
            for (const note of blackNotes) {
                const frequency = this.noteToFrequency(note, octave);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω C2-C6
                if (frequency >= 65.4 && frequency <= 1046.5) { 
                    const key = {
                        note: note,
                        octave: octave,
                        frequency: frequency,
                        isBlack: true,
                        isPressed: false,
                        x: 0, y: 0, width: 0, height: 0
                    };
                    keys.push(key);
                }
            }
        }
        
        console.log(`üéπ –°–æ–∑–¥–∞–Ω–æ ${keys.length} –∫–ª–∞–≤–∏—à –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞`);
        
        // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∞–≤–∏—à –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
        const firstKeys = keys.slice(0, 12).map(k => `${k.note}${k.octave}${k.isBlack ? '(‚óè)' : ''}`);
        console.log(`üéµ –ü–µ—Ä–≤–∞—è –æ–∫—Ç–∞–≤–∞: ${firstKeys.join(', ')}`);
        
        return keys;
    }

    noteToFrequency(note, octave) {
        const noteToSemitone = {
            'C': 0, 'C#': 1, 'D': 2, 'D#': 3, 'E': 4, 'F': 5,
            'F#': 6, 'G': 7, 'G#': 8, 'A': 9, 'A#': 10, 'B': 11
        };
        
        const semitone = noteToSemitone[note];
        const A4 = 440;
        const midiNumber = octave * 12 + semitone + 12;
        
        return A4 * Math.pow(2, (midiNumber - 69) / 12);
    }

    startRender() {
        if (this.renderLoop) return;
        
        console.log('üéπ –ó–∞–ø—É—Å–∫ —Å—É–ø–µ—Ä-–±—ã—Å—Ç—Ä–æ–≥–æ —Ü–∏–∫–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∞');
        
        const render = () => {
            if (!this.isActive) {
                this.renderLoop = null;
                console.log('üéπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–∏–∫–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∞');
                return;
            }
            
            this.drawVisualization();
            
            // ‚ö° –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π FPS –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
            const hasActiveKeys = this.pressedKeys.size > 0;
            const delay = hasActiveKeys ? 4 : 16; // 250fps –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∞–≤–∏—à, 60fps –≤ –ø–æ–∫–æ–µ
            
            this.renderLoop = setTimeout(() => {
                requestAnimationFrame(render);
            }, delay);
        };
        
        this.renderLoop = requestAnimationFrame(render);
    }

    drawVisualization() {
        if (!this.ctx || !this.canvas) return;
        
        const width = this.canvas.width;
        const height = this.canvas.height;
        
        // –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        this.ctx.fillStyle = '#0a0a0a';
        this.ctx.fillRect(0, 0, width, height);
        
        // –†–∏—Å—É–µ–º –∫–ª–∞–≤–∏—à–∏
        this.drawPianoKeyboard(width, height);
        
        // –†–∏—Å—É–µ–º —á–∞—Å—Ç–∏—Ü—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã
        this.updateAndDrawParticles();
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å
        this.drawInfoPanel(width, height);
    }

    // üéõÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    handleControlPanelClick(x, y) {
        // –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–∫ –ø–æ –æ–±–ª–∞—Å—Ç–∏ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
        const panelY = 50;
        const panelHeight = 200;
        const panelWidth = 280;
        const panelX = 10;
        
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –≤–Ω–µ –ø–∞–Ω–µ–ª–∏ - –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        if (x < panelX || x > panelX + panelWidth || y < panelY || y > panelY + panelHeight) {
            return;
        }
    }

    drawInfoPanel(width, height) {
        // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
        const closeButtonSize = 50;
        const closeButtonX = width - closeButtonSize;
        const closeButtonY = 0;
        
        // –§–æ–Ω –∫–Ω–æ–ø–∫–∏
        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        this.ctx.fillRect(closeButtonX, closeButtonY, closeButtonSize, closeButtonSize);
        
        // –ö—Ä–µ—Å—Ç–∏–∫
        this.ctx.strokeStyle = '#ffffff';
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        this.ctx.moveTo(closeButtonX + 15, closeButtonY + 15);
        this.ctx.lineTo(closeButtonX + 35, closeButtonY + 35);
        this.ctx.moveTo(closeButtonX + 35, closeButtonY + 15);
        this.ctx.lineTo(closeButtonX + 15, closeButtonY + 35);
        this.ctx.stroke();
        
        // üéØ –ü–∞–Ω–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–ª—è –ú–û–ù–û–§–û–ù–ò–ß–ï–°–ö–û–ì–û –∞–Ω–∞–ª–∏–∑–∞
        const panelX = 10;
        const panelY = 50;
        const panelWidth = 300;
        const panelHeight = 240;
        
        // –§–æ–Ω –ø–∞–Ω–µ–ª–∏
        this.ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
        this.ctx.fillRect(panelX, panelY, panelWidth, panelHeight);
        this.ctx.strokeStyle = '#00ff41';
        this.ctx.lineWidth = 2;
        this.ctx.strokeRect(panelX, panelY, panelWidth, panelHeight);
        
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∞–Ω–µ–ª–∏
        this.ctx.fillStyle = '#00ff41';
        this.ctx.font = 'bold 16px Arial';
        this.ctx.textAlign = 'left';
        this.ctx.fillText('üéµ –ú–û–ù–û–§–û–ù–ò–ß–ï–°–ö–ò–ô –ê–Ω–∞–ª–∏–∑ –í–æ–∫–∞–ª–∞', panelX + 10, panelY + 25);
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        const stats = this.detectionStats;
        const successRate = stats.totalDetections > 0 ? (stats.acceptedNotes / stats.totalDetections * 100).toFixed(1) : 0;
        const totalRejected = stats.harmonicsRejected + stats.octaveJumpsRejected + stats.unstableFrequencyRejected + stats.impreciseNotesRejected + stats.monophonicFiltered;
        
        const statsInfo = [
            `üìä –í—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–æ–≤: ${stats.totalDetections}`,
            `‚úÖ –ü—Ä–∏–Ω—è—Ç–æ –Ω–æ—Ç: ${stats.acceptedNotes}`,
            `üö´ –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: ${totalRejected}`,
            `üéØ –ö–∞—á–µ—Å—Ç–≤–æ: ${successRate}%`,
            `üîá –ú–æ–Ω–æ—Ñ–∏–ª—å—Ç—Ä: ${stats.monophonicFiltered}`,
            `üéº –ì–∞—Ä–º–æ–Ω–∏–∫–∏: ${stats.harmonicsRejected}`
        ];
        
        // üéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        if (this.isBackgroundAnalyzing && this.inputBuffer) {
            this.analyser.getFloatTimeDomainData(this.inputBuffer);
            const [frequency, clarity] = this.pitchDetector ? this.pitchDetector.findPitch(this.inputBuffer, this.audioContext.sampleRate) : [0, 0];
            
            let rms = 0;
            for (let i = 0; i < this.inputBuffer.length; i++) {
                rms += this.inputBuffer[i] * this.inputBuffer[i];
            }
            rms = Math.sqrt(rms / this.inputBuffer.length);
            
            statsInfo.push(``, `üîç –¢–ï–ö–£–©–ò–ô –ê–ù–ê–õ–ò–ó:`);
            statsInfo.push(`üì° –ß–∞—Å—Ç–æ—Ç–∞: ${frequency ? frequency.toFixed(1) + 'Hz' : '–¢–∏—à–∏–Ω–∞'}`);
            statsInfo.push(`üéØ –ß–µ—Ç–∫–æ—Å—Ç—å: ${clarity ? (clarity * 100).toFixed(0) + '%' : '0%'}`);
            statsInfo.push(`üìä –°–∏–≥–Ω–∞–ª: ${(rms * 1000).toFixed(1)}`);
            statsInfo.push(`üéπ –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–æ—Ç–∞: ${this.currentActiveNote ? this.currentActiveNote.keyId : '–ù–µ—Ç'}`);
            statsInfo.push(`üéØ –®–∞—Ä–∏–∫: ${this.singleBallIndicator ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ—Ç'}`); // üéØ –°—Ç–∞—Ç—É—Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞
            
            // üé≠ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º —à–∞—Ä–∏–∫–µ
            if (this.singleBallIndicator) {
                statsInfo.push(``, `üéµ –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –®–ê–†–ò–ö:`);
                const sign = this.singleBallIndicator.deviation > 0 ? '+' : '';
                statsInfo.push(`${this.singleBallIndicator.keyId}: ${this.singleBallIndicator.accuracy}% (${sign}${Math.round(this.singleBallIndicator.deviation)}¬¢)`);
                
                if (this.ballAnimation.isAnimating) {
                    const progress = Math.round(this.ballAnimation.progress * 100);
                    statsInfo.push(`üé≠ –ê–Ω–∏–º–∞—Ü–∏—è: ${progress}%`);
                }
            }
            
            // üé≠ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏
            if (this.vocalNuances.noteTransitions.length > 0) {
                const lastTransition = this.vocalNuances.noteTransitions[this.vocalNuances.noteTransitions.length - 1];
                if (lastTransition.fromNote) {
                    statsInfo.push(`üéµ –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–µ—Ä–µ—Ö–æ–¥: ${lastTransition.fromNote} ‚Üí ${lastTransition.toNote}`);
                }
            }
        }
        
        this.ctx.fillStyle = '#cccccc';
        this.ctx.font = '10px Arial';
        statsInfo.forEach((info, index) => {
            if (info.includes('–¢–ï–ö–£–©–ò–ô –ê–ù–ê–õ–ò–ó:') || info.includes('–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –®–ê–†–ò–ö:')) {
                this.ctx.fillStyle = '#FFD700';
                this.ctx.font = 'bold 10px Arial';
            } else if (info.startsWith('üì°') || info.startsWith('üéØ') || info.startsWith('üìä') || info.startsWith('üéπ') || info.startsWith('üé≠')) {
                this.ctx.fillStyle = '#90EE90';
                this.ctx.font = '10px Arial';
            } else {
                this.ctx.fillStyle = '#cccccc';
                this.ctx.font = '10px Arial';
            }
            this.ctx.fillText(info, panelX + 10, panelY + 45 + (index * 12));
        });
        
        // –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö–Ω–∏–π —É–≥–æ–ª)
        this.ctx.fillStyle = this.isBackgroundAnalyzing ? '#00ff41' : '#FF5722';
        this.ctx.font = 'bold 14px Arial';
        this.ctx.textAlign = 'right';
        
        let statusText = '';
        if (this.isBackgroundAnalyzing && window.audioEngine) {
            const currentTime = window.audioEngine.getCurrentTime() || 0;
            const duration = window.audioEngine.duration || 0;
            const timeStr = `${this.formatTime(currentTime)}/${this.formatTime(duration)}`;
            const isPlaying = window.audioEngine._isPlaying || false;
            const playingStatus = isPlaying ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
            statusText = `üé§ –ú–û–ù–û–§–û–ù–ò–ß–ï–°–ö–ò–ô –ê–Ω–∞–ª–∏–∑ | ${playingStatus} ${timeStr}`;
        } else {
            statusText = '–û–∂–∏–¥–∞–Ω–∏–µ –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏...';
        }
        
        this.ctx.fillText(statusText, width - 60, 30);
        
        // –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É)
        this.ctx.fillStyle = '#888888';
        this.ctx.font = '12px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText('ESC –∏–ª–∏ ‚úï –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è | –û–î–ò–ù —à–∞—Ä–∏–∫ = –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∏–π –≥–æ–ª–æ—Å', width / 2, height - 10);
    }

    formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    drawPianoKeyboard(width, height) {
        if (!this.keys || this.keys.length === 0) return;

        // –†–∞–∑–º–µ—â–∞–µ–º –∫–ª–∞–≤–∏—à–∏ –≤–Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞
        const maxKeyboardHeight = 200;
        const keyboardHeight = Math.min(maxKeyboardHeight, height - 120);
        const keyboardY = height - keyboardHeight - 50;
        
        // üéπ –†–ê–ó–î–ï–õ–Ø–ï–ú –∫–ª–∞–≤–∏—à–∏ –Ω–∞ –±–µ–ª—ã–µ –∏ —á–µ—Ä–Ω—ã–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        const whiteKeys = this.keys.filter(k => !k.isBlack);
        const blackKeys = this.keys.filter(k => k.isBlack);
        
        const whiteKeyWidth = width / whiteKeys.length;
        const whiteKeyHeight = keyboardHeight;
        const blackKeyWidth = whiteKeyWidth * 0.6;
        const blackKeyHeight = keyboardHeight * 0.65;

        // üéπ –°–ù–ê–ß–ê–õ–ê —Ä–∏—Å—É–µ–º –í–°–ï –±–µ–ª—ã–µ –∫–ª–∞–≤–∏—à–∏ (–æ–Ω–∏ –∏–¥—É—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ)
        whiteKeys.forEach((key, index) => {
            const x = index * whiteKeyWidth;
            const y = keyboardY;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–∫–æ–≤
            key.x = x;
            key.y = y;
            key.width = whiteKeyWidth;
            key.height = whiteKeyHeight;
            
            const keyId = `${key.note}${key.octave}`;
            const isPressed = this.pressedKeys.has(keyId);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
            let noteColor = this.REFERENCE_COLOR;
            if (isPressed) {
                const activeNote = this.activeNotes.get(keyId);
                if (activeNote && activeNote.pitchAccuracy) {
                    noteColor = this.getPitchAccuracyColor(activeNote.pitchAccuracy);
                }
            }
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–µ–ª–æ–π –∫–ª–∞–≤–∏—à–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
            if (isPressed) {
                // üéØ –ê–∫—Ç–∏–≤–Ω–∞—è –∫–ª–∞–≤–∏—à–∞ - –ü–û–õ–ù–û–ï –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–º —Ç–æ—á–Ω–æ—Å—Ç–∏
                this.ctx.fillStyle = noteColor;
                this.ctx.shadowColor = noteColor;
                this.ctx.shadowBlur = 25;
                this.ctx.globalAlpha = 0.9;
                this.ctx.fillRect(x, y, whiteKeyWidth, whiteKeyHeight); // –£–±—Ä–∞–ª–∏ –æ—Ç—Å—Ç—É–ø—ã!
                this.ctx.shadowBlur = 0;
                this.ctx.globalAlpha = 1.0;
            } else {
                // ‚ö™ –û–±—ã—á–Ω–∞—è –±–µ–ª–∞—è –∫–ª–∞–≤–∏—à–∞ —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
                this.ctx.fillStyle = '#ffffff';
                this.ctx.shadowBlur = 0;
                this.ctx.globalAlpha = 1.0;
                this.ctx.fillRect(x + 1, y, whiteKeyWidth - 3, whiteKeyHeight);
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∞–≤–∏—à
            if (!isPressed) {
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –∏ —Ç–µ–Ω–∏ –¥–ª—è –æ–±—ä–µ–º–∞
                this.ctx.fillStyle = '#e8e8e8';
                this.ctx.fillRect(x + 1, y + whiteKeyHeight - 15, whiteKeyWidth - 3, 15);
                
                this.ctx.fillStyle = '#f8f8f8';
                this.ctx.fillRect(x + 1, y, whiteKeyWidth - 3, 20);
                
                // –û–±–≤–æ–¥–∫–∞
                this.ctx.strokeStyle = '#dddddd';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(x + 1, y, whiteKeyWidth - 3, whiteKeyHeight);
            } else {
                // –¢–æ–Ω–∫–∞—è –æ–±–≤–æ–¥–∫–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–ª–∞–≤–∏—à–∏
                this.ctx.strokeStyle = '#ffffff';
                this.ctx.lineWidth = 1;
                this.ctx.strokeRect(x, y, whiteKeyWidth, whiteKeyHeight);
            }
            
            // –ü–æ–¥–ø–∏—Å—å –Ω–æ—Ç—ã
            this.ctx.fillStyle = isPressed ? '#ffffff' : '#888888';
            this.ctx.font = isPressed ? 'bold 11px Arial' : '10px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(`${key.note}${key.octave}`, x + whiteKeyWidth/2, y + whiteKeyHeight - 5);
        });

        // üéπ –ó–ê–¢–ï–ú —Ä–∏—Å—É–µ–º —á–µ—Ä–Ω—ã–µ –∫–ª–∞–≤–∏—à–∏ –ü–û–í–ï–†–• –±–µ–ª—ã—Ö –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
        blackKeys.forEach(key => {
            const x = this.getBlackKeyPosition(key, whiteKeys, whiteKeyWidth);
            const y = keyboardY;
            
            // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞
            if (x !== null && x >= 0 && x + blackKeyWidth <= width) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                key.x = x;
                key.y = y;
                key.width = blackKeyWidth;
                key.height = blackKeyHeight;
                
                const keyId = `${key.note}${key.octave}`;
                const isPressed = this.pressedKeys.has(keyId);
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
                let noteColor = this.REFERENCE_COLOR;
                if (isPressed) {
                    const activeNote = this.activeNotes.get(keyId);
                    if (activeNote && activeNote.pitchAccuracy) {
                        noteColor = this.getPitchAccuracyColor(activeNote.pitchAccuracy);
                    }
                }
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–µ—Ä–Ω–æ–π –∫–ª–∞–≤–∏—à–∏ —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏
                if (isPressed) {
                    // üéØ –ê–∫—Ç–∏–≤–Ω–∞—è —á–µ—Ä–Ω–∞—è –∫–ª–∞–≤–∏—à–∞ - –ü–û–õ–ù–û–ï –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å —Ü–≤–µ—Ç–æ–º —Ç–æ—á–Ω–æ—Å—Ç–∏
                    this.ctx.fillStyle = noteColor;
                    this.ctx.shadowColor = noteColor;
                    this.ctx.shadowBlur = 20;
                    this.ctx.globalAlpha = 0.9;
                    this.ctx.fillRect(x, y, blackKeyWidth, blackKeyHeight); // –£–±—Ä–∞–ª–∏ –æ—Ç—Å—Ç—É–ø—ã!
                    this.ctx.shadowBlur = 0;
                    this.ctx.globalAlpha = 1.0;
                } else {
                    // ‚ö´ –û–±—ã—á–Ω–∞—è —á–µ—Ä–Ω–∞—è –∫–ª–∞–≤–∏—à–∞
                    this.ctx.fillStyle = '#1a1a1a';
                    this.ctx.shadowBlur = 0;
                    this.ctx.globalAlpha = 1.0;
                    this.ctx.fillRect(x, y, blackKeyWidth, blackKeyHeight);
                    
                    // –ë–ª–∏–∫ —Å–≤–µ—Ä—Ö—É –¥–ª—è –æ–±—ä–µ–º–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö)
                    this.ctx.fillStyle = '#404040';
                    this.ctx.fillRect(x, y, blackKeyWidth, 12);
                }
                
                // –ü–æ–¥–ø–∏—Å—å –Ω–æ—Ç—ã
                this.ctx.fillStyle = isPressed ? '#ffffff' : '#cccccc';
                this.ctx.font = isPressed ? 'bold 9px Arial' : '8px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(`${key.note}${key.octave}`, x + blackKeyWidth/2, y + blackKeyHeight - 5);
            }
        });

        // üéØ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
        this.drawPitchIndicators(whiteKeys, blackKeys, whiteKeyWidth, keyboardY, keyboardHeight);
    }

    // üéØ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞ –≤–º–µ—Å—Ç–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
    drawPitchIndicators(whiteKeys, blackKeys, whiteKeyWidth, keyboardY, keyboardHeight) {
        // üéØ –†–∏—Å—É–µ–º –¢–û–õ–¨–ö–û –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞—Ä–∏–∫-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        this.drawSingleBallIndicator();
    }

    // üé® –†–∏—Å—É–µ–º —à–∫–∞–ª—É —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–ª–∞–≤–∏—à–µ–π
    drawPitchScale(centerX, keyWidth, scaleY) {
        const scaleWidth = keyWidth * 0.8;
        const scaleX = centerX - scaleWidth / 2;
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è —à–∫–∞–ª—ã
        this.ctx.strokeStyle = '#666666';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.moveTo(scaleX, scaleY);
        this.ctx.lineTo(scaleX + scaleWidth, scaleY);
        this.ctx.stroke();
        
        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ (–∏–¥–µ–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞)
        this.ctx.strokeStyle = '#00ff41';
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        this.ctx.moveTo(centerX, scaleY - 3);
        this.ctx.lineTo(centerX, scaleY + 3);
        this.ctx.stroke();
        
        // –ë–æ–∫–æ–≤—ã–µ –º–µ—Ç–∫–∏ (¬±50 —Ü–µ–Ω—Ç–æ–≤)
        this.ctx.strokeStyle = '#ffaa00';
        this.ctx.lineWidth = 2;
        const quarter = scaleWidth / 4;
        
        // –õ–µ–≤–∞—è –º–µ—Ç–∫–∞
        this.ctx.beginPath();
        this.ctx.moveTo(centerX - quarter, scaleY - 2);
        this.ctx.lineTo(centerX - quarter, scaleY + 2);
        this.ctx.stroke();
        
        // –ü—Ä–∞–≤–∞—è –º–µ—Ç–∫–∞
        this.ctx.beginPath();
        this.ctx.moveTo(centerX + quarter, scaleY - 2);
        this.ctx.lineTo(centerX + quarter, scaleY + 2);
        this.ctx.stroke();
    }

    // üéØ –†–∏—Å—É–µ–º —à–∞—Ä–∏–∫-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–æ—á–Ω–æ—Å—Ç–∏
    drawPitchBall(ballX, ballY, indicator) {
        const { ballSize, ballColor, glowIntensity, deviation } = indicator;
        
        // üåü –°–≤–µ—á–µ–Ω–∏–µ —à–∞—Ä–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–µ—Ç–∫–æ—Å—Ç–∏ —Å–∏–≥–Ω–∞–ª–∞
        if (glowIntensity > 0.5) {
            this.ctx.shadowColor = ballColor;
            this.ctx.shadowBlur = ballSize * glowIntensity * 2;
            this.ctx.globalAlpha = 0.8;
        }
        
        // üéØ –û—Å–Ω–æ–≤–Ω–æ–π —à–∞—Ä–∏–∫
        this.ctx.fillStyle = ballColor;
        this.ctx.beginPath();
        this.ctx.arc(ballX, ballY, ballSize, 0, Math.PI * 2);
        this.ctx.fill();
        
        // üîç –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–∏–∫ –¥–ª—è –æ–±—ä–µ–º–∞
        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        this.ctx.beginPath();
        this.ctx.arc(ballX - ballSize * 0.3, ballY - ballSize * 0.3, ballSize * 0.4, 0, Math.PI * 2);
        this.ctx.fill();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
        this.ctx.shadowBlur = 0;
        this.ctx.globalAlpha = 1.0;
        
        // üìè –õ–∏–Ω–∏—è –æ—Ç —à–∞—Ä–∏–∫–∞ –∫ —Ü–µ–Ω—Ç—Ä—É (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)
        if (Math.abs(deviation) > 10) { // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏–Ω–∏—é —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ >10 —Ü–µ–Ω—Ç–æ–≤
            const centerX = ballX - (indicator.deviation / 100) * (indicator.ballSize * 3);
            
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            this.ctx.lineWidth = 1;
            this.ctx.setLineDash([2, 2]);
            this.ctx.beginPath();
            this.ctx.moveTo(centerX, ballY);
            this.ctx.lineTo(ballX, ballY);
            this.ctx.stroke();
            this.ctx.setLineDash([]); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç–∏—Ä
        }
    }

    // üìä –†–∏—Å—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—á–Ω–æ—Å—Ç–∏
    drawPitchInfo(centerX, infoY, indicator) {
        const { accuracy, deviation, currentFreq, targetFreq } = indicator;
        
        // üéØ –¢–æ—á–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        this.ctx.fillStyle = indicator.ballColor;
        this.ctx.font = 'bold 10px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(`${accuracy}%`, centerX, infoY);
        
        // üìè –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç–∞—Ö (–µ—Å–ª–∏ –±–æ–ª—å—à–µ 5)
        if (Math.abs(deviation) > 5) {
            const sign = deviation > 0 ? '+' : '';
            this.ctx.fillStyle = '#cccccc';
            this.ctx.font = '8px Arial';
            this.ctx.fillText(`${sign}${Math.round(deviation)}¬¢`, centerX, infoY + 12);
        }
        
        // üîä –ß–∞—Å—Ç–æ—Ç–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –º–µ–ª–∫–∏–º —à—Ä–∏—Ñ—Ç–æ–º)
        if (Math.abs(deviation) > 20) {
            this.ctx.fillStyle = '#888888';
            this.ctx.font = '7px Arial';
            this.ctx.fillText(`${Math.round(currentFreq)}Hz`, centerX, infoY + 22);
        }
    }

    getBlackKeyPosition(blackKey, whiteKeys, whiteKeyWidth) {
        // üéπ –°–¢–ê–ù–î–ê–†–¢–ù–û–ï –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à - —Ç–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É –±–µ–ª—ã–º–∏
        
        // –ü–æ–∑–∏—Ü–∏–∏ —á–µ—Ä–Ω—ã—Ö –∫–ª–∞–≤–∏—à –≤ –æ–∫—Ç–∞–≤–µ (—Å–¥–≤–∏–Ω—É—Ç—ã –Ω–∞ 0.5 –≤–ø—Ä–∞–≤–æ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è)
        const notePositions = {
            'C#': 1.0,  // –¢–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É C (0) –∏ D (1) + —Å–º–µ—â–µ–Ω–∏–µ 0.5
            'D#': 2.0,  // –¢–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É D (1) –∏ E (2) + —Å–º–µ—â–µ–Ω–∏–µ 0.5
            'F#': 4.0,  // –¢–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É F (3) –∏ G (4) + —Å–º–µ—â–µ–Ω–∏–µ 0.5
            'G#': 5.0,  // –¢–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É G (4) –∏ A (5) + —Å–º–µ—â–µ–Ω–∏–µ 0.5
            'A#': 6.0   // –¢–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É –º–µ–∂–¥—É A (5) –∏ B (6) + —Å–º–µ—â–µ–Ω–∏–µ 0.5
        };
        
        const noteOffset = notePositions[blackKey.note];
        if (noteOffset === undefined) {
            console.warn(`‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —á–µ—Ä–Ω–∞—è –∫–ª–∞–≤–∏—à–∞: ${blackKey.note}`);
            return null;
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –æ–∫—Ç–∞–≤—ã (–∫–∞–∂–¥–∞—è –æ–∫—Ç–∞–≤–∞ = 7 –±–µ–ª—ã—Ö –∫–ª–∞–≤–∏—à)
        const octaveOffset = (blackKey.octave - 2) * 7; // –ù–∞—á–∏–Ω–∞–µ–º —Å –æ–∫—Ç–∞–≤—ã 2
        
        // –û–±—â–∞—è –ø–æ–∑–∏—Ü–∏—è –≤ –±–µ–ª—ã—Ö –∫–ª–∞–≤–∏—à–∞—Ö
        const totalWhiteKeyPosition = octaveOffset + noteOffset;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–∑–∏—Ü–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±–µ–ª—ã—Ö –∫–ª–∞–≤–∏—à
        if (totalWhiteKeyPosition < 0 || totalWhiteKeyPosition >= whiteKeys.length) {
            return null;
        }
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —á–µ—Ä–Ω–æ–π –∫–ª–∞–≤–∏—à–∏ (—Ç–æ—á–Ω–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–º–µ—â–µ–Ω–∏–µ–º)
        const blackKeyWidth = whiteKeyWidth * 0.6;
        const centerX = totalWhiteKeyPosition * whiteKeyWidth;
        const blackKeyX = centerX - (blackKeyWidth / 2);
        
        return blackKeyX;
    }

    updateAndDrawParticles() {
        // üöÄ –£–±—Ä–∞–ª–∏ —á–∞—Å—Ç–∏—Ü—ã –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–æ–¥–µ–π—Å—Ç–≤–∏—è
        return;
    }

    // üéØ –ú–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    setSensitivity(multiplier) {
        this.sensitivity = Math.max(0.5, Math.min(2.0, multiplier));
        
        // üéØ –ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ä–µ–∂–∏–º–∞
        const sensitivityPercent = (this.sensitivity * 100).toFixed(0);
        let mode = '';
        if (this.sensitivity >= 1.8) mode = '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è';
        else if (this.sensitivity >= 1.4) mode = '–í—ã—Å–æ–∫–∞—è';
        else if (this.sensitivity >= 1.0) mode = '–°—Ä–µ–¥–Ω—è—è';
        else if (this.sensitivity >= 0.7) mode = '–ù–∏–∑–∫–∞—è';
        else mode = '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è';
        
        console.log(`üéöÔ∏è –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${sensitivityPercent}% (${mode})`);
        
        // üéØ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        this.resetDetectionSystems();
        this.resetDetectionStats();
    }

    // üéØ –°–±—Ä–æ—Å —Å–∏—Å—Ç–µ–º –¥–µ—Ç–µ–∫—Ü–∏–∏ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
    resetDetectionSystems() {
        this.currentActiveNote = null;
        this.singleBallIndicator = null; // üéØ –û—á–∏—â–∞–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —à–∞—Ä–∏–∫
        this.activeNotes.clear();
        this.pressedKeys.clear();
        this.ballAnimation.isAnimating = false; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
        this.vocalNuances.vibrato = []; // üé≠ –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –Ω—é–∞–Ω—Å–æ–≤
        this.vocalNuances.slides = [];
        this.vocalNuances.microTiming = [];
        this.vocalNuances.noteTransitions = [];
        this.harmonicFilter.lastFundamental = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –≥–∞—Ä–º–æ–Ω–∏–∫
        this.harmonicFilter.octaveHistory = [];
        console.log('üîÑ –ú–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å–±—Ä–æ—à–µ–Ω—ã');
    }

    resetDetectionStats() {
        this.detectionStats = {
            totalDetections: 0,
            acceptedNotes: 0,
            harmonicsRejected: 0,
            octaveJumpsRejected: 0,
            unstableFrequencyRejected: 0,
            impreciseNotesRejected: 0
        };
        this.frequencyHistory = [];
    }

    getCurrentSettings() {
        const mode = this.getDetectionSettings();
        return {
            minClarity: mode.minClarity,
            minRms: mode.minRms,
            requiredConfirmations: mode.requiredConfirmations,
            minNoteDuration: mode.minNoteDuration,
            dominanceThreshold: mode.dominanceThreshold
        };
    }

    // üéØ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–∏—Ç—á –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
    detectPitch() {
        if (!this.pitchDetector || !this.inputBuffer) return null;
        
        this.analyser.getFloatTimeDomainData(this.inputBuffer);
        const [frequency, clarity] = this.pitchDetector.findPitch(this.inputBuffer, this.audioContext.sampleRate);
        
        if (!frequency || frequency <= 0) return null;
        
        this.detectionStats.totalDetections++;
        
        // üéØ –°–¢–†–û–ì–ò–ô –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –≤–æ–∫–∞–ª—å–Ω–æ–π –¥–æ—Ä–æ–∂–∫–∏ (C2-C6)
        const minFreq = 65.4;   // C2 - –º–∏–Ω–∏–º—É–º –¥–ª—è –≤–æ–∫–∞–ª–∞
        const maxFreq = 1046.5; // C6 - –º–∞–∫—Å–∏–º—É–º –¥–ª—è –≤–æ–∫–∞–ª–∞
        if (frequency < minFreq || frequency > maxFreq) return null;
        
        // üéØ –°–ú–Ø–ì–ß–ï–ù–ù–´–ï –ø–æ—Ä–æ–≥–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞ —Ç–∏—Ö–∏—Ö –∏ –ø–µ—Ä–µ—Ö–æ–¥–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
        const minClarity = 0.60; // –°–Ω–∏–∂–µ–Ω –¥–æ 60% –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —Ç–∏—Ö–∏—Ö –º–æ–º–µ–Ω—Ç–æ–≤
        if (clarity < minClarity) return null;
        
        // üéØ –†–∞—Å—á–µ—Ç RMS –∞–º–ø–ª–∏—Ç—É–¥—ã
        let rms = 0;
        for (let i = 0; i < this.inputBuffer.length; i++) {
            rms += this.inputBuffer[i] * this.inputBuffer[i];
        }
        rms = Math.sqrt(rms / this.inputBuffer.length);
        
        const minRms = 0.003; // –°–Ω–∏–∂–µ–Ω –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ —Ç–∏—Ö–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤
        if (rms < minRms) return null;
        
        // üéØ –û–±–ª–µ–≥—á–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –Ω–æ—Ç)
        if (!this.hasActiveNoteNearFrequency(frequency) && !this.isFrequencyStable(frequency, clarity)) {
            this.detectionStats.unstableFrequencyRejected++;
            return null;
        }
        
        return { 
            frequency, 
            clarity, 
            amplitude: rms,
            timestamp: performance.now()
        };
    }

    // üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã —Ä—è–¥–æ–º —Å —á–∞—Å—Ç–æ—Ç–æ–π
    hasActiveNoteNearFrequency(frequency) {
        const toleranceHz = 20; // –†–∞—Å—à–∏—Ä–∏–ª–∏ —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å
        
        // üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ—Ç—ã –≤ activeNotes
        for (const [keyId, noteData] of this.activeNotes.entries()) {
            const freqDiff = Math.abs(frequency - noteData.targetFrequency);
            
            if (freqDiff <= toleranceHz) {
                return true;
            }
        }
        
        return false;
    }

    // üéØ –û–±–ª–µ–≥—á–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    isFrequencyStable(frequency, clarity) {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        this.frequencyHistory = this.frequencyHistory || [];
        this.frequencyHistory.push({ frequency, clarity, time: performance.now() });
        
        // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∑–∞–º–µ—Ä–∞ (–∫–æ—Ä–æ—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ—Ç—ã)
        if (this.frequencyHistory.length > 3) {
            this.frequencyHistory.shift();
        }
        
        // –î–ª—è –ø–µ—Ä–≤—ã—Ö –∑–∞–º–µ—Ä–æ–≤ - –ø—Ä–∏–Ω–∏–º–∞–µ–º –µ—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ —Ö–æ—Ä–æ—à–µ–µ
        if (this.frequencyHistory.length < 2) {
            return clarity >= 0.65;
        }
        
        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –Ω–µ –±–æ–ª–µ–µ 5%)
        const frequencies = this.frequencyHistory.map(h => h.frequency);
        const avgFreq = frequencies.reduce((a, b) => a + b) / frequencies.length;
        
        for (const freq of frequencies) {
            const deviation = Math.abs(freq - avgFreq) / avgFreq;
            if (deviation > 0.05) { // 5% –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ (–±—ã–ª–æ 3%)
                return false;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —á–µ—Ç–∫–æ—Å—Ç—å
        const clarities = this.frequencyHistory.map(h => h.clarity);
        const avgClarity = clarities.reduce((a, b) => a + b) / clarities.length;
        
        return avgClarity >= 0.60; // –°–Ω–∏–∑–∏–ª–∏ –¥–æ 60%
    }

    // üéØ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ—Ç —Å –ú–û–ù–û–§–û–ù–ò–ß–ï–°–ö–û–ô —Å–∏—Å—Ç–µ–º–æ–π
    processNote(pitchData) {
        const { frequency, clarity, amplitude, timestamp } = pitchData;
        
        // üîá –°–¢–†–û–ì–ê–Ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥–∞—Ä–º–æ–Ω–∏–∫ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
        if (!this.isValidMonophonicFrequency(frequency, clarity, amplitude)) {
            return;
        }
        
        const note = this.frequencyToNoteAdvanced(frequency);
        if (!note) return;
        
        const noteId = `${note.note}${note.octave}`;
        
        // üéØ –†–ï–í–û–õ–Æ–¶–ò–Ø: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω–æ –ª–∏ —Å–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –Ω–æ—Ç—É
        const shouldSwitchNote = this.shouldSwitchToNewNote(noteId, frequency, clarity, amplitude);
        
        if (shouldSwitchNote) {
            // üéµ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—É—é –Ω–æ—Ç—É (—Å –∞–Ω–∏–º–∞—Ü–∏–µ–π)
            this.switchToMonophonicNote(noteId, frequency, clarity, amplitude, timestamp);
            this.detectionStats.acceptedNotes++;
            console.log(`üéµ –ù–æ–≤–∞—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∞—è –Ω–æ—Ç–∞: ${noteId} (—á–µ—Ç–∫–æ—Å—Ç—å: ${(clarity * 100).toFixed(1)}%, –∞–º–ø–ª–∏—Ç—É–¥–∞: ${(amplitude * 1000).toFixed(1)})`);
        } else if (this.currentActiveNote && this.currentActiveNote.keyId === noteId) {
            // üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–æ—Ç—É
            this.updateCurrentMonophonicNote(frequency, clarity, amplitude, timestamp);
        }
    }

    // üîá –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —á–∞—Å—Ç–æ—Ç—ã –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–æ–≥–æ –≥–æ–ª–æ—Å–∞
    isValidMonophonicFrequency(frequency, clarity, amplitude) {
        // üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≥–∞—Ä–º–æ–Ω–∏–∫–∏ (–æ–∫—Ç–∞–≤–Ω—ã–µ –¥—É–±–ª–∏)
        if (this.harmonicFilter.lastFundamental) {
            const octaveRatios = [0.5, 2.0, 4.0, 0.25]; // –û–∫—Ç–∞–≤—ã –Ω–∏–∂–µ –∏ –≤—ã—à–µ
            
            for (const ratio of octaveRatios) {
                const harmonicFreq = this.harmonicFilter.lastFundamental * ratio;
                const deviation = Math.abs(frequency - harmonicFreq) / harmonicFreq;
                
                if (deviation < this.harmonicFilter.harmonicTolerance) {
                    this.detectionStats.harmonicsRejected++;
                    this.detectionStats.monophonicFiltered++;
                    return false; // –≠—Ç–æ –≥–∞—Ä–º–æ–Ω–∏–∫–∞, –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º
                }
            }
        }
        
        // üîá –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —à—É–º
        if (amplitude < this.harmonicFilter.noiseThreshold) {
            this.detectionStats.monophonicFiltered++;
            return false;
        }
        
        // üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —á–µ—Ç–∫–æ—Å—Ç–∏ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        if (clarity < 0.7) { // –ü–æ–≤—ã—Å–∏–ª–∏ –ø–æ—Ä–æ–≥ —á–µ—Ç–∫–æ—Å—Ç–∏ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
            this.detectionStats.monophonicFiltered++;
            return false;
        }
        
        return true;
    }

    // üéµ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—É—é –Ω–æ—Ç—É
    shouldSwitchToNewNote(noteId, frequency, clarity, amplitude) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
        if (!this.currentActiveNote) {
            return true;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Ç–∞ –∂–µ –Ω–æ—Ç–∞ - –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è
        if (this.currentActiveNote.keyId === noteId) {
            return false;
        }
        
        // üéØ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–æ–≤–∞—è –Ω–æ—Ç–∞ –ó–ù–ê–ß–ò–¢–ï–õ–¨–ù–û –ª—É—á—à–µ
        const currentQuality = this.currentActiveNote.clarity * this.currentActiveNote.amplitude;
        const newQuality = clarity * amplitude;
        
        // –ù–æ–≤–∞—è –Ω–æ—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫–∞–∫ –º–∏–Ω–∏–º—É–º –Ω–∞ 30% –ª—É—á—à–µ
        const improvementThreshold = 1.3;
        if (newQuality > currentQuality * improvementThreshold) {
            return true;
        }
        
        // –ò–ª–∏ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –Ω–æ—Ç–∞ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–∞—è (>200–º—Å)
        const noteAge = Date.now() - this.currentActiveNote.lastDetection;
        if (noteAge > 200) {
            return true;
        }
        
        return false;
    }

    // üéµ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤—É—é –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫—É—é –Ω–æ—Ç—É
    switchToMonophonicNote(noteId, frequency, clarity, amplitude, timestamp) {
        const key = this.keys.find(k => `${k.note}${k.octave}` === noteId);
        if (!key) return;

        const targetFrequency = key.frequency;
        const pitchAccuracy = this.calculatePitchAccuracy(frequency, targetFrequency);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const previousIndicator = this.singleBallIndicator;
        
        // üéØ –û—á–∏—â–∞–µ–º –í–°–ï –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Å—Ç—Ä–æ–≥–∞—è –º–æ–Ω–æ—Ñ–æ–Ω–∏—è!)
        this.pressedKeys.clear();
        this.activeNotes.clear();
        
        // –°–æ–∑–¥–∞–µ–º –ï–î–ò–ù–°–¢–í–ï–ù–ù–£–Æ –∞–∫—Ç–∏–≤–Ω—É—é –Ω–æ—Ç—É
        this.currentActiveNote = {
            keyId: noteId,
            frequency: frequency,
            currentFrequency: frequency,
            targetFrequency: targetFrequency,
            pitchAccuracy: pitchAccuracy,
            clarity: clarity,
            amplitude: amplitude,
            startTime: timestamp,
            lastDetection: timestamp,
            detectionCount: 1,
            maxClarity: clarity,
            maxAmplitude: amplitude
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        this.pressedKeys.add(noteId);
        this.activeNotes.set(noteId, this.currentActiveNote);
        
        // üé® –°–æ–∑–¥–∞–µ–º –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô —à–∞—Ä–∏–∫-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        this.createSingleBallIndicator(previousIndicator);
        
        // üîá –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≥–∞—Ä–º–æ–Ω–∏–∫
        this.harmonicFilter.lastFundamental = frequency;
        
        // üé≠ –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –≤ –∏—Å—Ç–æ—Ä–∏—é
        this.vocalNuances.noteTransitions.push({
            fromNote: previousIndicator ? previousIndicator.keyId : null,
            toNote: noteId,
            timestamp: timestamp,
            frequency: frequency
        });
    }

    // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –º–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–æ–π –Ω–æ—Ç—ã
    updateCurrentMonophonicNote(frequency, clarity, amplitude, timestamp) {
        if (!this.currentActiveNote) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –Ω–æ—Ç—ã
        this.currentActiveNote.lastDetection = timestamp;
        this.currentActiveNote.currentFrequency = frequency;
        this.currentActiveNote.maxClarity = Math.max(this.currentActiveNote.maxClarity, clarity);
        this.currentActiveNote.maxAmplitude = Math.max(this.currentActiveNote.maxAmplitude, amplitude);
        this.currentActiveNote.detectionCount++;
        this.currentActiveNote.pitchAccuracy = this.calculatePitchAccuracy(frequency, this.currentActiveNote.targetFrequency);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —à–∞—Ä–∏–∫-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (this.singleBallIndicator) {
            this.updateSingleBallIndicator(frequency, clarity, amplitude);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –≥–∞—Ä–º–æ–Ω–∏–∫
        this.harmonicFilter.lastFundamental = frequency;
    }

    // üéØ –ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ—Ç—ã –ø–æ —á–∞—Å—Ç–æ—Ç–µ —Å —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
    findExistingNoteByFrequency(frequency, timestamp) {
        const toleranceHz = 15; // ¬±15Hz —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è —Ç–æ–π –∂–µ –Ω–æ—Ç—ã
        const maxAge = 150; // –ò—â–µ–º –Ω–æ—Ç—ã –Ω–µ —Å—Ç–∞—Ä—à–µ 150–º—Å
        
        // üéØ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ—Ç—ã –≤ activeNotes
        for (const [keyId, noteData] of this.activeNotes.entries()) {
            const timeDiff = timestamp - noteData.lastDetection;
            if (timeDiff > maxAge) continue;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–ª–∏–∑–æ—Å—Ç—å —á–∞—Å—Ç–æ—Ç
            const freqDiff = Math.abs(frequency - noteData.targetFrequency);
            
            if (freqDiff <= toleranceHz) {
                return { keyId, keyData: noteData, freqDiff };
            }
        }
        
        return null;
    }

    // üéØ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ—Ç—ã
    updateExistingNote(existingNote, frequency, clarity, amplitude, timestamp) {
        const { keyId, keyData } = existingNote;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ—Ç—ã –≤ activeNotes
        keyData.lastDetection = timestamp;
        keyData.maxClarity = Math.max(keyData.maxClarity || 0, clarity);
        keyData.maxAmplitude = Math.max(keyData.maxAmplitude || 0, amplitude);
        keyData.detectionCount = (keyData.detectionCount || 1) + 1;
        keyData.currentFrequency = frequency; // üéØ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç–æ—Ç—É
        
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
        keyData.pitchAccuracy = this.calculatePitchAccuracy(frequency, keyData.targetFrequency);
        
        // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        if (keyData.detectionCount % 10 === 0) {
            const duration = timestamp - keyData.startTime;
            console.log(`üéµ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–æ—Ç—ã ${keyId}: ${duration.toFixed(0)}–º—Å (${keyData.detectionCount} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, —Ç–æ—á–Ω–æ—Å—Ç—å: ${keyData.pitchAccuracy}%)`);
        }
    }

    // üéØ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –≤ –Ω–æ—Ç—É —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
    frequencyToNoteAdvanced(frequency) {
        const A4 = 440.0;
        
        // –ë–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º
        const semitoneFromA4 = 12 * Math.log2(frequency / A4);
        const semitone = Math.round(semitoneFromA4);
        
        // üéØ –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ (–Ω–µ –±–æ–ª–µ–µ 25 —Ü–µ–Ω—Ç–æ–≤ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è)
        const semitoneError = Math.abs(semitoneFromA4 - semitone);
        if (semitoneError > 0.25) { // –¢–æ–ª—å–∫–æ 25 —Ü–µ–Ω—Ç–æ–≤ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏
            this.detectionStats.impreciseNotesRejected++;
            return null;
        }
        
        const midiNumber = 69 + semitone;
        const octave = Math.floor((midiNumber - 12) / 12);
        const noteIndex = (midiNumber - 12) % 12;
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
        const adjustedNoteIndex = noteIndex < 0 ? noteIndex + 12 : noteIndex;
        
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const note = notes[adjustedNoteIndex];
        
        // –°—Ç—Ä–æ–≥–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –≤–æ–∫–∞–ª–∞ (C2-C6)
        if (octave < 2 || octave > 6) {
            return null;
        }
        
        return { note, octave };
    }

    // üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–∫—Ç–∞–≤–Ω—ã–µ –ø—Ä—ã–∂–∫–∏
    isOctaveJump(currentNote, timestamp) {
        const currentNoteOnly = currentNote.note; // –ë–µ–∑ –æ–∫—Ç–∞–≤—ã
        
        // –ò—â–µ–º –Ω–æ—Ç—ã —Ç–æ–π –∂–µ –≤—ã—Å–æ—Ç—ã –≤ –¥—Ä—É–≥–∏—Ö –æ–∫—Ç–∞–≤–∞—Ö –≤ activeNotes
        for (const [keyId, noteData] of this.activeNotes.entries()) {
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ—Ç—É –∏–∑ keyId (–Ω–∞–ø—Ä–∏–º–µ—Ä, "C4" -> "C")
            const noteName = keyId.replace(/\d+$/, ''); // –£–±–∏—Ä–∞–µ–º —Ü–∏—Ñ—Ä—ã –≤ –∫–æ–Ω—Ü–µ
            const noteOctave = parseInt(keyId.replace(/^[A-G]#?/, '')); // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ–∫—Ç–∞–≤—É
            
            if (noteName === currentNoteOnly && noteOctave !== currentNote.octave) {
                const timeDiff = timestamp - noteData.lastDetection;
                if (timeDiff < 100) { // –ï—Å–ª–∏ –º–µ–Ω–µ–µ 100–º—Å –Ω–∞–∑–∞–¥ –±—ã–ª–∞ —Ç–∞ –∂–µ –Ω–æ—Ç–∞ –≤ –¥—Ä—É–≥–æ–π –æ–∫—Ç–∞–≤–µ
                    return true;
                }
            }
        }
        
        return false;
    }

    // üéØ –†–∞—Å—á–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —á–∞—Å—Ç–æ—Ç—ã
    calculateFrequencyStability(frequencies) {
        if (frequencies.length < 2) return 1.0;
        
        const mean = frequencies.reduce((a, b) => a + b) / frequencies.length;
        const variance = frequencies.reduce((sum, freq) => sum + Math.pow(freq - mean, 2), 0) / frequencies.length;
        const stdDev = Math.sqrt(variance);
        
        // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏ (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ)
        const coefficientOfVariation = stdDev / mean;
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å (–æ—Ç 0 –¥–æ 1)
        return Math.max(0, 1 - coefficientOfVariation * 20);
    }

    // üéØ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    getRequiredConfirmationTime(clarity, sensitivity) {
        // –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–µ—Ç–∫–æ—Å—Ç–∏ –∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const baseTime = 30; // –º—Å
        const clarityBonus = (clarity - 0.5) * 20; // –ß–µ–º —á–µ—Ç—á–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ
        const sensitivityBonus = (sensitivity - 1.0) * 15; // –ß–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–µ–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ
        
        return Math.max(10, baseTime - clarityBonus - sensitivityBonus);
    }

    // üéØ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –≤ –Ω–æ—Ç—É
    frequencyToNote(frequency) {
        const A4 = 440;
        const semitone = Math.round(12 * Math.log2(frequency / A4));
        const midiNumber = 69 + semitone;
        
        const octave = Math.floor((midiNumber - 12) / 12);
        const noteIndex = (midiNumber - 12) % 12;
        
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const note = notes[noteIndex];
        
        if (octave < 1 || octave > 7) {
            return null;
        }
        
        return { note, octave };
    }

    // üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–ª–∞–≤–∏—à —Å —É–º–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —É–¥–µ—Ä–∂–∞–Ω–∏—è
    cleanupInactiveKeys(currentTime) {
        let removedCount = 0;
        const keysToRemove = [];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∞–∫—Ç–∏–≤–Ω—É—é –Ω–æ—Ç—É
        this.activeNotes.forEach((noteData, keyId) => {
            const timeSinceLastDetection = currentTime - noteData.lastDetection;
            
            // üéØ –£–º–Ω–æ–µ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–æ—Ç—ã
            const holdTime = this.calculateHoldTime(noteData);
            
            if (timeSinceLastDetection > holdTime) {
                keysToRemove.push(keyId);
                const duration = noteData.lastDetection - noteData.startTime;
                console.log(`üîá –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–æ—Ç–∞: ${keyId} (${holdTime}–º—Å –ø–æ—Å–ª–µ ${duration}–º—Å –∑–≤—É—á–∞–Ω–∏—è, —Ç–æ—á–Ω–æ—Å—Ç—å: ${noteData.pitchAccuracy}%)`);
                removedCount++;
            }
        });

        // –£–¥–∞–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–æ—Ç—ã
        keysToRemove.forEach(keyId => {
            this.pressedKeys.delete(keyId);
            this.activeNotes.delete(keyId);
        });

        if (removedCount > 0) {
            console.log(`‚ö° –û—á–∏—Å—Ç–∫–∞: ${removedCount} –Ω–æ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
        }

        return removedCount;
    }

    // üéØ –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —É–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–æ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ—ë —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
    calculateHoldTime(noteData) {
        const baseHoldTime = 80; // –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è 80–º—Å
        
        // –ë–æ–Ω—É—Å –∑–∞ —á–µ—Ç–∫–æ—Å—Ç—å (0-40–º—Å)
        const clarityBonus = Math.round(noteData.maxClarity * 0.4); // –î–æ 40–º—Å –∑–∞ 100% —á–µ—Ç–∫–æ—Å—Ç—å
        
        // –ë–æ–Ω—É—Å –∑–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (0-50–º—Å –∑–∞ –¥–æ–ª–≥–æ–µ –∑–≤—É—á–∞–Ω–∏–µ)
        const duration = noteData.lastDetection - noteData.startTime;
        const durationBonus = Math.min(50, Math.round(duration / 100)); // 1–º—Å –±–æ–Ω—É—Å–∞ –∑–∞ –∫–∞–∂–¥—ã–µ 100–º—Å –∑–≤—É—á–∞–Ω–∏—è
        
        // –ë–æ–Ω—É—Å –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å –ø–∏—Ç—á–∞ (0-30–º—Å)
        const accuracyBonus = Math.round((noteData.pitchAccuracy - 50) * 0.6); // –û—Ç 0 –¥–æ 30–º—Å –∑–∞ —Ç–æ—á–Ω–æ—Å—Ç—å
        
        const finalHoldTime = baseHoldTime + clarityBonus + durationBonus + accuracyBonus;
        
        return Math.min(200, Math.max(60, finalHoldTime)); // –û—Ç 60–º—Å –¥–æ 200–º—Å
    }

    // üéØ –°–ò–°–¢–ï–ú–ê –¢–û–ß–ù–û–°–¢–ò –ü–ò–¢–ß–ê
    
    /**
     * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –Ω–æ—Ç—É (0-100%)
     * @param {number} detectedFreq - –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞
     * @param {number} targetFreq - –¶–µ–ª–µ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ –Ω–æ—Ç—ã
     * @returns {number} –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç 0 –¥–æ 100%
     */
    calculatePitchAccuracy(detectedFreq, targetFreq) {
        // –†–∞—Å—á–µ—Ç –ø–æ–ª—É—Ç–æ–Ω–æ–≤—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (–∫–∞–∂–¥—ã–π –ø–æ–ª—É—Ç–æ–Ω = 12-—è —Å—Ç–µ–ø–µ–Ω—å –∏–∑ 2)
        const semitoneFactor = Math.pow(2, 1/12);
        
        // –ì—Ä–∞–Ω–∏—Ü—ã –Ω–æ—Ç—ã (¬±50 —Ü–µ–Ω—Ç–æ–≤ = ¬±–ø–æ–ª–æ–≤–∏–Ω–∞ –ø–æ–ª—É—Ç–æ–Ω–∞)
        const lowerBound = targetFreq / Math.pow(semitoneFactor, 0.5);
        const upperBound = targetFreq * Math.pow(semitoneFactor, 0.5);
        
        // –ï—Å–ª–∏ —á–∞—Å—Ç–æ—Ç–∞ –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –Ω–æ—Ç—ã
        if (detectedFreq < lowerBound || detectedFreq > upperBound) {
            return 0;
        }
        
        // –†–∞—Å—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –≤ —Ü–µ–Ω—Ç–∞—Ö
        const centsDeviation = Math.abs(1200 * Math.log2(detectedFreq / targetFreq));
        
        // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = 50 —Ü–µ–Ω—Ç–æ–≤ (–∫—Ä–∞–π –Ω–æ—Ç—ã)
        const maxDeviation = 50;
        
        // –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç 100% (—Ü–µ–Ω—Ç—Ä) –¥–æ 50% (–∫—Ä–∞–π)
        const accuracy = Math.max(50, 100 - (centsDeviation / maxDeviation) * 50);
        
        return Math.round(accuracy);
    }
    
    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Ü–≤–µ—Ç –∑–µ–ª–µ–Ω–æ–≥–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏
     * @param {number} accuracy - –¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç 50 –¥–æ 100%
     * @returns {string} –¶–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ hex
     */
    getPitchAccuracyColor(accuracy) {
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ç 50-100% –∫ 0-1
        const normalized = (accuracy - 50) / 50;
        
        // –ì—Ä–∞–¥–∞—Ü–∏—è –∑–µ–ª–µ–Ω–æ–≥–æ –æ—Ç —Ç–µ–º–Ω–æ–≥–æ –∫ —è—Ä–∫–æ–º—É
        const colors = [
            '#00601e', // 50% - –æ—á–µ–Ω—å —Ç–µ–º–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π
            '#008025', // 60% - —Ç–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π  
            '#00a02c', // 70% - –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π
            '#00c033', // 80% - —á—É—Ç—å —Ç–µ–º–Ω–µ–µ
            '#00e03a', // 90% - –ø–æ—á—Ç–∏ —è—Ä–∫–∏–π
            '#00ff41'  // 100% - —è—Ä–∫–∏–π –∑–µ–ª–µ–Ω—ã–π
        ];
        
        // –ò–Ω–¥–µ–∫—Å —Ü–≤–µ—Ç–∞ (0-5)
        const colorIndex = Math.floor(normalized * 5);
        const clampedIndex = Math.max(0, Math.min(5, colorIndex));
        
        return colors[clampedIndex];
    }

    // üéµ –°–∏—Å—Ç–µ–º–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–æ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –∑–≤—É—á–∞–Ω–∏—è
    activateKeyWithTracking(frequency, clarity, amplitude, stabilityScore = 1.0) {
        const keyId = this.getKeyIdFromFrequency(frequency);
        if (!keyId) return false;

        const key = this.keys.find(k => `${k.note}${k.octave}` === keyId);
        if (!key) return false;

        // üéØ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –Ω–æ—Ç—É
        const targetFrequency = key.frequency;
        const pitchAccuracy = this.calculatePitchAccuracy(frequency, targetFrequency);
        
        // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å –º–µ–Ω—å—à–µ 50%, –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ—Ç—É
        if (pitchAccuracy < 50) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞—è –Ω–æ—Ç–∞ —Å —ç—Ç–∏–º ID
        if (this.pressedKeys.has(keyId)) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ—Ç—ã
            const existingNote = this.activeNotes.get(keyId);
            if (existingNote) {
                existingNote.lastDetection = Date.now();
                existingNote.detectionCount++;
                existingNote.maxClarity = Math.max(existingNote.maxClarity, clarity);
                existingNote.maxAmplitude = Math.max(existingNote.maxAmplitude, amplitude);
                existingNote.stabilityScore = Math.max(existingNote.stabilityScore, stabilityScore);
                existingNote.currentFrequency = frequency; // üéØ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é —á–∞—Å—Ç–æ—Ç—É
                existingNote.pitchAccuracy = pitchAccuracy; // üéØ –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å
                
                // –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–æ—Ç—ã –∫–∞–∂–¥—ã–µ 10 –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                if (existingNote.detectionCount % 10 === 0) {
                    const duration = existingNote.lastDetection - existingNote.startTime;
                    console.log(`üéµ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –Ω–æ—Ç—ã ${keyId}: ${duration}–º—Å (${existingNote.detectionCount} –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π, —Ç–æ—á–Ω–æ—Å—Ç—å: ${pitchAccuracy}%)`);
                }
            }
            return true;
        }

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∞–∫—Ç–∏–≤–Ω—É—é –Ω–æ—Ç—É
        this.pressedKeys.add(keyId);
        this.activeNotes.set(keyId, {
            keyId: keyId,
            frequency: frequency,
            currentFrequency: frequency, // üéØ –¢–µ–∫—É—â–∞—è —á–∞—Å—Ç–æ—Ç–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏
            targetFrequency: targetFrequency, // üéØ –¶–µ–ª–µ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞ –Ω–æ—Ç—ã
            pitchAccuracy: pitchAccuracy, // üéØ –¢–æ—á–Ω–æ—Å—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏—è
            clarity: clarity,
            amplitude: amplitude,
            stabilityScore: stabilityScore,
            startTime: Date.now(),
            lastDetection: Date.now(),
            detectionCount: 1,
            maxClarity: clarity,
            maxAmplitude: amplitude
        });

        console.log(`‚ö° –ù–æ–≤–∞—è –Ω–æ—Ç–∞: ${keyId} (—á–µ—Ç–∫–æ—Å—Ç—å: ${clarity.toFixed(1)}%, –∞–º–ø–ª–∏—Ç—É–¥–∞: ${amplitude.toFixed(1)}, —Ç–æ—á–Ω–æ—Å—Ç—å: ${pitchAccuracy}%)`);
        return true;
    }

    getKeyIdFromFrequency(frequency) {
        // üéØ –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —á–∞—Å—Ç–æ—Ç—É –≤ –Ω–æ—Ç—É —Å –≤—ã—Å–æ–∫–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é
        const note = this.frequencyToNoteAdvanced(frequency);
        if (!note) return null;
        
        return `${note.note}${note.octave}`;
    }

    // üîá –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏—à–∏–Ω—ã –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
    checkForSilenceInstant(currentTime) {
        if (!this.inputBuffer) return;
        
        this.analyser.getFloatTimeDomainData(this.inputBuffer);
        
        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ RMS –∞–º–ø–ª–∏—Ç—É–¥—ã
        let rms = 0;
        for (let i = 0; i < this.inputBuffer.length; i++) {
            rms += this.inputBuffer[i] * this.inputBuffer[i];
        }
        rms = Math.sqrt(rms / this.inputBuffer.length);
        
        // üîá –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ç–∏—à–∏–Ω–µ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        const silenceThreshold = 0.001;
        if (rms < silenceThreshold && this.currentActiveNote) {
            console.log(`üîá –ú–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∞—è —Ç–∏—à–∏–Ω–∞: –æ—á–∏—Å—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã ${this.currentActiveNote.keyId}`);
            this.currentActiveNote = null;
            this.singleBallIndicator = null;
            this.pressedKeys.clear();
            this.activeNotes.clear();
            this.ballAnimation.isAnimating = false;
            this.harmonicFilter.lastFundamental = null;
        }
    }

    // üßπ –ú–ì–ù–û–í–ï–ù–ù–ê–Ø –æ—á–∏—Å—Ç–∫–∞ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
    cleanupInactiveKeysInstant(currentTime) {
        if (!this.currentActiveNote) return 0;
        
        // ‚ö° –°–¢–†–û–ì–û–ï –≤—Ä–µ–º—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞ –≤ –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        const maxHoldTime = 100; // 100–º—Å —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
        
        const timeSinceLastDetection = currentTime - this.currentActiveNote.lastDetection;
        
        if (timeSinceLastDetection > maxHoldTime) {
            console.log(`üîá –ú–æ–Ω–æ—Ñ–æ–Ω–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏: ${this.currentActiveNote.keyId} (${timeSinceLastDetection}–º—Å)`);
            this.currentActiveNote = null;
            this.singleBallIndicator = null;
            this.pressedKeys.clear();
            this.activeNotes.clear();
            this.ballAnimation.isAnimating = false;
            this.harmonicFilter.lastFundamental = null;
            return 1;
        }

        return 0;
    }

    // üé≠ –°–∏—Å—Ç–µ–º–∞ –∑–∞—Ö–≤–∞—Ç–∞ –º–∏–∫—Ä–æ-–Ω—é–∞–Ω—Å–æ–≤ –¥–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏
    updateVocalNuances(pitchData) {
        const { frequency, clarity, amplitude, timestamp } = pitchData;
        
        // üéµ –ê–Ω–∞–ª–∏–∑ –≤–∏–±—Ä–∞—Ç–æ (–∫–æ–ª–µ–±–∞–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã) –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–æ—Ç—ã
        this.vocalNuances.vibrato.push({ frequency, timestamp });
        if (this.vocalNuances.vibrato.length > 20) {
            this.vocalNuances.vibrato.shift(); // –û—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∑–Ω–∞—á–µ–Ω–∏–π
        }
        
        // üé≠ –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ—Ç
        this.updatePitchIndicators(frequency, clarity, amplitude, timestamp);
    }

    // üéØ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ç–æ—á–Ω–æ—Å—Ç–∏
    updatePitchIndicators(currentFrequency, clarity, amplitude, timestamp) {
        // üéØ –î–ª—è –º–æ–Ω–æ—Ñ–æ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (this.currentActiveNote) {
            this.updateSingleBallIndicator(currentFrequency, clarity, amplitude);
        }
    }

    // üéØ –†–∞—Å—á–µ—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –≤ —Ü–µ–Ω—Ç–∞—Ö
    calculateFrequencyDeviation(currentFreq, targetFreq) {
        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç–∞—Ö (-100 –¥–æ +100)
        const cents = 1200 * Math.log2(currentFreq / targetFreq);
        return Math.max(-100, Math.min(100, cents)); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º ¬±100 —Ü–µ–Ω—Ç–æ–≤
    }

    // üé® –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    createSingleBallIndicator(previousIndicator) {
        if (!this.currentActiveNote) return;

        const key = this.keys.find(k => `${k.note}${k.octave}` === this.currentActiveNote.keyId);
        if (!key) return;

        // üéØ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–æ–≤–æ–≥–æ —à–∞—Ä–∏–∫–∞
        const whiteKeys = this.keys.filter(k => !k.isBlack);
        const whiteKeyWidth = this.canvas.width / whiteKeys.length;
        const keyboardY = this.canvas.height - 250;
        
        let targetX, keyWidth;
        if (key.isBlack) {
            targetX = this.getBlackKeyPosition(key, whiteKeys, whiteKeyWidth);
            keyWidth = whiteKeyWidth * 0.6;
        } else {
            const whiteIndex = whiteKeys.findIndex(k => `${k.note}${k.octave}` === this.currentActiveNote.keyId);
            targetX = whiteIndex * whiteKeyWidth;
            keyWidth = whiteKeyWidth;
        }

        if (targetX === null) return;

        const centerX = targetX + keyWidth / 2;
        const ballY = keyboardY + 250 + 25; // –ü–æ–¥ –∫–ª–∞–≤–∏—à–µ–π

        // üé® –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        this.singleBallIndicator = {
            keyId: this.currentActiveNote.keyId,
            currentFreq: this.currentActiveNote.currentFrequency,
            targetFreq: this.currentActiveNote.targetFrequency,
            deviation: this.calculateFrequencyDeviation(this.currentActiveNote.currentFrequency, this.currentActiveNote.targetFrequency),
            accuracy: this.currentActiveNote.pitchAccuracy,
            clarity: this.currentActiveNote.clarity,
            amplitude: this.currentActiveNote.amplitude,
            timestamp: this.currentActiveNote.lastDetection,
            ballSize: Math.min(15, 8 + (this.currentActiveNote.clarity * 7)), // –†–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–µ—Ç–∫–æ—Å—Ç–∏
            ballColor: this.getPitchAccuracyColor(this.currentActiveNote.pitchAccuracy),
            glowIntensity: this.currentActiveNote.clarity,
            // –ü–æ–∑–∏—Ü–∏—è —Å —É—á–µ—Ç–æ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã
            currentX: centerX + (this.calculateFrequencyDeviation(this.currentActiveNote.currentFrequency, this.currentActiveNote.targetFrequency) / 100) * (keyWidth * 0.4),
            currentY: ballY,
            targetCenterX: centerX
        };

        // üé≠ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–∞
        if (previousIndicator && previousIndicator.currentX && previousIndicator.currentY) {
            // –ï—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —à–∞—Ä–∏–∫ - –¥–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
            this.ballAnimation.fromX = previousIndicator.currentX;
            this.ballAnimation.fromY = previousIndicator.currentY;
            this.ballAnimation.toX = this.singleBallIndicator.currentX;
            this.ballAnimation.toY = this.singleBallIndicator.currentY;
            this.ballAnimation.progress = 0.0;
            this.ballAnimation.isAnimating = true;
            this.ballAnimation.startTime = performance.now();
            
            console.log(`üé≠ –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞: ${previousIndicator.keyId} ‚Üí ${this.currentActiveNote.keyId}`);
        } else {
            // –ü–µ—Ä–≤—ã–π —à–∞—Ä–∏–∫ - –ø–æ—è–≤–ª—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
            this.ballAnimation.progress = 1.0;
            this.ballAnimation.isAnimating = false;
        }
    }

    // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    updateSingleBallIndicator(frequency, clarity, amplitude) {
        if (!this.singleBallIndicator || !this.currentActiveNote) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —à–∞—Ä–∏–∫–∞
        this.singleBallIndicator.currentFreq = frequency;
        this.singleBallIndicator.accuracy = this.currentActiveNote.pitchAccuracy;
        this.singleBallIndicator.clarity = clarity;
        this.singleBallIndicator.amplitude = amplitude;
        this.singleBallIndicator.timestamp = Date.now();
        this.singleBallIndicator.ballColor = this.getPitchAccuracyColor(this.currentActiveNote.pitchAccuracy);
        this.singleBallIndicator.glowIntensity = clarity;
        this.singleBallIndicator.ballSize = Math.min(15, 8 + (clarity * 7));

        // üéØ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤–æ–π —á–∞—Å—Ç–æ—Ç—ã
        const deviation = this.calculateFrequencyDeviation(frequency, this.currentActiveNote.targetFrequency);
        this.singleBallIndicator.deviation = deviation;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Å –ø–ª–∞–≤–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º
        const whiteKeys = this.keys.filter(k => !k.isBlack);
        const whiteKeyWidth = this.canvas.width / whiteKeys.length;
        const key = this.keys.find(k => `${k.note}${k.octave}` === this.currentActiveNote.keyId);
        
        if (key) {
            let keyWidth;
            if (key.isBlack) {
                keyWidth = whiteKeyWidth * 0.6;
            } else {
                keyWidth = whiteKeyWidth;
            }
            
            // –ù–æ–≤–∞—è X –ø–æ–∑–∏—Ü–∏—è —Å —É—á–µ—Ç–æ–º –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã
            const newX = this.singleBallIndicator.targetCenterX + (deviation / 100) * (keyWidth * 0.4);
            
            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∫ –Ω–æ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ (—Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –Ω–∞ 20%)
            this.singleBallIndicator.currentX += (newX - this.singleBallIndicator.currentX) * 0.2;
        }
    }

    // üéØ –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    drawSingleBallIndicator() {
        if (!this.singleBallIndicator) return;

        let ballX = this.singleBallIndicator.currentX;
        let ballY = this.singleBallIndicator.currentY;

        // üé≠ –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É –Ω–æ—Ç–∞–º–∏
        if (this.ballAnimation.isAnimating) {
            const elapsed = performance.now() - this.ballAnimation.startTime;
            this.ballAnimation.progress = Math.min(1.0, elapsed / this.ballAnimation.duration);
            
            // –ü–ª–∞–≤–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è (easing)
            const easeProgress = this.easeInOutCubic(this.ballAnimation.progress);
            
            ballX = this.ballAnimation.fromX + (this.ballAnimation.toX - this.ballAnimation.fromX) * easeProgress;
            ballY = this.ballAnimation.fromY + (this.ballAnimation.toY - this.ballAnimation.fromY) * easeProgress;
            
            if (this.ballAnimation.progress >= 1.0) {
                this.ballAnimation.isAnimating = false;
                ballX = this.ballAnimation.toX;
                ballY = this.ballAnimation.toY;
            }
        }

        // üé® –†–∏—Å—É–µ–º —à–∫–∞–ª—É —Ç–æ—á–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–ª–∞–≤–∏—à–µ–π
        this.drawPitchScaleForSingleBall();
        
        // üåü –°–≤–µ—á–µ–Ω–∏–µ —à–∞—Ä–∏–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–µ—Ç–∫–æ—Å—Ç–∏ —Å–∏–≥–Ω–∞–ª–∞
        if (this.singleBallIndicator.glowIntensity > 0.5) {
            this.ctx.shadowColor = this.singleBallIndicator.ballColor;
            this.ctx.shadowBlur = this.singleBallIndicator.ballSize * this.singleBallIndicator.glowIntensity * 2.5;
            this.ctx.globalAlpha = 0.9;
        }
        
        // üéØ –û—Å–Ω–æ–≤–Ω–æ–π —à–∞—Ä–∏–∫
        this.ctx.fillStyle = this.singleBallIndicator.ballColor;
        this.ctx.beginPath();
        this.ctx.arc(ballX, ballY, this.singleBallIndicator.ballSize, 0, Math.PI * 2);
        this.ctx.fill();
        
        // üîç –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–ª–∏–∫ –¥–ª—è –æ–±—ä–µ–º–∞
        this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        this.ctx.beginPath();
        const highlightSize = this.singleBallIndicator.ballSize * 0.4;
        this.ctx.arc(ballX - this.singleBallIndicator.ballSize * 0.3, ballY - this.singleBallIndicator.ballSize * 0.3, highlightSize, 0, Math.PI * 2);
        this.ctx.fill();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç—ã
        this.ctx.shadowBlur = 0;
        this.ctx.globalAlpha = 1.0;
        
        // üìè –õ–∏–Ω–∏—è –æ—Ç —à–∞—Ä–∏–∫–∞ –∫ —Ü–µ–Ω—Ç—Ä—É (–µ—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ)
        if (Math.abs(this.singleBallIndicator.deviation) > 10) {
            this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
            this.ctx.lineWidth = 2;
            this.ctx.setLineDash([3, 3]);
            this.ctx.beginPath();
            this.ctx.moveTo(this.singleBallIndicator.targetCenterX, ballY);
            this.ctx.lineTo(ballX, ballY);
            this.ctx.stroke();
            this.ctx.setLineDash([]); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—É–Ω–∫—Ç–∏—Ä
        }

        // üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–Ω–æ—Å—Ç–∏
        this.drawSingleBallInfo(ballX, ballY);
        
        // üé≠ –°–ª–µ–¥ –¥–≤–∏–∂–µ–Ω–∏—è —à–∞—Ä–∏–∫–∞ (–µ—Å–ª–∏ –¥–≤–∏–∂–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ)
        if (this.ballAnimation.isAnimating) {
            this.drawBallTrail(ballX, ballY);
        }
    }

    // üé® –†–∏—Å—É–µ–º —à–∫–∞–ª—É —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —à–∞—Ä–∏–∫–∞
    drawPitchScaleForSingleBall() {
        if (!this.singleBallIndicator || !this.currentActiveNote) return;

        const centerX = this.singleBallIndicator.targetCenterX;
        const scaleY = this.singleBallIndicator.currentY - 15;
        const key = this.keys.find(k => `${k.note}${k.octave}` === this.currentActiveNote.keyId);
        if (!key) return;

        const whiteKeys = this.keys.filter(k => !k.isBlack);
        const whiteKeyWidth = this.canvas.width / whiteKeys.length;
        let keyWidth;
        
        if (key.isBlack) {
            keyWidth = whiteKeyWidth * 0.6;
        } else {
            keyWidth = whiteKeyWidth;
        }

        const scaleWidth = keyWidth * 0.8;
        const scaleX = centerX - scaleWidth / 2;
        
        // –û—Å–Ω–æ–≤–Ω–∞—è –ª–∏–Ω–∏—è —à–∫–∞–ª—ã
        this.ctx.strokeStyle = '#666666';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.moveTo(scaleX, scaleY);
        this.ctx.lineTo(scaleX + scaleWidth, scaleY);
        this.ctx.stroke();
        
        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ (–∏–¥–µ–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞)
        this.ctx.strokeStyle = '#00ff41';
        this.ctx.lineWidth = 4;
        this.ctx.beginPath();
        this.ctx.moveTo(centerX, scaleY - 4);
        this.ctx.lineTo(centerX, scaleY + 4);
        this.ctx.stroke();
        
        // –ë–æ–∫–æ–≤—ã–µ –º–µ—Ç–∫–∏ (¬±50 —Ü–µ–Ω—Ç–æ–≤)
        this.ctx.strokeStyle = '#ffaa00';
        this.ctx.lineWidth = 2;
        const quarter = scaleWidth / 4;
        
        // –õ–µ–≤–∞—è –º–µ—Ç–∫–∞
        this.ctx.beginPath();
        this.ctx.moveTo(centerX - quarter, scaleY - 2);
        this.ctx.lineTo(centerX - quarter, scaleY + 2);
        this.ctx.stroke();
        
        // –ü—Ä–∞–≤–∞—è –º–µ—Ç–∫–∞
        this.ctx.beginPath();
        this.ctx.moveTo(centerX + quarter, scaleY - 2);
        this.ctx.lineTo(centerX + quarter, scaleY + 2);
        this.ctx.stroke();
    }

    // üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º —à–∞—Ä–∏–∫–µ
    drawSingleBallInfo(ballX, ballY) {
        if (!this.singleBallIndicator) return;
        
        // üéØ –¢–æ—á–Ω–æ—Å—Ç—å –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
        this.ctx.fillStyle = this.singleBallIndicator.ballColor;
        this.ctx.font = 'bold 12px Arial';
        this.ctx.textAlign = 'center';
        this.ctx.fillText(`${this.singleBallIndicator.accuracy}%`, ballX, ballY + 25);
        
        // üìè –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –≤ —Ü–µ–Ω—Ç–∞—Ö (–µ—Å–ª–∏ –±–æ–ª—å—à–µ 5)
        if (Math.abs(this.singleBallIndicator.deviation) > 5) {
            const sign = this.singleBallIndicator.deviation > 0 ? '+' : '';
            this.ctx.fillStyle = '#cccccc';
            this.ctx.font = '10px Arial';
            this.ctx.fillText(`${sign}${Math.round(this.singleBallIndicator.deviation)}¬¢`, ballX, ballY + 38);
        }
        
        // üéµ –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ—Ç—ã
        this.ctx.fillStyle = '#ffffff';
        this.ctx.font = 'bold 14px Arial';
        this.ctx.fillText(this.singleBallIndicator.keyId, ballX, ballY - 20);
    }

    // üé≠ –°–ª–µ–¥ –¥–≤–∏–∂–µ–Ω–∏—è —à–∞—Ä–∏–∫–∞
    drawBallTrail(ballX, ballY) {
        const progress = this.ballAnimation.progress;
        const trailLength = 5;
        
        for (let i = 0; i < trailLength; i++) {
            const trailProgress = Math.max(0, progress - (i * 0.1));
            if (trailProgress <= 0) break;
            
            const trailX = this.ballAnimation.fromX + (this.ballAnimation.toX - this.ballAnimation.fromX) * trailProgress;
            const trailY = this.ballAnimation.fromY + (this.ballAnimation.toY - this.ballAnimation.fromY) * trailProgress;
            
            const alpha = (1 - i / trailLength) * 0.3;
            const size = this.singleBallIndicator.ballSize * (1 - i / trailLength);
            
            this.ctx.fillStyle = `rgba(0, 255, 65, ${alpha})`;
            this.ctx.beginPath();
            this.ctx.arc(trailX, trailY, size, 0, Math.PI * 2);
            this.ctx.fill();
        }
    }

    // üé≠ –ü–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
    easeInOutCubic(t) {
        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
window.pianoKeyboard = new PianoKeyboard();
